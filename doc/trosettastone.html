<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.8">
<title>Tomb Raider II Data Formats (TRosettaStone)</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}


#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
<script type="text/javascript">
/*<![CDATA[*/
/*
LaTeXMathML.js
==============

This file, in this form, is due to Douglas Woodall, June 2006.
It contains JavaScript functions to convert (most simple) LaTeX
math notation to Presentation MathML.  It was obtained by
downloading the file ASCIIMathML.js from
	http://www1.chapman.edu/~jipsen/mathml/asciimathdownload/
and modifying it so that it carries out ONLY those conversions
that would be carried out in LaTeX.  A description of the original
file, with examples, can be found at
	www1.chapman.edu/~jipsen/mathml/asciimath.html
	ASCIIMathML: Math on the web for everyone

Here is the header notice from the original file:

ASCIIMathML.js
==============
This file contains JavaScript functions to convert ASCII math notation
to Presentation MathML. The conversion is done while the (X)HTML page
loads, and should work with Firefox/Mozilla/Netscape 7+ and Internet
Explorer 6+MathPlayer (http://www.dessci.com/en/products/mathplayer/).
Just add the next line to your (X)HTML page with this file in the same folder:
This is a convenient and inexpensive solution for authoring MathML.

Version 1.4.7 Dec 15, 2005, (c) Peter Jipsen http://www.chapman.edu/~jipsen
Latest version at http://www.chapman.edu/~jipsen/mathml/ASCIIMathML.js
For changes see http://www.chapman.edu/~jipsen/mathml/asciimathchanges.txt
If you use it on a webpage, please send the URL to jipsen@chapman.edu

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License (at http://www.gnu.org/copyleft/gpl.html)
for more details.

LaTeXMathML.js (ctd)
==============

The instructions for use are the same as for the original
ASCIIMathML.js, except that of course the line you add to your
file should be
Or use absolute path names if the file is not in the same folder
as your (X)HTML page.
*/

var checkForMathML = true;   // check if browser can display MathML
var notifyIfNoMathML = true; // display note if no MathML capability
var alertIfNoMathML = false;  // show alert box if no MathML capability
// was "red":
var mathcolor = "";	     // change it to "" (to inherit) or any other color
// was "serif":
var mathfontfamily = "";      // change to "" to inherit (works in IE)
                              // or another family (e.g. "arial")
var showasciiformulaonhover = true; // helps students learn ASCIIMath
/*
// Commented out by DRW -- not now used -- see DELIMITERS (twice) near the end
var displaystyle = false;     // puts limits above and below large operators
var decimalsign = ".";        // change to "," if you like, beware of `(1,2)`!
var AMdelimiter1 = "`", AMescape1 = "\\\\`"; // can use other characters
var AMdelimiter2 = "$", AMescape2 = "\\\\\\$", AMdelimiter2regexp = "\\$";
var doubleblankmathdelimiter = false; // if true,  x+1  is equal to `x+1`
                                      // for IE this works only in <!--   -->
//var separatetokens;// has been removed (email me if this is a problem)
*/
var isIE = document.createElementNS==null;

if (document.getElementById==null)
  alert("This webpage requires a recent browser such as\
\nMozilla/Netscape 7+ or Internet Explorer 6+MathPlayer")

// all further global variables start with "AM"

function AMcreateElementXHTML(t) {
  if (isIE) return document.createElement(t);
  else return document.createElementNS("http://www.w3.org/1999/xhtml",t);
}

function AMnoMathMLNote() {
  var nd = AMcreateElementXHTML("h3");
  nd.setAttribute("align","center")
  nd.appendChild(AMcreateElementXHTML("p"));
  nd.appendChild(document.createTextNode("To view the "));
  var an = AMcreateElementXHTML("a");
  an.appendChild(document.createTextNode("LaTeXMathML"));
  an.setAttribute("href","http://www.maths.nott.ac.uk/personal/drw/lm.html");
  nd.appendChild(an);
  nd.appendChild(document.createTextNode(" notation use Internet Explorer 6+"));
  an = AMcreateElementXHTML("a");
  an.appendChild(document.createTextNode("MathPlayer"));
  an.setAttribute("href","http://www.dessci.com/en/products/mathplayer/download.htm");
  nd.appendChild(an);
  nd.appendChild(document.createTextNode(" or Netscape/Mozilla/Firefox"));
  nd.appendChild(AMcreateElementXHTML("p"));
  return nd;
}

function AMisMathMLavailable() {
  if (navigator.appName.slice(0,8)=="Netscape")
    if (navigator.appVersion.slice(0,1)>="5") return null;
    else return AMnoMathMLNote();
  else if (navigator.appName.slice(0,9)=="Microsoft")
    try {
        var ActiveX = new ActiveXObject("MathPlayer.Factory.1");
        return null;
    } catch (e) {
        return AMnoMathMLNote();
    }
  else return AMnoMathMLNote();
}

// character lists for Mozilla/Netscape fonts
var AMcal = [0xEF35,0x212C,0xEF36,0xEF37,0x2130,0x2131,0xEF38,0x210B,0x2110,0xEF39,0xEF3A,0x2112,0x2133,0xEF3B,0xEF3C,0xEF3D,0xEF3E,0x211B,0xEF3F,0xEF40,0xEF41,0xEF42,0xEF43,0xEF44,0xEF45,0xEF46];
var AMfrk = [0xEF5D,0xEF5E,0x212D,0xEF5F,0xEF60,0xEF61,0xEF62,0x210C,0x2111,0xEF63,0xEF64,0xEF65,0xEF66,0xEF67,0xEF68,0xEF69,0xEF6A,0x211C,0xEF6B,0xEF6C,0xEF6D,0xEF6E,0xEF6F,0xEF70,0xEF71,0x2128];
var AMbbb = [0xEF8C,0xEF8D,0x2102,0xEF8E,0xEF8F,0xEF90,0xEF91,0x210D,0xEF92,0xEF93,0xEF94,0xEF95,0xEF96,0x2115,0xEF97,0x2119,0x211A,0x211D,0xEF98,0xEF99,0xEF9A,0xEF9B,0xEF9C,0xEF9D,0xEF9E,0x2124];

var CONST = 0, UNARY = 1, BINARY = 2, INFIX = 3, LEFTBRACKET = 4,
    RIGHTBRACKET = 5, SPACE = 6, UNDEROVER = 7, DEFINITION = 8,
    TEXT = 9, BIG = 10, LONG = 11, STRETCHY = 12, MATRIX = 13; // token types

var AMsqrt = {input:"\\sqrt",	tag:"msqrt", output:"sqrt",	ttype:UNARY},
  AMroot = {input:"\\root",	tag:"mroot", output:"root",	ttype:BINARY},
  AMfrac = {input:"\\frac",	tag:"mfrac", output:"/",	ttype:BINARY},
  AMover = {input:"\\stackrel", tag:"mover", output:"stackrel", ttype:BINARY},
  AMatop = {input:"\\atop",	tag:"mfrac", output:"",		ttype:INFIX},
  AMchoose = {input:"\\choose", tag:"mfrac", output:"",		ttype:INFIX},
  AMsub  = {input:"_",		tag:"msub",  output:"_",	ttype:INFIX},
  AMsup  = {input:"^",		tag:"msup",  output:"^",	ttype:INFIX},
  AMtext = {input:"\\mathrm",	tag:"mtext", output:"text",	ttype:TEXT},
  AMmbox = {input:"\\mbox",	tag:"mtext", output:"mbox",	ttype:TEXT};

// Commented out by DRW to prevent 1/2 turning into a 2-line fraction
// AMdiv   = {input:"/",	 tag:"mfrac", output:"/",    ttype:INFIX},
// Commented out by DRW so that " prints literally in equations
// AMquote = {input:"\"",	 tag:"mtext", output:"mbox", ttype:TEXT};

var AMsymbols = [
//Greek letters
{input:"\\alpha",	tag:"mi", output:"\u03B1", ttype:CONST},
{input:"\\beta",	tag:"mi", output:"\u03B2", ttype:CONST},
{input:"\\gamma",	tag:"mi", output:"\u03B3", ttype:CONST},
{input:"\\delta",	tag:"mi", output:"\u03B4", ttype:CONST},
{input:"\\epsilon",	tag:"mi", output:"\u03B5", ttype:CONST},
{input:"\\varepsilon",  tag:"mi", output:"\u025B", ttype:CONST},
{input:"\\zeta",	tag:"mi", output:"\u03B6", ttype:CONST},
{input:"\\eta",		tag:"mi", output:"\u03B7", ttype:CONST},
{input:"\\theta",	tag:"mi", output:"\u03B8", ttype:CONST},
{input:"\\vartheta",	tag:"mi", output:"\u03D1", ttype:CONST},
{input:"\\iota",	tag:"mi", output:"\u03B9", ttype:CONST},
{input:"\\kappa",	tag:"mi", output:"\u03BA", ttype:CONST},
{input:"\\lambda",	tag:"mi", output:"\u03BB", ttype:CONST},
{input:"\\mu",		tag:"mi", output:"\u03BC", ttype:CONST},
{input:"\\nu",		tag:"mi", output:"\u03BD", ttype:CONST},
{input:"\\xi",		tag:"mi", output:"\u03BE", ttype:CONST},
{input:"\\pi",		tag:"mi", output:"\u03C0", ttype:CONST},
{input:"\\varpi",	tag:"mi", output:"\u03D6", ttype:CONST},
{input:"\\rho",		tag:"mi", output:"\u03C1", ttype:CONST},
{input:"\\varrho",	tag:"mi", output:"\u03F1", ttype:CONST},
{input:"\\varsigma",	tag:"mi", output:"\u03C2", ttype:CONST},
{input:"\\sigma",	tag:"mi", output:"\u03C3", ttype:CONST},
{input:"\\tau",		tag:"mi", output:"\u03C4", ttype:CONST},
{input:"\\upsilon",	tag:"mi", output:"\u03C5", ttype:CONST},
{input:"\\phi",		tag:"mi", output:"\u03C6", ttype:CONST},
{input:"\\varphi",	tag:"mi", output:"\u03D5", ttype:CONST},
{input:"\\chi",		tag:"mi", output:"\u03C7", ttype:CONST},
{input:"\\psi",		tag:"mi", output:"\u03C8", ttype:CONST},
{input:"\\omega",	tag:"mi", output:"\u03C9", ttype:CONST},
{input:"\\Gamma",	tag:"mo", output:"\u0393", ttype:CONST},
{input:"\\Delta",	tag:"mo", output:"\u0394", ttype:CONST},
{input:"\\Theta",	tag:"mo", output:"\u0398", ttype:CONST},
{input:"\\Lambda",	tag:"mo", output:"\u039B", ttype:CONST},
{input:"\\Xi",		tag:"mo", output:"\u039E", ttype:CONST},
{input:"\\Pi",		tag:"mo", output:"\u03A0", ttype:CONST},
{input:"\\Sigma",	tag:"mo", output:"\u03A3", ttype:CONST},
{input:"\\Upsilon",	tag:"mo", output:"\u03A5", ttype:CONST},
{input:"\\Phi",		tag:"mo", output:"\u03A6", ttype:CONST},
{input:"\\Psi",		tag:"mo", output:"\u03A8", ttype:CONST},
{input:"\\Omega",	tag:"mo", output:"\u03A9", ttype:CONST},

//fractions
{input:"\\frac12",	tag:"mo", output:"\u00BD", ttype:CONST},
{input:"\\frac14",	tag:"mo", output:"\u00BC", ttype:CONST},
{input:"\\frac34",	tag:"mo", output:"\u00BE", ttype:CONST},
{input:"\\frac13",	tag:"mo", output:"\u2153", ttype:CONST},
{input:"\\frac23",	tag:"mo", output:"\u2154", ttype:CONST},
{input:"\\frac15",	tag:"mo", output:"\u2155", ttype:CONST},
{input:"\\frac25",	tag:"mo", output:"\u2156", ttype:CONST},
{input:"\\frac35",	tag:"mo", output:"\u2157", ttype:CONST},
{input:"\\frac45",	tag:"mo", output:"\u2158", ttype:CONST},
{input:"\\frac16",	tag:"mo", output:"\u2159", ttype:CONST},
{input:"\\frac56",	tag:"mo", output:"\u215A", ttype:CONST},
{input:"\\frac18",	tag:"mo", output:"\u215B", ttype:CONST},
{input:"\\frac38",	tag:"mo", output:"\u215C", ttype:CONST},
{input:"\\frac58",	tag:"mo", output:"\u215D", ttype:CONST},
{input:"\\frac78",	tag:"mo", output:"\u215E", ttype:CONST},

//binary operation symbols
{input:"\\pm",		tag:"mo", output:"\u00B1", ttype:CONST},
{input:"\\mp",		tag:"mo", output:"\u2213", ttype:CONST},
{input:"\\triangleleft",tag:"mo", output:"\u22B2", ttype:CONST},
{input:"\\triangleright",tag:"mo",output:"\u22B3", ttype:CONST},
{input:"\\cdot",	tag:"mo", output:"\u22C5", ttype:CONST},
{input:"\\star",	tag:"mo", output:"\u22C6", ttype:CONST},
{input:"\\ast",		tag:"mo", output:"\u002A", ttype:CONST},
{input:"\\times",	tag:"mo", output:"\u00D7", ttype:CONST},
{input:"\\div",		tag:"mo", output:"\u00F7", ttype:CONST},
{input:"\\circ",	tag:"mo", output:"\u2218", ttype:CONST},
//{input:"\\bullet",	  tag:"mo", output:"\u2219", ttype:CONST},
{input:"\\bullet",	tag:"mo", output:"\u2022", ttype:CONST},
{input:"\\oplus",	tag:"mo", output:"\u2295", ttype:CONST},
{input:"\\ominus",	tag:"mo", output:"\u2296", ttype:CONST},
{input:"\\otimes",	tag:"mo", output:"\u2297", ttype:CONST},
{input:"\\bigcirc",	tag:"mo", output:"\u25CB", ttype:CONST},
{input:"\\oslash",	tag:"mo", output:"\u2298", ttype:CONST},
{input:"\\odot",	tag:"mo", output:"\u2299", ttype:CONST},
{input:"\\land",	tag:"mo", output:"\u2227", ttype:CONST},
{input:"\\wedge",	tag:"mo", output:"\u2227", ttype:CONST},
{input:"\\lor",		tag:"mo", output:"\u2228", ttype:CONST},
{input:"\\vee",		tag:"mo", output:"\u2228", ttype:CONST},
{input:"\\cap",		tag:"mo", output:"\u2229", ttype:CONST},
{input:"\\cup",		tag:"mo", output:"\u222A", ttype:CONST},
{input:"\\sqcap",	tag:"mo", output:"\u2293", ttype:CONST},
{input:"\\sqcup",	tag:"mo", output:"\u2294", ttype:CONST},
{input:"\\uplus",	tag:"mo", output:"\u228E", ttype:CONST},
{input:"\\amalg",	tag:"mo", output:"\u2210", ttype:CONST},
{input:"\\bigtriangleup",tag:"mo",output:"\u25B3", ttype:CONST},
{input:"\\bigtriangledown",tag:"mo",output:"\u25BD", ttype:CONST},
{input:"\\dag",		tag:"mo", output:"\u2020", ttype:CONST},
{input:"\\dagger",	tag:"mo", output:"\u2020", ttype:CONST},
{input:"\\ddag",	tag:"mo", output:"\u2021", ttype:CONST},
{input:"\\ddagger",	tag:"mo", output:"\u2021", ttype:CONST},
{input:"\\lhd",		tag:"mo", output:"\u22B2", ttype:CONST},
{input:"\\rhd",		tag:"mo", output:"\u22B3", ttype:CONST},
{input:"\\unlhd",	tag:"mo", output:"\u22B4", ttype:CONST},
{input:"\\unrhd",	tag:"mo", output:"\u22B5", ttype:CONST},


//BIG Operators
{input:"\\sum",		tag:"mo", output:"\u2211", ttype:UNDEROVER},
{input:"\\prod",	tag:"mo", output:"\u220F", ttype:UNDEROVER},
{input:"\\bigcap",	tag:"mo", output:"\u22C2", ttype:UNDEROVER},
{input:"\\bigcup",	tag:"mo", output:"\u22C3", ttype:UNDEROVER},
{input:"\\bigwedge",	tag:"mo", output:"\u22C0", ttype:UNDEROVER},
{input:"\\bigvee",	tag:"mo", output:"\u22C1", ttype:UNDEROVER},
{input:"\\bigsqcap",	tag:"mo", output:"\u2A05", ttype:UNDEROVER},
{input:"\\bigsqcup",	tag:"mo", output:"\u2A06", ttype:UNDEROVER},
{input:"\\coprod",	tag:"mo", output:"\u2210", ttype:UNDEROVER},
{input:"\\bigoplus",	tag:"mo", output:"\u2A01", ttype:UNDEROVER},
{input:"\\bigotimes",	tag:"mo", output:"\u2A02", ttype:UNDEROVER},
{input:"\\bigodot",	tag:"mo", output:"\u2A00", ttype:UNDEROVER},
{input:"\\biguplus",	tag:"mo", output:"\u2A04", ttype:UNDEROVER},
{input:"\\int",		tag:"mo", output:"\u222B", ttype:CONST},
{input:"\\oint",	tag:"mo", output:"\u222E", ttype:CONST},

//binary relation symbols
{input:":=",		tag:"mo", output:":=",	   ttype:CONST},
{input:"\\lt",		tag:"mo", output:"<",	   ttype:CONST},
{input:"\\gt",		tag:"mo", output:">",	   ttype:CONST},
{input:"\\ne",		tag:"mo", output:"\u2260", ttype:CONST},
{input:"\\neq",		tag:"mo", output:"\u2260", ttype:CONST},
{input:"\\le",		tag:"mo", output:"\u2264", ttype:CONST},
{input:"\\leq",		tag:"mo", output:"\u2264", ttype:CONST},
{input:"\\leqslant",	tag:"mo", output:"\u2264", ttype:CONST},
{input:"\\ge",		tag:"mo", output:"\u2265", ttype:CONST},
{input:"\\geq",		tag:"mo", output:"\u2265", ttype:CONST},
{input:"\\geqslant",	tag:"mo", output:"\u2265", ttype:CONST},
{input:"\\equiv",	tag:"mo", output:"\u2261", ttype:CONST},
{input:"\\ll",		tag:"mo", output:"\u226A", ttype:CONST},
{input:"\\gg",		tag:"mo", output:"\u226B", ttype:CONST},
{input:"\\doteq",	tag:"mo", output:"\u2250", ttype:CONST},
{input:"\\prec",	tag:"mo", output:"\u227A", ttype:CONST},
{input:"\\succ",	tag:"mo", output:"\u227B", ttype:CONST},
{input:"\\preceq",	tag:"mo", output:"\u227C", ttype:CONST},
{input:"\\succeq",	tag:"mo", output:"\u227D", ttype:CONST},
{input:"\\subset",	tag:"mo", output:"\u2282", ttype:CONST},
{input:"\\supset",	tag:"mo", output:"\u2283", ttype:CONST},
{input:"\\subseteq",	tag:"mo", output:"\u2286", ttype:CONST},
{input:"\\supseteq",	tag:"mo", output:"\u2287", ttype:CONST},
{input:"\\sqsubset",	tag:"mo", output:"\u228F", ttype:CONST},
{input:"\\sqsupset",	tag:"mo", output:"\u2290", ttype:CONST},
{input:"\\sqsubseteq",  tag:"mo", output:"\u2291", ttype:CONST},
{input:"\\sqsupseteq",  tag:"mo", output:"\u2292", ttype:CONST},
{input:"\\sim",		tag:"mo", output:"\u223C", ttype:CONST},
{input:"\\simeq",	tag:"mo", output:"\u2243", ttype:CONST},
{input:"\\approx",	tag:"mo", output:"\u2248", ttype:CONST},
{input:"\\cong",	tag:"mo", output:"\u2245", ttype:CONST},
{input:"\\Join",	tag:"mo", output:"\u22C8", ttype:CONST},
{input:"\\bowtie",	tag:"mo", output:"\u22C8", ttype:CONST},
{input:"\\in",		tag:"mo", output:"\u2208", ttype:CONST},
{input:"\\ni",		tag:"mo", output:"\u220B", ttype:CONST},
{input:"\\owns",	tag:"mo", output:"\u220B", ttype:CONST},
{input:"\\propto",	tag:"mo", output:"\u221D", ttype:CONST},
{input:"\\vdash",	tag:"mo", output:"\u22A2", ttype:CONST},
{input:"\\dashv",	tag:"mo", output:"\u22A3", ttype:CONST},
{input:"\\models",	tag:"mo", output:"\u22A8", ttype:CONST},
{input:"\\perp",	tag:"mo", output:"\u22A5", ttype:CONST},
{input:"\\smile",	tag:"mo", output:"\u2323", ttype:CONST},
{input:"\\frown",	tag:"mo", output:"\u2322", ttype:CONST},
{input:"\\asymp",	tag:"mo", output:"\u224D", ttype:CONST},
{input:"\\notin",	tag:"mo", output:"\u2209", ttype:CONST},

//matrices
{input:"\\begin{eqnarray}",	output:"X",	ttype:MATRIX, invisible:true},
{input:"\\begin{array}",	output:"X",	ttype:MATRIX, invisible:true},
{input:"\\\\",			output:"}&{",	ttype:DEFINITION},
{input:"\\end{eqnarray}",	output:"}}",	ttype:DEFINITION},
{input:"\\end{array}",		output:"}}",	ttype:DEFINITION},

//grouping and literal brackets -- ieval is for IE
{input:"\\big",	   tag:"mo", output:"X", atval:"1.2", ieval:"2.2", ttype:BIG},
{input:"\\Big",	   tag:"mo", output:"X", atval:"1.6", ieval:"2.6", ttype:BIG},
{input:"\\bigg",   tag:"mo", output:"X", atval:"2.2", ieval:"3.2", ttype:BIG},
{input:"\\Bigg",   tag:"mo", output:"X", atval:"2.9", ieval:"3.9", ttype:BIG},
{input:"\\left",   tag:"mo", output:"X", ttype:LEFTBRACKET},
{input:"\\right",  tag:"mo", output:"X", ttype:RIGHTBRACKET},
{input:"{",	   output:"{", ttype:LEFTBRACKET,  invisible:true},
{input:"}",	   output:"}", ttype:RIGHTBRACKET, invisible:true},

{input:"(",	   tag:"mo", output:"(",      atval:"1", ttype:STRETCHY},
{input:"[",	   tag:"mo", output:"[",      atval:"1", ttype:STRETCHY},
{input:"\\lbrack", tag:"mo", output:"[",      atval:"1", ttype:STRETCHY},
{input:"\\{",	   tag:"mo", output:"{",      atval:"1", ttype:STRETCHY},
{input:"\\lbrace", tag:"mo", output:"{",      atval:"1", ttype:STRETCHY},
{input:"\\langle", tag:"mo", output:"\u2329", atval:"1", ttype:STRETCHY},
{input:"\\lfloor", tag:"mo", output:"\u230A", atval:"1", ttype:STRETCHY},
{input:"\\lceil",  tag:"mo", output:"\u2308", atval:"1", ttype:STRETCHY},

// rtag:"mi" causes space to be inserted before a following sin, cos, etc.
// (see function AMparseExpr() )
{input:")",	  tag:"mo",output:")",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"]",	  tag:"mo",output:"]",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rbrack",tag:"mo",output:"]",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\}",	  tag:"mo",output:"}",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rbrace",tag:"mo",output:"}",	    rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rangle",tag:"mo",output:"\u232A", rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rfloor",tag:"mo",output:"\u230B", rtag:"mi",atval:"1",ttype:STRETCHY},
{input:"\\rceil", tag:"mo",output:"\u2309", rtag:"mi",atval:"1",ttype:STRETCHY},

// "|", "\\|", "\\vert" and "\\Vert" modified later: lspace = rspace = 0em
{input:"|",		tag:"mo", output:"\u2223", atval:"1", ttype:STRETCHY},
{input:"\\|",		tag:"mo", output:"\u2225", atval:"1", ttype:STRETCHY},
{input:"\\vert",	tag:"mo", output:"\u2223", atval:"1", ttype:STRETCHY},
{input:"\\Vert",	tag:"mo", output:"\u2225", atval:"1", ttype:STRETCHY},
{input:"\\mid",		tag:"mo", output:"\u2223", atval:"1", ttype:STRETCHY},
{input:"\\parallel",	tag:"mo", output:"\u2225", atval:"1", ttype:STRETCHY},
{input:"/",		tag:"mo", output:"/",	atval:"1.01", ttype:STRETCHY},
{input:"\\backslash",	tag:"mo", output:"\u2216", atval:"1", ttype:STRETCHY},
{input:"\\setminus",	tag:"mo", output:"\\",	   ttype:CONST},

//miscellaneous symbols
{input:"\\!",	  tag:"mspace", atname:"width", atval:"-0.167em", ttype:SPACE},
{input:"\\,",	  tag:"mspace", atname:"width", atval:"0.167em", ttype:SPACE},
{input:"\\>",	  tag:"mspace", atname:"width", atval:"0.222em", ttype:SPACE},
{input:"\\:",	  tag:"mspace", atname:"width", atval:"0.222em", ttype:SPACE},
{input:"\\;",	  tag:"mspace", atname:"width", atval:"0.278em", ttype:SPACE},
{input:"~",	  tag:"mspace", atname:"width", atval:"0.333em", ttype:SPACE},
{input:"\\quad",  tag:"mspace", atname:"width", atval:"1em", ttype:SPACE},
{input:"\\qquad", tag:"mspace", atname:"width", atval:"2em", ttype:SPACE},
//{input:"{}",		  tag:"mo", output:"\u200B", ttype:CONST}, // zero-width
{input:"\\prime",	tag:"mo", output:"\u2032", ttype:CONST},
{input:"'",		tag:"mo", output:"\u02B9", ttype:CONST},
{input:"''",		tag:"mo", output:"\u02BA", ttype:CONST},
{input:"'''",		tag:"mo", output:"\u2034", ttype:CONST},
{input:"''''",		tag:"mo", output:"\u2057", ttype:CONST},
{input:"\\ldots",	tag:"mo", output:"\u2026", ttype:CONST},
{input:"\\cdots",	tag:"mo", output:"\u22EF", ttype:CONST},
{input:"\\vdots",	tag:"mo", output:"\u22EE", ttype:CONST},
{input:"\\ddots",	tag:"mo", output:"\u22F1", ttype:CONST},
{input:"\\forall",	tag:"mo", output:"\u2200", ttype:CONST},
{input:"\\exists",	tag:"mo", output:"\u2203", ttype:CONST},
{input:"\\Re",		tag:"mo", output:"\u211C", ttype:CONST},
{input:"\\Im",		tag:"mo", output:"\u2111", ttype:CONST},
{input:"\\aleph",	tag:"mo", output:"\u2135", ttype:CONST},
{input:"\\hbar",	tag:"mo", output:"\u210F", ttype:CONST},
{input:"\\ell",		tag:"mo", output:"\u2113", ttype:CONST},
{input:"\\wp",		tag:"mo", output:"\u2118", ttype:CONST},
{input:"\\emptyset",	tag:"mo", output:"\u2205", ttype:CONST},
{input:"\\infty",	tag:"mo", output:"\u221E", ttype:CONST},
{input:"\\surd",	tag:"mo", output:"\\sqrt{}", ttype:DEFINITION},
{input:"\\partial",	tag:"mo", output:"\u2202", ttype:CONST},
{input:"\\nabla",	tag:"mo", output:"\u2207", ttype:CONST},
{input:"\\triangle",	tag:"mo", output:"\u25B3", ttype:CONST},
{input:"\\therefore",	tag:"mo", output:"\u2234", ttype:CONST},
{input:"\\angle",	tag:"mo", output:"\u2220", ttype:CONST},
//{input:"\\\\ ",	  tag:"mo", output:"\u00A0", ttype:CONST},
{input:"\\diamond",	tag:"mo", output:"\u22C4", ttype:CONST},
//{input:"\\Diamond",	  tag:"mo", output:"\u25CA", ttype:CONST},
{input:"\\Diamond",	tag:"mo", output:"\u25C7", ttype:CONST},
{input:"\\neg",		tag:"mo", output:"\u00AC", ttype:CONST},
{input:"\\lnot",	tag:"mo", output:"\u00AC", ttype:CONST},
{input:"\\bot",		tag:"mo", output:"\u22A5", ttype:CONST},
{input:"\\top",		tag:"mo", output:"\u22A4", ttype:CONST},
{input:"\\square",	tag:"mo", output:"\u25AB", ttype:CONST},
{input:"\\Box",		tag:"mo", output:"\u25A1", ttype:CONST},
{input:"\\wr",		tag:"mo", output:"\u2240", ttype:CONST},

//standard functions
//Note UNDEROVER *must* have tag:"mo" to work properly
{input:"\\arccos", tag:"mi", output:"arccos", ttype:UNARY, func:true},
{input:"\\arcsin", tag:"mi", output:"arcsin", ttype:UNARY, func:true},
{input:"\\arctan", tag:"mi", output:"arctan", ttype:UNARY, func:true},
{input:"\\arg",	   tag:"mi", output:"arg",    ttype:UNARY, func:true},
{input:"\\cos",	   tag:"mi", output:"cos",    ttype:UNARY, func:true},
{input:"\\cosh",   tag:"mi", output:"cosh",   ttype:UNARY, func:true},
{input:"\\cot",	   tag:"mi", output:"cot",    ttype:UNARY, func:true},
{input:"\\coth",   tag:"mi", output:"coth",   ttype:UNARY, func:true},
{input:"\\csc",	   tag:"mi", output:"csc",    ttype:UNARY, func:true},
{input:"\\deg",	   tag:"mi", output:"deg",    ttype:UNARY, func:true},
{input:"\\det",	   tag:"mi", output:"det",    ttype:UNARY, func:true},
{input:"\\dim",	   tag:"mi", output:"dim",    ttype:UNARY, func:true}, //CONST?
{input:"\\exp",	   tag:"mi", output:"exp",    ttype:UNARY, func:true},
{input:"\\gcd",	   tag:"mi", output:"gcd",    ttype:UNARY, func:true}, //CONST?
{input:"\\hom",	   tag:"mi", output:"hom",    ttype:UNARY, func:true},
{input:"\\inf",	      tag:"mo", output:"inf",	 ttype:UNDEROVER},
{input:"\\ker",	   tag:"mi", output:"ker",    ttype:UNARY, func:true},
{input:"\\lg",	   tag:"mi", output:"lg",     ttype:UNARY, func:true},
{input:"\\lim",	      tag:"mo", output:"lim",	 ttype:UNDEROVER},
{input:"\\liminf",    tag:"mo", output:"liminf", ttype:UNDEROVER},
{input:"\\limsup",    tag:"mo", output:"limsup", ttype:UNDEROVER},
{input:"\\ln",	   tag:"mi", output:"ln",     ttype:UNARY, func:true},
{input:"\\log",	   tag:"mi", output:"log",    ttype:UNARY, func:true},
{input:"\\max",	      tag:"mo", output:"max",	 ttype:UNDEROVER},
{input:"\\min",	      tag:"mo", output:"min",	 ttype:UNDEROVER},
{input:"\\Pr",	   tag:"mi", output:"Pr",     ttype:UNARY, func:true},
{input:"\\sec",	   tag:"mi", output:"sec",    ttype:UNARY, func:true},
{input:"\\sin",	   tag:"mi", output:"sin",    ttype:UNARY, func:true},
{input:"\\sinh",   tag:"mi", output:"sinh",   ttype:UNARY, func:true},
{input:"\\sup",	      tag:"mo", output:"sup",	 ttype:UNDEROVER},
{input:"\\tan",	   tag:"mi", output:"tan",    ttype:UNARY, func:true},
{input:"\\tanh",   tag:"mi", output:"tanh",   ttype:UNARY, func:true},

//arrows
{input:"\\gets",		tag:"mo", output:"\u2190", ttype:CONST},
{input:"\\leftarrow",		tag:"mo", output:"\u2190", ttype:CONST},
{input:"\\to",			tag:"mo", output:"\u2192", ttype:CONST},
{input:"\\rightarrow",		tag:"mo", output:"\u2192", ttype:CONST},
{input:"\\leftrightarrow",	tag:"mo", output:"\u2194", ttype:CONST},
{input:"\\uparrow",		tag:"mo", output:"\u2191", ttype:CONST},
{input:"\\downarrow",		tag:"mo", output:"\u2193", ttype:CONST},
{input:"\\updownarrow",		tag:"mo", output:"\u2195", ttype:CONST},
{input:"\\Leftarrow",		tag:"mo", output:"\u21D0", ttype:CONST},
{input:"\\Rightarrow",		tag:"mo", output:"\u21D2", ttype:CONST},
{input:"\\Leftrightarrow",	tag:"mo", output:"\u21D4", ttype:CONST},
{input:"\\iff", tag:"mo", output:"~\\Longleftrightarrow~", ttype:DEFINITION},
{input:"\\Uparrow",		tag:"mo", output:"\u21D1", ttype:CONST},
{input:"\\Downarrow",		tag:"mo", output:"\u21D3", ttype:CONST},
{input:"\\Updownarrow",		tag:"mo", output:"\u21D5", ttype:CONST},
{input:"\\mapsto",		tag:"mo", output:"\u21A6", ttype:CONST},
{input:"\\longleftarrow",	tag:"mo", output:"\u2190", ttype:LONG},
{input:"\\longrightarrow",	tag:"mo", output:"\u2192", ttype:LONG},
{input:"\\longleftrightarrow",	tag:"mo", output:"\u2194", ttype:LONG},
{input:"\\Longleftarrow",	tag:"mo", output:"\u21D0", ttype:LONG},
{input:"\\Longrightarrow",	tag:"mo", output:"\u21D2", ttype:LONG},
{input:"\\Longleftrightarrow",  tag:"mo", output:"\u21D4", ttype:LONG},
{input:"\\longmapsto",		tag:"mo", output:"\u21A6", ttype:CONST},
							// disaster if LONG

//commands with argument
AMsqrt, AMroot, AMfrac, AMover, AMsub, AMsup, AMtext, AMmbox, AMatop, AMchoose,
//AMdiv, AMquote,

//diacritical marks
{input:"\\acute",	tag:"mover",  output:"\u00B4", ttype:UNARY, acc:true},
//{input:"\\acute",	  tag:"mover",  output:"\u0317", ttype:UNARY, acc:true},
//{input:"\\acute",	  tag:"mover",  output:"\u0301", ttype:UNARY, acc:true},
//{input:"\\grave",	  tag:"mover",  output:"\u0300", ttype:UNARY, acc:true},
//{input:"\\grave",	  tag:"mover",  output:"\u0316", ttype:UNARY, acc:true},
{input:"\\grave",	tag:"mover",  output:"\u0060", ttype:UNARY, acc:true},
{input:"\\breve",	tag:"mover",  output:"\u02D8", ttype:UNARY, acc:true},
{input:"\\check",	tag:"mover",  output:"\u02C7", ttype:UNARY, acc:true},
{input:"\\dot",		tag:"mover",  output:".",      ttype:UNARY, acc:true},
{input:"\\ddot",	tag:"mover",  output:"..",     ttype:UNARY, acc:true},
//{input:"\\ddot",	  tag:"mover",  output:"\u00A8", ttype:UNARY, acc:true},
{input:"\\mathring",	tag:"mover",  output:"\u00B0", ttype:UNARY, acc:true},
{input:"\\vec",		tag:"mover",  output:"\u20D7", ttype:UNARY, acc:true},
{input:"\\overrightarrow",tag:"mover",output:"\u20D7", ttype:UNARY, acc:true},
{input:"\\overleftarrow",tag:"mover", output:"\u20D6", ttype:UNARY, acc:true},
{input:"\\hat",		tag:"mover",  output:"\u005E", ttype:UNARY, acc:true},
{input:"\\widehat",	tag:"mover",  output:"\u0302", ttype:UNARY, acc:true},
{input:"\\tilde",	tag:"mover",  output:"~",      ttype:UNARY, acc:true},
//{input:"\\tilde",	  tag:"mover",  output:"\u0303", ttype:UNARY, acc:true},
{input:"\\widetilde",	tag:"mover",  output:"\u02DC", ttype:UNARY, acc:true},
{input:"\\bar",		tag:"mover",  output:"\u203E", ttype:UNARY, acc:true},
{input:"\\overbrace",	tag:"mover",  output:"\u23B4", ttype:UNARY, acc:true},
{input:"\\overline",	tag:"mover",  output:"\u00AF", ttype:UNARY, acc:true},
{input:"\\underbrace",  tag:"munder", output:"\u23B5", ttype:UNARY, acc:true},
{input:"\\underline",	tag:"munder", output:"\u00AF", ttype:UNARY, acc:true},
//{input:"underline",	tag:"munder", output:"\u0332", ttype:UNARY, acc:true},

//typestyles and fonts
{input:"\\displaystyle",tag:"mstyle",atname:"displaystyle",atval:"true", ttype:UNARY},
{input:"\\textstyle",tag:"mstyle",atname:"displaystyle",atval:"false", ttype:UNARY},
{input:"\\scriptstyle",tag:"mstyle",atname:"scriptlevel",atval:"1", ttype:UNARY},
{input:"\\scriptscriptstyle",tag:"mstyle",atname:"scriptlevel",atval:"2", ttype:UNARY},
{input:"\\textrm", tag:"mstyle", output:"\\mathrm", ttype: DEFINITION},
{input:"\\mathbf", tag:"mstyle", atname:"mathvariant", atval:"bold", ttype:UNARY},
{input:"\\textbf", tag:"mstyle", atname:"mathvariant", atval:"bold", ttype:UNARY},
{input:"\\mathit", tag:"mstyle", atname:"mathvariant", atval:"italic", ttype:UNARY},
{input:"\\textit", tag:"mstyle", atname:"mathvariant", atval:"italic", ttype:UNARY},
{input:"\\mathtt", tag:"mstyle", atname:"mathvariant", atval:"monospace", ttype:UNARY},
{input:"\\texttt", tag:"mstyle", atname:"mathvariant", atval:"monospace", ttype:UNARY},
{input:"\\mathsf", tag:"mstyle", atname:"mathvariant", atval:"sans-serif", ttype:UNARY},
{input:"\\mathbb", tag:"mstyle", atname:"mathvariant", atval:"double-struck", ttype:UNARY, codes:AMbbb},
{input:"\\mathcal",tag:"mstyle", atname:"mathvariant", atval:"script", ttype:UNARY, codes:AMcal},
{input:"\\mathfrak",tag:"mstyle",atname:"mathvariant", atval:"fraktur",ttype:UNARY, codes:AMfrk}
];

function compareNames(s1,s2) {
  if (s1.input > s2.input) return 1
  else return -1;
}

var AMnames = []; //list of input symbols

function AMinitSymbols() {
  AMsymbols.sort(compareNames);
  for (i=0; i<AMsymbols.length; i++) AMnames[i] = AMsymbols[i].input;
}

var AMmathml = "http://www.w3.org/1998/Math/MathML";

function AMcreateElementMathML(t) {
  if (isIE) return document.createElement("m:"+t);
  else return document.createElementNS(AMmathml,t);
}

function AMcreateMmlNode(t,frag) {
//  var node = AMcreateElementMathML(name);
  if (isIE) var node = document.createElement("m:"+t);
  else var node = document.createElementNS(AMmathml,t);
  node.appendChild(frag);
  return node;
}

function newcommand(oldstr,newstr) {
  AMsymbols = AMsymbols.concat([{input:oldstr, tag:"mo", output:newstr,
                                 ttype:DEFINITION}]);
}

function AMremoveCharsAndBlanks(str,n) {
//remove n characters and any following blanks
  var st;
  st = str.slice(n);
  for (var i=0; i<st.length && st.charCodeAt(i)<=32; i=i+1);
  return st.slice(i);
}

function AMposition(arr, str, n) {
// return position >=n where str appears or would be inserted
// assumes arr is sorted
  if (n==0) {
    var h,m;
    n = -1;
    h = arr.length;
    while (n+1<h) {
      m = (n+h) >> 1;
      if (arr[m]<str) n = m; else h = m;
    }
    return h;
  } else
    for (var i=n; i<arr.length && arr[i]<str; i++);
  return i; // i=arr.length || arr[i]>=str
}

function AMgetSymbol(str) {
//return maximal initial substring of str that appears in names
//return null if there is none
  var k = 0; //new pos
  var j = 0; //old pos
  var mk; //match pos
  var st;
  var tagst;
  var match = "";
  var more = true;
  for (var i=1; i<=str.length && more; i++) {
    st = str.slice(0,i); //initial substring of length i
    j = k;
    k = AMposition(AMnames, st, j);
    if (k<AMnames.length && str.slice(0,AMnames[k].length)==AMnames[k]){
      match = AMnames[k];
      mk = k;
      i = match.length;
    }
    more = k<AMnames.length && str.slice(0,AMnames[k].length)>=AMnames[k];
  }
  AMpreviousSymbol=AMcurrentSymbol;
  if (match!=""){
    AMcurrentSymbol=AMsymbols[mk].ttype;
    return AMsymbols[mk];
  }
  AMcurrentSymbol=CONST;
  k = 1;
  st = str.slice(0,1); //take 1 character
  if ("0"<=st && st<="9") tagst = "mn";
  else tagst = (("A">st || st>"Z") && ("a">st || st>"z")?"mo":"mi");
/*
// Commented out by DRW (not fully understood, but probably to do with
// use of "/" as an INFIX version of "\\frac", which we don't want):
//}
//if (st=="-" && AMpreviousSymbol==INFIX) {
//  AMcurrentSymbol = INFIX;  //trick "/" into recognizing "-" on second parse
//  return {input:st, tag:tagst, output:st, ttype:UNARY, func:true};
//}
*/
  return {input:st, tag:tagst, output:st, ttype:CONST};
}


/*Parsing ASCII math expressions with the following grammar
v ::= [A-Za-z] | greek letters | numbers | other constant symbols
u ::= sqrt | text | bb | other unary symbols for font commands
b ::= frac | root | stackrel	binary symbols
l ::= { | \left			left brackets
r ::= } | \right		right brackets
S ::= v | lEr | uS | bSS	Simple expression
I ::= S_S | S^S | S_S^S | S	Intermediate expression
E ::= IE | I/I			Expression
Each terminal symbol is translated into a corresponding mathml node.*/

var AMpreviousSymbol,AMcurrentSymbol;

function AMparseSexpr(str) { //parses str and returns [node,tailstr,(node)tag]
  var symbol, node, result, result2, i, st,// rightvert = false,
    newFrag = document.createDocumentFragment();
  str = AMremoveCharsAndBlanks(str,0);
  symbol = AMgetSymbol(str);             //either a token or a bracket or empty
  if (symbol == null || symbol.ttype == RIGHTBRACKET)
    return [null,str,null];
  if (symbol.ttype == DEFINITION) {
    str = symbol.output+AMremoveCharsAndBlanks(str,symbol.input.length);
    symbol = AMgetSymbol(str);
    if (symbol == null || symbol.ttype == RIGHTBRACKET)
      return [null,str,null];
  }
  str = AMremoveCharsAndBlanks(str,symbol.input.length);
  switch (symbol.ttype) {
  case SPACE:
    node = AMcreateElementMathML(symbol.tag);
    node.setAttribute(symbol.atname,symbol.atval);
    return [node,str,symbol.tag];
  case UNDEROVER:
    if (isIE) {
      if (symbol.input.substr(0,4) == "\\big") {   // botch for missing symbols
	str = "\\"+symbol.input.substr(4)+str;	   // make \bigcup = \cup etc.
	symbol = AMgetSymbol(str);
	symbol.ttype = UNDEROVER;
	str = AMremoveCharsAndBlanks(str,symbol.input.length);
      }
    }
    return [AMcreateMmlNode(symbol.tag,
			document.createTextNode(symbol.output)),str,symbol.tag];
  case CONST:
    var output = symbol.output;
    if (isIE) {
      if (symbol.input == "'")
	output = "\u2032";
      else if (symbol.input == "''")
	output = "\u2033";
      else if (symbol.input == "'''")
	output = "\u2033\u2032";
      else if (symbol.input == "''''")
	output = "\u2033\u2033";
      else if (symbol.input == "\\square")
	output = "\u25A1";	// same as \Box
      else if (symbol.input.substr(0,5) == "\\frac") {
						// botch for missing fractions
	var denom = symbol.input.substr(6,1);
	if (denom == "5" || denom == "6") {
	  str = symbol.input.replace(/\\frac/,"\\frac ")+str;
	  return [node,str,symbol.tag];
	}
      }
    }
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(output));
    return [node,str,symbol.tag];
  case LONG:  // added by DRW
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output));
    node.setAttribute("minsize","1.5");
    node.setAttribute("maxsize","1.5");
    node = AMcreateMmlNode("mover",node);
    node.appendChild(AMcreateElementMathML("mspace"));
    return [node,str,symbol.tag];
  case STRETCHY:  // added by DRW
    if (isIE && symbol.input == "\\backslash")
	symbol.output = "\\";	// doesn't expand, but then nor does "\u2216"
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output));
    if (symbol.input == "|" || symbol.input == "\\vert" ||
	symbol.input == "\\|" || symbol.input == "\\Vert") {
	  node.setAttribute("lspace","0em");
	  node.setAttribute("rspace","0em");
    }
    node.setAttribute("maxsize",symbol.atval);  // don't allow to stretch here
    if (symbol.rtag != null)
      return [node,str,symbol.rtag];
    else
      return [node,str,symbol.tag];
  case BIG:  // added by DRW
    var atval = symbol.atval;
    if (isIE)
      atval = symbol.ieval;
    symbol = AMgetSymbol(str);
    if (symbol == null)
	return [null,str,null];
    str = AMremoveCharsAndBlanks(str,symbol.input.length);
    node = AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output));
    if (isIE) {		// to get brackets to expand
      var space = AMcreateElementMathML("mspace");
      space.setAttribute("height",atval+"ex");
      node = AMcreateMmlNode("mrow",node);
      node.appendChild(space);
    } else {		// ignored in IE
      node.setAttribute("minsize",atval);
      node.setAttribute("maxsize",atval);
    }
    return [node,str,symbol.tag];
  case LEFTBRACKET:   //read (expr+)
    if (symbol.input == "\\left") { // left what?
      symbol = AMgetSymbol(str);
      if (symbol != null) {
	if (symbol.input == ".")
	  symbol.invisible = true;
	str = AMremoveCharsAndBlanks(str,symbol.input.length);
      }
    }
    result = AMparseExpr(str,true,false);
    if (symbol==null ||
	(typeof symbol.invisible == "boolean" && symbol.invisible))
      node = AMcreateMmlNode("mrow",result[0]);
    else {
      node = AMcreateMmlNode("mo",document.createTextNode(symbol.output));
      node = AMcreateMmlNode("mrow",node);
      node.appendChild(result[0]);
    }
    return [node,result[1],result[2]];
  case MATRIX:	 //read (expr+)
    if (symbol.input == "\\begin{array}") {
      var mask = "";
      symbol = AMgetSymbol(str);
      str = AMremoveCharsAndBlanks(str,0);
      if (symbol == null)
	mask = "l";
      else {
	str = AMremoveCharsAndBlanks(str,symbol.input.length);
	if (symbol.input != "{")
	  mask = "l";
	else do {
	  symbol = AMgetSymbol(str);
	  if (symbol != null) {
	    str = AMremoveCharsAndBlanks(str,symbol.input.length);
	    if (symbol.input != "}")
	      mask = mask+symbol.input;
	  }
	} while (symbol != null && symbol.input != "" && symbol.input != "}");
      }
      result = AMparseExpr("{"+str,true,true);
//    if (result[0]==null) return [AMcreateMmlNode("mo",
//			   document.createTextNode(symbol.input)),str];
      node = AMcreateMmlNode("mtable",result[0]);
      mask = mask.replace(/l/g,"left ");
      mask = mask.replace(/r/g,"right ");
      mask = mask.replace(/c/g,"center ");
      node.setAttribute("columnalign",mask);
      node.setAttribute("displaystyle","false");
      if (isIE)
	return [node,result[1],null];
// trying to get a *little* bit of space around the array
// (IE already includes it)
      var lspace = AMcreateElementMathML("mspace");
      lspace.setAttribute("width","0.167em");
      var rspace = AMcreateElementMathML("mspace");
      rspace.setAttribute("width","0.167em");
      var node1 = AMcreateMmlNode("mrow",lspace);
      node1.appendChild(node);
      node1.appendChild(rspace);
      return [node1,result[1],null];
    } else {	// eqnarray
      result = AMparseExpr("{"+str,true,true);
      node = AMcreateMmlNode("mtable",result[0]);
      if (isIE)
	node.setAttribute("columnspacing","0.25em"); // best in practice?
      else
	node.setAttribute("columnspacing","0.167em"); // correct (but ignored?)
      node.setAttribute("columnalign","right center left");
      node.setAttribute("displaystyle","true");
      node = AMcreateMmlNode("mrow",node);
      return [node,result[1],null];
    }
  case TEXT:
      if (str.charAt(0)=="{") i=str.indexOf("}");
      else i = 0;
      if (i==-1)
		 i = str.length;
      st = str.slice(1,i);
      if (st.charAt(0) == " ") {
	node = AMcreateElementMathML("mspace");
	node.setAttribute("width","0.33em");	// was 1ex
	newFrag.appendChild(node);
      }
      newFrag.appendChild(
        AMcreateMmlNode(symbol.tag,document.createTextNode(st)));
      if (st.charAt(st.length-1) == " ") {
	node = AMcreateElementMathML("mspace");
	node.setAttribute("width","0.33em");	// was 1ex
	newFrag.appendChild(node);
      }
      str = AMremoveCharsAndBlanks(str,i+1);
      return [AMcreateMmlNode("mrow",newFrag),str,null];
  case UNARY:
      result = AMparseSexpr(str);
      if (result[0]==null) return [AMcreateMmlNode(symbol.tag,
                             document.createTextNode(symbol.output)),str];
      if (typeof symbol.func == "boolean" && symbol.func) { // functions hack
	st = str.charAt(0);
//	if (st=="^" || st=="_" || st=="/" || st=="|" || st==",") {
	if (st=="^" || st=="_" || st==",") {
	  return [AMcreateMmlNode(symbol.tag,
		    document.createTextNode(symbol.output)),str,symbol.tag];
        } else {
	  node = AMcreateMmlNode("mrow",
	   AMcreateMmlNode(symbol.tag,document.createTextNode(symbol.output)));
	  if (isIE) {
	    var space = AMcreateElementMathML("mspace");
	    space.setAttribute("width","0.167em");
	    node.appendChild(space);
	  }
	  node.appendChild(result[0]);
	  return [node,result[1],symbol.tag];
        }
      }
      if (symbol.input == "\\sqrt") {		// sqrt
	if (isIE) {	// set minsize, for \surd
	  var space = AMcreateElementMathML("mspace");
	  space.setAttribute("height","1.2ex");
	  space.setAttribute("width","0em");	// probably no effect
	  node = AMcreateMmlNode(symbol.tag,result[0])
//	  node.setAttribute("minsize","1");	// ignored
//	  node = AMcreateMmlNode("mrow",node);  // hopefully unnecessary
	  node.appendChild(space);
	  return [node,result[1],symbol.tag];
	} else
	  return [AMcreateMmlNode(symbol.tag,result[0]),result[1],symbol.tag];
      } else if (typeof symbol.acc == "boolean" && symbol.acc) {   // accent
        node = AMcreateMmlNode(symbol.tag,result[0]);
	var output = symbol.output;
	if (isIE) {
		if (symbol.input == "\\hat")
			output = "\u0302";
		else if (symbol.input == "\\widehat")
			output = "\u005E";
		else if (symbol.input == "\\bar")
			output = "\u00AF";
		else if (symbol.input == "\\grave")
			output = "\u0300";
		else if (symbol.input == "\\tilde")
			output = "\u0303";
	}
	var node1 = AMcreateMmlNode("mo",document.createTextNode(output));
	if (symbol.input == "\\vec" || symbol.input == "\\check")
						// don't allow to stretch
	    node1.setAttribute("maxsize","1.2");
		 // why doesn't "1" work?  \vec nearly disappears in firefox
	if (isIE && symbol.input == "\\bar")
	    node1.setAttribute("maxsize","0.5");
	if (symbol.input == "\\underbrace" || symbol.input == "\\underline")
	  node1.setAttribute("accentunder","true");
	else
	  node1.setAttribute("accent","true");
	node.appendChild(node1);
	if (symbol.input == "\\overbrace" || symbol.input == "\\underbrace")
	  node.ttype = UNDEROVER;
	return [node,result[1],symbol.tag];
      } else {			      // font change or displaystyle command
        if (!isIE && typeof symbol.codes != "undefined") {
          for (i=0; i<result[0].childNodes.length; i++)
            if (result[0].childNodes[i].nodeName=="mi" || result[0].nodeName=="mi") {
              st = (result[0].nodeName=="mi"?result[0].firstChild.nodeValue:
                              result[0].childNodes[i].firstChild.nodeValue);
              var newst = [];
              for (var j=0; j<st.length; j++)
                if (st.charCodeAt(j)>64 && st.charCodeAt(j)<91) newst = newst +
                  String.fromCharCode(symbol.codes[st.charCodeAt(j)-65]);
                else newst = newst + st.charAt(j);
              if (result[0].nodeName=="mi")
                result[0]=AMcreateElementMathML("mo").
                          appendChild(document.createTextNode(newst));
              else result[0].replaceChild(AMcreateElementMathML("mo").
          appendChild(document.createTextNode(newst)),result[0].childNodes[i]);
            }
        }
        node = AMcreateMmlNode(symbol.tag,result[0]);
        node.setAttribute(symbol.atname,symbol.atval);
	if (symbol.input == "\\scriptstyle" ||
	    symbol.input == "\\scriptscriptstyle")
		node.setAttribute("displaystyle","false");
	return [node,result[1],symbol.tag];
      }
  case BINARY:
    result = AMparseSexpr(str);
    if (result[0]==null) return [AMcreateMmlNode("mo",
			   document.createTextNode(symbol.input)),str,null];
    result2 = AMparseSexpr(result[1]);
    if (result2[0]==null) return [AMcreateMmlNode("mo",
			   document.createTextNode(symbol.input)),str,null];
    if (symbol.input=="\\root" || symbol.input=="\\stackrel")
      newFrag.appendChild(result2[0]);
    newFrag.appendChild(result[0]);
    if (symbol.input=="\\frac") newFrag.appendChild(result2[0]);
    return [AMcreateMmlNode(symbol.tag,newFrag),result2[1],symbol.tag];
  case INFIX:
    str = AMremoveCharsAndBlanks(str,symbol.input.length);
    return [AMcreateMmlNode("mo",document.createTextNode(symbol.output)),
	str,symbol.tag];
  default:
    return [AMcreateMmlNode(symbol.tag,        //its a constant
	document.createTextNode(symbol.output)),str,symbol.tag];
  }
}

function AMparseIexpr(str) {
  var symbol, sym1, sym2, node, result, tag, underover;
  str = AMremoveCharsAndBlanks(str,0);
  sym1 = AMgetSymbol(str);
  result = AMparseSexpr(str);
  node = result[0];
  str = result[1];
  tag = result[2];
  symbol = AMgetSymbol(str);
  if (symbol.ttype == INFIX) {
    str = AMremoveCharsAndBlanks(str,symbol.input.length);
    result = AMparseSexpr(str);
    if (result[0] == null) // show box in place of missing argument
      result[0] = AMcreateMmlNode("mo",document.createTextNode("\u25A1"));
    str = result[1];
    tag = result[2];
    if (symbol.input == "_" || symbol.input == "^") {
      sym2 = AMgetSymbol(str);
      tag = null;	// no space between x^2 and a following sin, cos, etc.
// This is for \underbrace and \overbrace
      underover = ((sym1.ttype == UNDEROVER) || (node.ttype == UNDEROVER));
//    underover = (sym1.ttype == UNDEROVER);
      if (symbol.input == "_" && sym2.input == "^") {
        str = AMremoveCharsAndBlanks(str,sym2.input.length);
        var res2 = AMparseSexpr(str);
	str = res2[1];
	tag = res2[2];  // leave space between x_1^2 and a following sin etc.
        node = AMcreateMmlNode((underover?"munderover":"msubsup"),node);
        node.appendChild(result[0]);
        node.appendChild(res2[0]);
      } else if (symbol.input == "_") {
	node = AMcreateMmlNode((underover?"munder":"msub"),node);
        node.appendChild(result[0]);
      } else {
	node = AMcreateMmlNode((underover?"mover":"msup"),node);
        node.appendChild(result[0]);
      }
      node = AMcreateMmlNode("mrow",node); // so sum does not stretch
    } else {
      node = AMcreateMmlNode(symbol.tag,node);
      if (symbol.input == "\\atop" || symbol.input == "\\choose")
	node.setAttribute("linethickness","0ex");
      node.appendChild(result[0]);
      if (symbol.input == "\\choose")
	node = AMcreateMmlNode("mfenced",node);
    }
  }
  return [node,str,tag];
}

function AMparseExpr(str,rightbracket,matrix) {
  var symbol, node, result, i, tag,
  newFrag = document.createDocumentFragment();
  do {
    str = AMremoveCharsAndBlanks(str,0);
    result = AMparseIexpr(str);
    node = result[0];
    str = result[1];
    tag = result[2];
    symbol = AMgetSymbol(str);
    if (node!=undefined) {
      if ((tag == "mn" || tag == "mi") && symbol!=null &&
	typeof symbol.func == "boolean" && symbol.func) {
			// Add space before \sin in 2\sin x or x\sin x
	  var space = AMcreateElementMathML("mspace");
	  space.setAttribute("width","0.167em");
	  node = AMcreateMmlNode("mrow",node);
	  node.appendChild(space);
      }
      newFrag.appendChild(node);
    }
  } while ((symbol.ttype != RIGHTBRACKET)
        && symbol!=null && symbol.output!="");
  tag = null;
  if (symbol.ttype == RIGHTBRACKET) {
    if (symbol.input == "\\right") { // right what?
      str = AMremoveCharsAndBlanks(str,symbol.input.length);
      symbol = AMgetSymbol(str);
      if (symbol != null && symbol.input == ".")
	symbol.invisible = true;
      if (symbol != null)
	tag = symbol.rtag;
    }
    if (symbol!=null)
      str = AMremoveCharsAndBlanks(str,symbol.input.length); // ready to return
    var len = newFrag.childNodes.length;
    if (matrix &&
      len>0 && newFrag.childNodes[len-1].nodeName == "mrow" && len>1 &&
      newFrag.childNodes[len-2].nodeName == "mo" &&
      newFrag.childNodes[len-2].firstChild.nodeValue == "&") { //matrix
	var pos = []; // positions of ampersands
        var m = newFrag.childNodes.length;
        for (i=0; matrix && i<m; i=i+2) {
          pos[i] = [];
          node = newFrag.childNodes[i];
	  for (var j=0; j<node.childNodes.length; j++)
	    if (node.childNodes[j].firstChild.nodeValue=="&")
	      pos[i][pos[i].length]=j;
        }
	var row, frag, n, k, table = document.createDocumentFragment();
	for (i=0; i<m; i=i+2) {
	  row = document.createDocumentFragment();
	  frag = document.createDocumentFragment();
	  node = newFrag.firstChild; // <mrow> -&-&...&-&- </mrow>
	  n = node.childNodes.length;
	  k = 0;
	  for (j=0; j<n; j++) {
	    if (typeof pos[i][k] != "undefined" && j==pos[i][k]){
	      node.removeChild(node.firstChild); //remove &
	      row.appendChild(AMcreateMmlNode("mtd",frag));
	      k++;
	    } else frag.appendChild(node.firstChild);
	  }
	  row.appendChild(AMcreateMmlNode("mtd",frag));
	  if (newFrag.childNodes.length>2) {
	    newFrag.removeChild(newFrag.firstChild); //remove <mrow> </mrow>
	    newFrag.removeChild(newFrag.firstChild); //remove <mo>&</mo>
	  }
	  table.appendChild(AMcreateMmlNode("mtr",row));
	}
	return [table,str];
    }
    if (typeof symbol.invisible != "boolean" || !symbol.invisible) {
      node = AMcreateMmlNode("mo",document.createTextNode(symbol.output));
      newFrag.appendChild(node);
    }
  }
  return [newFrag,str,tag];
}

function AMparseMath(str) {
  var result, node = AMcreateElementMathML("mstyle");
  if (mathcolor != "") node.setAttribute("mathcolor",mathcolor);
  if (mathfontfamily != "") node.setAttribute("fontfamily",mathfontfamily);
  node.appendChild(AMparseExpr(str.replace(/^\s+/g,""),false,false)[0]);
  node = AMcreateMmlNode("math",node);
  if (showasciiformulaonhover)                      //fixed by djhsu so newline
    node.setAttribute("title",str.replace(/\s+/g," "));//does not show in Gecko
  if (mathfontfamily != "" && (isIE || mathfontfamily != "serif")) {
    var fnode = AMcreateElementXHTML("font");
    fnode.setAttribute("face",mathfontfamily);
    fnode.appendChild(node);
    return fnode;
  }
  return node;
}

function AMstrarr2docFrag(arr, linebreaks) {
  var newFrag=document.createDocumentFragment();
  var expr = false;
  for (var i=0; i<arr.length; i++) {
    if (expr) newFrag.appendChild(AMparseMath(arr[i]));
    else {
      var arri = (linebreaks ? arr[i].split("\n\n") : [arr[i]]);
      newFrag.appendChild(AMcreateElementXHTML("span").
      appendChild(document.createTextNode(arri[0])));
      for (var j=1; j<arri.length; j++) {
        newFrag.appendChild(AMcreateElementXHTML("p"));
        newFrag.appendChild(AMcreateElementXHTML("span").
        appendChild(document.createTextNode(arri[j])));
      }
    }
    expr = !expr;
  }
  return newFrag;
}

function AMprocessNodeR(n, linebreaks) {
  var mtch, str, arr, frg, i;
  if (n.childNodes.length == 0) {
   if ((n.nodeType!=8 || linebreaks) &&
    n.parentNode.nodeName!="form" && n.parentNode.nodeName!="FORM" &&
    n.parentNode.nodeName!="textarea" && n.parentNode.nodeName!="TEXTAREA" &&
    n.parentNode.nodeName!="pre" && n.parentNode.nodeName!="PRE") {
    str = n.nodeValue;
    if (!(str == null)) {
      str = str.replace(/\r\n\r\n/g,"\n\n");
      str = str.replace(/\x20+/g," ");
      str = str.replace(/\s*\r\n/g," ");
// DELIMITERS:
      mtch = (str.indexOf("\$")==-1 ? false : true);
      str = str.replace(/([^\\])\$/g,"$1 \$");
      str = str.replace(/^\$/," \$");	// in case \$ at start of string
      arr = str.split(" \$");
      for (i=0; i<arr.length; i++)
	arr[i]=arr[i].replace(/\\\$/g,"\$");
      if (arr.length>1 || mtch) {
        if (checkForMathML) {
          checkForMathML = false;
          var nd = AMisMathMLavailable();
          AMnoMathML = nd != null;
          if (AMnoMathML && notifyIfNoMathML)
            if (alertIfNoMathML)
              alert("To view the ASCIIMathML notation use Internet Explorer 6 +\nMathPlayer (free from www.dessci.com)\n\
                or Firefox/Mozilla/Netscape");
            else AMbody.insertBefore(nd,AMbody.childNodes[0]);
        }
        if (!AMnoMathML) {
          frg = AMstrarr2docFrag(arr,n.nodeType==8);
          var len = frg.childNodes.length;
          n.parentNode.replaceChild(frg,n);
          return len-1;
        } else return 0;
      }
    }
   } else return 0;
  } else if (n.nodeName!="math") {
    for (i=0; i<n.childNodes.length; i++)
      i += AMprocessNodeR(n.childNodes[i], linebreaks);
  }
  return 0;
}

function AMprocessNode(n, linebreaks, spanclassAM) {
  var frag,st;
  if (spanclassAM!=null) {
    frag = document.getElementsByTagName("span")
    for (var i=0;i<frag.length;i++)
      if (frag[i].className == "AM")
        AMprocessNodeR(frag[i],linebreaks);
  } else {
    try {
      st = n.innerHTML;
    } catch(err) {}
// DELIMITERS:
    if (st==null || st.indexOf("\$")!=-1)
      AMprocessNodeR(n,linebreaks);
  }
  if (isIE) { //needed to match size and font of formula to surrounding text
    frag = document.getElementsByTagName('math');
    for (var i=0;i<frag.length;i++) frag[i].update()
  }
}

var AMbody;
var AMnoMathML = false, AMtranslated = false;

function translate(spanclassAM) {
  if (!AMtranslated) { // run this only once
    AMtranslated = true;
    AMinitSymbols();
    AMbody = document.getElementsByTagName("body")[0];
    AMprocessNode(AMbody, false, spanclassAM);
  }
}

if (isIE) { // avoid adding MathPlayer info explicitly to each webpage
  document.write("<object id=\"mathplayer\"\
  classid=\"clsid:32F66A20-7614-11D4-BD11-00104BD3F987\"></object>");
  document.write("<?import namespace=\"m\" implementation=\"#mathplayer\"?>");
}

// GO1.1 Generic onload by Brothercake
// http://www.brothercake.com/
//onload function (replaces the onload="translate()" in the <body> tag)
function generic()
{
  translate();
};
//setup onload function
if(typeof window.addEventListener != 'undefined')
{
  //.. gecko, safari, konqueror and standard
  window.addEventListener('load', generic, false);
}
else if(typeof document.addEventListener != 'undefined')
{
  //.. opera 7
  document.addEventListener('load', generic, false);
}
else if(typeof window.attachEvent != 'undefined')
{
  //.. win/ie
  window.attachEvent('onload', generic);
}
//** remove this condition to degrade older browsers
else
{
  //.. mac/ie5 and anything else that gets this far
  //if there's an existing onload function
  if(typeof window.onload == 'function')
  {
    //store it
    var existing = onload;
    //add new onload handler
    window.onload = function()
    {
      //call existing onload function
      existing();
      //call generic onload function
      generic();
    };
  }
  else
  {
    //setup onload function
    window.onload = generic;
  }
}
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Tomb Raider II Data Formats (TRosettaStone)</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Document Version 1.00 (991108)</p></div>
<div class="paragraph"><p><strong>Tomb Raider II .TR2 Data File Format</strong>
(Including Tomb Raider <span class="monospaced">.PHD</span>/<span class="monospaced">.TUB</span> and Tomb Raider III <span class="monospaced">.TR2</span> information, where available.)<br>
(Also includes <span class="monospaced">TOMBPC.DAT</span> script information.)<br></p></div>
<div class="quoteblock">
<div class="content">The Rosetta Stone was the key that unlocked the mysteries of Egyptian hieroglyphics. It contains an inscription praising King Ptolemy V, which is repeated
three times&#8201;&#8212;&#8201;once in hieroglyphic, once in demotic, and once in Greek. By translating the Greek, comparisons could be made with the demotic and hieroglyphic
versions, providing an invaluable lexicon with which to translate other hieroglyphic works. The efforts that went into making the document you are now reading
could be likened to a form of digital archæology, and hopefully this document will provide sufficient information for others to decipher and create their own
&#8220;TR-hieroglyphic&#8221; works.</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>This document contains detailed descriptions of the Tomb Raider II data file formats (<span class="monospaced">{Level-name}.TR2</span> and <span class="monospaced">TOMBPC.DAT</span>). It is assumed that the reader has
knowledge and experience programming in C or C++, and has at least a passing familiarity with graphics programming. This document is self-contained; all
hyperlinks refer only to itself. All information in this document was derived independently, without the aid or assistance of anyone at Core Design or Eidos. As
such, the information in this document may contain errors or omissions, and all structure and variable names were deduced from the interpretation of the data
(and therefore could be misleading or completely wrong). All the information in this document was tested and is therefore plausible, but could also be a
misinterpretation. All information herein is provided as is&#8201;&#8212;&#8201;you get what you pay for, and this one&#8217;s free. This was a spare-time project that set out to
document the Tomb Raider 2 file format; along the way, additional information about Tomb Raider 1 / Gold (<span class="monospaced">.PHD</span>, <span class="monospaced">.TUB</span>) and Tomb Raider 3 (<span class="monospaced">.TR2</span>) files became
available, and that information is provided in context. Where applicable, Tomb Raider I, Tomb Raider Unfinished Business, and Tomb Raider Gold are all referred
to as TR1, and if the information specific to TR1 is interspersed with TR2 information, the TR1 information is highlighted in <strong><span class="red">RED</span></strong>. Likewise, Tomb Raider III is
referred to as TR3, and information specific to TR3 is highlighted in <strong><span class="green">GREEN</span></strong>.  In the few places where there is such information, information specific to TR2
ONLY is highlighted in <strong><span class="blue">BLUE</span></strong>.  Everything else is assumed to pertain to TR2 only, or to all three games. [Late note: as this document was being prepared for
release, the Tomb Raider: Last Revelation demo was released.  <span class="monospaced">.TR4</span> files will be hopefully be addressed in a future revision of this document.]</p></div>
<div class="paragraph"><p>Because of Core/Eidos' position on Tomb Raider level editing tools, it is suggested that any tools that you develop be released in source code form,
anonymously, using Usenet newsgroups.  Anonymity can protect you from legal action, wide distribution via Usenet prevents Core/Eidos from attempting to recall
or control the distribution of your software, and distributing source code both allows multi-platform development (e.g. let others port it to the Mac or Linux
for you) and encourages others to write utilities, since they can learn and benefit from your source code.  Also, Linux has taught us that 40,000 people
debugging a single application makes for a clean final product ;-)</p></div>
<div class="paragraph"><p>Tomb Raider, Tomb Raider Gold, Unfinished Business, Tomb Raider II, Tomb Raider III, Lara Croft, and all images and data within the data files and game engine
are Copyright &#169; Core Design and/or Eidos PLC.  Modification and/or distribution of any part of a Tomb Raider data file (any version) is almost certainly a
copyright violation.</p></div>
<div class="paragraph"><p>This document was composed at a screen resolution of 1024x768, and is best viewed at that resolution.  It contains many links, but all of them refer only to
this document;  no link from this page will take you to another web site, and this document can be viewed offline (not connected to the Internet).  Use your
browser&#8217;s <strong>BACK</strong> button to return from a link, e.g. if you click on a structure declaration to see its definition, clicking <strong>BACK</strong> will return you to your point
of origin after you&#8217;ve examined the structure definition.</p></div>
</div>
</div>
<h1 id="_the_fundamentals">The Fundamentals</h1>
<div class="sect1">
<h2 id="_overview">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>Tomb Raider II is driven by two sets of files. The script file, <span class="monospaced">TOMBPC.DAT</span>, contains all the text strings describing the various elements in the
game (e.g. the game engine knows about &#8220;Key 1&#8221;; it looks in <span class="monospaced">TOMBPC.DAT</span> to determine the name to be displayed in Lara&#8217;s inventory, such as &#8220;Rusty Key&#8221; or
&#8220;Taste rostige&#8221; or &#8220;Clé Rouillée&#8221;), the level and cut-scene filenames (e.g. <span class="monospaced">WALL.TR2</span>, <span class="monospaced">CUT3.TR2</span>), the order in which they are to be played, and various
per-level and per-game configuration options (e.g. what weapons and objects Lara starts the level with, whether or not the &#8220;cheat&#8221; codes work, etc.). The
level files, <span class="monospaced">{level-name}.TR2</span>, contain everything about the level, including the geographical geometry, the geometry (meshes) of all animate and inanimate
objects in the level, all the textures and colour data, all animation data, index information (and, in TR1, the actual sound sample data) for all sounds,
accessibility maps&#8201;&#8212;&#8201;everything necessary to run the game. For whatever reason, Core has included everything in one file instead of breaking it up into logical
groupings; this means that every level contains all the meshes, textures, sound information, and animation data for Lara and all of her weapons. There are a
fair number of other redundancies, too.</p></div>
<div class="paragraph"><p>For the purposes of further discussion, the following are assumed:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:50%;
">
<col style="width:16%;">
<col style="width:83%;">
<tbody>
<tr>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><span class="monospaced">int8_t</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">specifies an 8-bit signed integer (range -128..127)</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><span class="monospaced">uint8_t</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">specifies an 8-bit unsigned integer (range 0..255)</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><span class="monospaced">int16_t</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">specifies a 16-bit signed integer (range -32768..32767)</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><span class="monospaced">uint16_t</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">specifies a 16-bit unsigned integer (range 0..65535)</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><span class="monospaced">int32_t</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">specifies a 32-bit signed integer (range -2147483648..2147483647)</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top" ><p class="tableblock"><span class="monospaced">uint32_t</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">specifies a 32-bit unsigned integer (range 0..4294967295)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>All multi-byte integers (<span class="monospaced">{u}int16_t</span>, <span class="monospaced">{u}int32_t</span>) are stored in little-endian (Intel-x86, etc.) format, with the least significant byte stored first and the
most significant byte stored last. When using this data in platforms with big-endian (PowerPC, etc.) number format, be sure to reverse the order of bytes.</p></div>
<div class="paragraph"><p>Data alignment is something one has to be careful about. When some entity gets an address that is a multiple of $n$, it is said to be $n$-byte aligned. The reason
it is important here is that some systems prefer multibyte alignment for multibyte quantities, and compilers for such systems may pad the data to get the
&#8220;correct&#8221; alignments, thus making the in-memory structures out of sync with their file counterparts. However, a compiler may be commanded to use a lower level
of alignment, one that will not cause padding. And for TR&#8217;s data structures, 2-byte alignment should be successful in nearly all cases, with exceptions noted
below.</p></div>
<div class="paragraph"><p>To set single-byte alignment in any recent compiler, use the following compiler directive:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#pragma</span></span> <span style="font-weight: bold"><span style="color: #000000">pack</span></span><span style="color: #990000">(</span>push<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To return to the project&#8217;s default alignment, use the following directive:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#pragma</span></span> <span style="font-weight: bold"><span style="color: #000000">pack</span></span><span style="color: #990000">(</span>pop<span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_coordinates">2. Coordinates</h2>
<div class="sectionbody">
<div class="paragraph"><p>The world coordinate system is oriented with the $X-Z$ plane horizontal and $Y$ vertical, with $-Y$ being &#8220;up&#8221; (e.g. decreasing $Y$ values indicate
increasing altitude). The world coordinate system is specified using <span class="monospaced">int32_t</span> values; however, the geography is limited to the $+X$/$+Z$ quadrant for reasons that are
explained below. Mesh coordinates are relative and are specified using `int16_t`s.  There are some additional coordinate values used, such as
&#8220;the number of 1024-unit blocks between points A and B&#8221;;  these are simply scaled versions of more conventional coordinates.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_colours">3. Colours</h2>
<div class="sectionbody">
<div class="paragraph"><p>All colours in TR2 are specified either explicitly (using either the <a href="#tr2_colour">[tr2_colour]</a> structure, described below, or the 16-bit
ARGB structure) or implicitly, by indexing one of the palettes.  If, for some reason, 16-bit textures are turned off, all colours and textures use an 8-bit
palette that is stored in the <span class="monospaced">.TR2</span> file.  This palette consists of a 256-element array of <a href="#tr2_colour">[tr2_colour]</a> structures, each designating some
colour;  textures and other elements that need to reference a colour specify an index (0..255) into the <span class="monospaced">Palette[]</span> array.  There is also a 16-bit palette, which
is used for identifying colours of solid polygons.  The 16-bit palette contains up to 256 four-byte entries;  the first three bytes are a
<a href="#tr2_colour">[tr2_colour]</a>, while the last byte is ignored (set to 0).</p></div>
<div class="paragraph"><p>The 16-bit textile array, which contains <a href="#tr2_textile16">[tr2_textile16]</a> structures, specifies colours using 16-bit ARGB, where the highest bit
(<span class="monospaced">0x8000</span>) is a crude alpha channel (really just simple transparency&#8201;&#8212;&#8201;0 ::= transparent, 1 ::= opaque).  The next 5 bits (<span class="monospaced">0x7c00</span>) specify the red channel, the
next 5 bits (<span class="monospaced">0x03e0</span>) specify the green channel, and the last 5 bits (<span class="monospaced">0x001f</span>) specify the blue channel, each on a scale from 0..31.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_objects">4. Objects</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are two basic types of objects in TR2&#8201;&#8212;&#8201;meshes and sprites. <em>Meshes</em> are collections of textured or coloured polygons that are assembled to
form a three-dimensional object (such as a tree, a tiger, or Lara herself). The &#8220;rooms&#8221; themselves are also composed of meshes. Mesh objects may contain more
than one mesh; though these meshes are moved relative to each other, each mesh is rigid. <em>Sprites</em> are two-dimensional images that are inserted into
three-dimensional space, such as the &#8220;secret&#8221; dragons, ammunition, medi-packs, etc. There are also animated sprite sequences, such as the fire at the end of
&#8220;The Great Wall.&#8221; Core had presumably used this method to reduce CPU utilization on the PlayStation and/or the earlier PCs. Sprites become less and less
abundant; TR2 has very few scenery sprites, and TR3&#8217;s pickups are models instead of sprites. Objects are referenced in one of two ways&#8201;&#8212;&#8201;as an offset into an
array (e.g. <span class="monospaced">Moveables[i]</span>) or using an identifying tag (<span class="monospaced">ObjectID</span>). In the latter case, the related array (<span class="monospaced">Items[]</span>, <span class="monospaced">Moveables[]</span>, etc.) is searched until a
matching <span class="monospaced">ObjectID</span> is found.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_animations">5. Animations</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are three basic types of animations in TR2, two corresponding directly with meshes and sprites, and a third type, animated textures. Sprite
animation (sprite sequences) consists simply of a series of sprites that are to be displayed one after another, e.g. grenade explosions. Mesh animations are
much more complex, done by what is essentially a skeletal-modeling scheme. These involve some arrays (<span class="monospaced">Frames[]</span> and <span class="monospaced">MeshTree[]</span>) of offsets and rotations for each
element of a composite mesh. Frames are then grouped into an array (<span class="monospaced">Animations[]</span>) that describes discrete &#8220;movements,&#8221; e.g. Lara taking a step or a tiger
striking with its paw. The animations are &#8220;sewn together&#8221; by a state change array and an animation dispatch array, which, together with state information
about the character, ensure that the animation is fluid (e.g. if Lara is running and the player releases the RUN key, she will stop; depending upon which of her
feet was down at the time, either her left or right foot will strike the floor as part of the &#8220;stop&#8221; animation. The correct animation (left foot stop vs.
right foot stop) is selected using these structures and the state information). Animated textures are simply a list of textures that are cycled through in an
endless loop; they are normally used as geographic elements of the levels (e.g. water surface, bubbling lava, Atlantean plasma walls).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_lighting">6. Lighting</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are two main types of lighting in Tomb Raider, constant and vertex. Constant lighting means that all parts of an object have the same
illumination, while in vertex lighting, each polygon vertex has its own light value, and the illumination of the polygon interiors is interpolated from the
vertex values. Furthermore, lighting can be either internal or external. Internal lighting is specified in an object&#8217;s data, external lighting is calculated
using the room&#8217;s light sources (ambient light, point light sources, flares, gunshots). Light intensities are described with a single value in TR1 and a pair of
values in TR2 and TR3; the paired values are almost always equal, and the pairing may reflect some feature that was only imperfectly implemented, such as off/on
or minimum/maximum values. In TR1 and TR2, the light values go from 0 (maximum light) to 8192 (minimum light), while in TR3, the light values go from 0 (minimum
light) to 32767 (maximum light).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_data_structures">7. Basic Data Structures</h2>
<div class="sectionbody">
<div class="paragraph"><p>Much of the .TR2 file is comprised of structures based on a few fundamental data structures, described below.</p></div>
<div class="sect2">
<h3 id="_colour_structure">7.1. Colour structure</h3>
<div class="paragraph"><p>This is how most colours are specified.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_colour</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 3 bytes</span></span>
    <span style="color: #008080">uint8_t</span> Red<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">// Red component (0 ::= darkest, 255 ::= brightest)</span></span>
    <span style="color: #008080">uint8_t</span> Green<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// Green component (0 ::= darkest, 255 ::= brightest)</span></span>
    <span style="color: #008080">uint8_t</span> Blue<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">// Blue component (0 ::= darkest, 255 ::= brightest)</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>(Some compilers will pad this structure to make 4 bytes; one must either read and write 3 bytes explicitly, or else use a simple array of
bytes instead of this structure.)</p></div>
<div class="paragraph"><p>And as mentioned earlier, the 16-bit palette uses a similar structure:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_colour4</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 4 bytes</span></span>
    <span style="color: #008080">uint8_t</span> Red<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> Green<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> Blue<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> Unused<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_vertex_structure">7.2. Vertex structure</h3>
<div class="paragraph"><p>This is how vertices are specified, using relative coordinates.  They are generally formed into lists, such that other entities (such as
quads or triangles) can refer to them by simply using their index in the list.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_vertex</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 6 bytes</span></span>
    <span style="color: #008080">int16_t</span> x<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> y<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> z<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_rectangular_quad_face_definition">7.3. Rectangular (quad) face definition</h3>
<div class="paragraph"><p>Four vertices (the values are indices into the appropriate vertex list) and a texture (an index into the object-texture
list) or colour (index into 8-bit palette or 16-bit palette).  If the rectangle is a coloured polygon (not textured), the .Texture element contains two indices:
the low byte (<span class="monospaced">.Texture &amp; 0xff</span>) is an index into the 256-colour palette, while the high byte (<span class="monospaced">.Texture &gt;&gt; 8</span>) is in index into the 16-bit palette, when present. A
textured rectangle will have its vertices mapped onto all 4 vertices of an object texture, in appropriate correspondence.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_face4</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 10 bytes</span></span>
    <span style="color: #008080">uint16_t</span> Vertices<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span>
    <span style="color: #008080">uint16_t</span> Texture<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_triangular_face_definition">7.4. Triangular face definition</h3>
<div class="paragraph"><p>Three vertices (the values are indices into the appropriate vertex list) and a texture (an index into the object-texture list)
or colour (index into 8-bit palette or 16-bit palette).  If the triangle is a coloured polygon (not textured), the .Texture element contains two indices: the
low byte (<span class="monospaced">.Texture &amp; 0xff</span>) is an index into the 256-colour palette, while the high byte (<span class="monospaced">.Texture &gt;&gt; 8</span>) is in index into the 16-bit palette, when present. A
textured triangle will have its vertices mapped onto the first 3 vertices of an object texture, in appropriate correspondence.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_face3</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 8 bytes</span></span>
    <span style="color: #008080">uint16_t</span> Vertices<span style="color: #990000">[</span><span style="color: #993399">3</span><span style="color: #990000">];</span>
    <span style="color: #008080">uint16_t</span> Texture<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_8_bit_texture_tile_65536_bytes">7.5. 8-bit texture tile (65536 bytes)</h3>
<div class="paragraph"><p>Each <span class="monospaced">uint8_t</span> represents a pixel whose colour is in the 8-bit palette.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_textile8</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 65536 bytes</span></span>
    <span style="color: #008080">uint8_t</span> Tile<span style="color: #990000">[</span><span style="color: #993399">256</span> <span style="color: #990000">*</span> <span style="color: #993399">256</span><span style="color: #990000">];</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_16_bit_texture_tile_131072_bytes">7.6. 16-bit texture tile (131072 bytes)</h3>
<div class="paragraph"><p>Each <span class="monospaced">uint16_t</span> represents a pixel whose colour is of the form ARGB, MSB-to-LSB:</p></div>
<div class="paragraph"><p>1-bit transparency (0 ::= transparent, 1 ::= opaque) (<span class="monospaced">0x8000</span>) <br>
5-bit red channel (<span class="monospaced">0x7c00</span>) <br>
5-bit green channel (<span class="monospaced">0x03e0</span>) <br>
5-bit blue channel (<span class="monospaced">0x001f</span>)</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_textile16</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 131072 bytes</span></span>
    <span style="color: #008080">uint16_t</span> Tile<span style="color: #990000">[</span><span style="color: #993399">256</span> <span style="color: #990000">*</span> <span style="color: #993399">256</span><span style="color: #990000">];</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_textures">7.7. Textures</h3>
<div class="paragraph"><p>All mesh surfaces are either <em>coloured</em> or <em>textured</em>.  Coloured surfaces are &#8220;painted&#8221; with a single colour that is either specified explicitly
or using an index into the palette.  Textured surfaces map textures (bitmapped images) from the texture tiles (textiles) to each point on the mesh surface.
This is done using conventional UV mapping, which is specified in &#8220;Object Textures&#8221; below; each object texture specifies a mapping from a set of vertices to
locations in the textile, and these texture vertices are associated with position vertices specified here.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sounds">8. Sounds</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are several sorts of sounds, which can be classified as either continuous or triggered. Continuous sounds are level-background sounds (such as
the blowing wind in &#8220;The Great Wall&#8221;) and sound sources (such as waterfalls; these are in <span class="monospaced">SoundSources[]</span>). Triggered sounds are sounds played when some event
happens, such as at certain animation frames (footsteps and other Lara sounds), when doors open and close, and when weapons are fired. Sounds are stored in two
places: the game-data files and the CD audio tracks (the latter are separate soundfiles in the MacOS version). The latter kind of sound is referred to
straightforwardly, by index, while the former kind of sound is referred to using a three-layer indexing scheme, to provide a maximum amount of abstraction. An
internal sound index references <span class="monospaced">SoundMap[]</span>, which points to a <span class="monospaced">SoundDetails[]</span> record, which in turn points to a <span class="monospaced">SampleIndices[]</span> entry, which in turn points to a
sound sample. <span class="monospaced">SoundDetails[]</span> contains such features as sound intensity, how many sound samples to choose from, among others. The sound samples themselves are in
Microsoft WAVE format, and they are embedded either in the data files (TR1, some later TR demos) or in a separate file (<span class="monospaced">MAIN.SFX</span>) in TR2 and TR3.</p></div>
</div>
</div>
<h1 id="_room_geometry">Room Geometry</h1>
<div class="sect1">
<h2 id="_overview_2">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>A <em>room</em> in TR2 is simply a rectangular three-dimensional area. A room may be &#8220;indoors&#8221; or &#8220;outdoors,&#8221; may or may not be enclosed, may be
accessible or inaccessible to Lara, may or may not contain doors or objects. All rooms have &#8220;portals,&#8221; called &#8220;doors&#8221; in some documentation, which are
pathways to adjacent rooms. There are two kinds of portals, visibility portals and collisional portals. Visibility portals are for determining how much of a
room (if any) is visible from another room, while collisional portals are for enabling an object to travel from one room to another. The visibility portals are
most likely for doing &#8220;portal rendering&#8221;, which is a visibility-calculation scheme that goes as follows: The viewpoint is a member of some room, which is then
listed as visible from it. This room&#8217;s portals are checked for visibility from that viewpoint, and visible portals have their opposite-side rooms marked as
visible. These rooms are then checked for portals that are visible from the viewpoint through the viewpoint&#8217;s room&#8217;s portals, and visible ones have their
opposite-side rooms marked as visible. This operation is repeated, with viewing through intermediate portals, until all visible portals have been found. The
result is a tree of rooms, starting from the viewpoint&#8217;s room; only those rooms and their contents need be rendered. It is clear that both visibility and
collision calculations require that objects have room memberships given for them, and indeed we shall find that most map objects have room memberships.</p></div>
<div class="paragraph"><p>Rooms may overlap; as we shall see, this is involved in how horizontal collisional portals are implemented. However, different rooms may overlap without either
being directly accessible from the other; there are several inadvertent examples of such &#8220;5D space&#8221; in the Tomb Raider series. The only possibly deliberate
example I know of is the flying saucer in &#8220;Area 51&#8221; in TR3, whose interior is bigger than its exterior.</p></div>
<div class="paragraph"><p>A room can have an &#8220;alternate room&#8221; specified for it; that means that that room can be replaced by that alternate as the game is running. This trick is used
to produce such tricks as empty rooms vs. rooms full of water, scenery rearrangements (for example, the dynamited house in &#8220;Bartoli&#8217;s Hideout&#8221; in TR2), and so
forth. An empty room is first created, and then a full room is created at its location from a copy of it. The empty room then has that full room set as its
alternate, and when that room is made to alternate, one sees a full room rather than an empty one.</p></div>
<div class="paragraph"><p>The rooms are stored sequentially in an array, and &#8220;Room Numbers&#8221; are simply indices into this array (e.g. &#8220;Room Number 5&#8221; is simply <span class="monospaced">Rooms[5]</span>; the first
room is <span class="monospaced">Rooms[0]</span>).</p></div>
<div class="paragraph"><p>Rooms are divided into <em>Sectors</em>, which are 1024x1024 unit squares that form a grid on the $X-Z$ plane.  Sectors are the defining area for floor/ceiling height
and various actions (e.g. a tiger appears and attacks when Lara steps on a given square);  the various attributes of each sector are stored in the Sector Data
(described in this section) and the <a href="#FloorData"><span class="monospaced">FloorData</span></a>.  As an aside, Sectors correspond to the &#8220;squares,&#8221; easily visible in all of the Tomb Raider
games, that experienced players count when gauging jumps;  they also account for some of the game&#8217;s less-appealing graphic artifacts. Careful tiling and texture
construction can make these &#8220;squares&#8221; almost invisible.</p></div>
<div class="paragraph"><p>Rooms have two kinds of surfaces, rendered and collisional, much like the two kinds of portals. The former are what is seen, while the latter control how
objects interact with the world geometry. Furthermore, these two types are specified separately in the room data.</p></div>
<div class="paragraph"><p>Rooms are defined with a complex structure, which is described below &#8220;inside-out,&#8221; meaning that the smaller component structures are described first, followed
by the larger structures that are built using the smaller structures.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_room_structures">2. Room Structures</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_room_header">2.1. Room header</h3>
<div class="paragraph"><p><span class="monospaced">X</span>/<span class="monospaced">Z</span> indicate the base position of the room mesh in world coordinates (<span class="monospaced">Y</span> is always zero-relative)</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room_info</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 16 bytes</span></span>
    <span style="color: #008080">int32_t</span> x<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">// X-offset of room (world coordinates)</span></span>
    <span style="color: #008080">int32_t</span> z<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">// Z-offset of room (world coordinates)</span></span>
    <span style="color: #008080">int32_t</span> yBottom<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">// (actually largest value, but indicates lowest point in room)</span></span>
    <span style="color: #008080">int32_t</span> yTop<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">// (actually smallest value, but indicates highest point in room)</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_portal_structure">2.2. Portal structure</h3>
<div class="paragraph"><p>These portals, sometimes called &#8220;doors&#8221;, define the view from a room into another room. This can be through a &#8220;real&#8221; door, a window,
or even some open area that makes the rooms look like one big room. Note that &#8220;rooms&#8221; here are really just areas; they aren&#8217;t necessarily enclosed.  The
portal structure below defines visibility portals, not an actual moveable door mesh, texture, or action (if any).  And if the portal is not properly oriented,
the camera cannot &#8220;see&#8221; through it.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room_portal</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 32 bytes</span></span>
    <span style="color: #008080">uint16_t</span> AdjoiningRoom<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// which room this portal leads to</span></span>
    <span style="color: #008080">tr2_vertex</span> Normal<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// which way the portal faces (the normal</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// points _away_ from the adjacent room; to be seen through, it must point _toward_ the viewpoint).</span></span>
    <span style="color: #008080">tr2_vertex</span> Vertices<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// the corners of this portal (the right-hand rule applies with respect to the normal)</span></span>
                            <span style="font-style: italic"><span style="color: #9A1900">// if the right-hand-rule is not followed, the portal will</span></span>
                            <span style="font-style: italic"><span style="color: #9A1900">// contain visual artifacts instead of a viewport to</span></span>
                            <span style="font-style: italic"><span style="color: #9A1900">// AdjoiningRoom</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_room_sector_structure">2.3. Room Sector structure</h3>
<div class="paragraph"><p>All the geometry specified here is collisional geometry. Sectors are 1024 * 1024 (world coordinates). Floor and Ceiling are signed
numbers of 256 units of height (relative to 0), e.g. Floor <span class="monospaced">0x04</span> corresponds to $Y = 1024$ in world coordinates. Note: this implies that, while $X$ and $Z$ can be
quite large, $Y$ is constrained to -32768..32512. Floor/Ceiling value of <span class="monospaced">0x81</span> is used to indicate impenetrable walls around the sector. Floor values are used by
the game engine to determine what objects Lara can traverse and how. Relative steps of 1 (-256) can be walked up; steps of 2..7 (-512..-1792) can/must be jumped
up; steps larger than 7 (-2048..-32768) cannot be jumped up (too tall). <span class="monospaced">RoomAbove</span> and <span class="monospaced">RoomBelow</span> indicate what neighboring rooms are in these directions; if
<span class="monospaced">RoomAbove</span> is not &#8220;none&#8221;, then the ceiling is a collisional portal to that room, while if <span class="monospaced">RoomBelow</span> is not &#8220;none&#8221;, then the floor is a collisional portal to
that room.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room_sector</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 8 bytes</span></span>
    <span style="color: #008080">uint16_t</span> FDindex<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// Index into FloorData[]</span></span>
    <span style="color: #008080">uint16_t</span> BoxIndex<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// Index into Boxes[]/Zones[] (-1 if none)</span></span>
    <span style="color: #008080">uint8_t</span>  RoomBelow<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// The number of the room below this one (-1 or 255 if none)</span></span>
    <span style="color: #008080">int8_t</span>   Floor<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// Absolute height of floor (multiply by 256 for world coordinates)</span></span>
    <span style="color: #008080">uint8_t</span>  RoomAbove<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// The number of the room above this one (-1 or 255 if none)</span></span>
    <span style="color: #008080">int8_t</span>   Ceiling<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// Absolute height of ceiling (multiply by 256 for world coordinates)</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p><span class="green">In TR3, <span class="monospaced">BoxIndex</span> is more complicated. Only bits 4-14 are the &#8220;real&#8221; index; bits 0-3 are most likely some kind of flag, such as what kind of footstep sound to
make (wood, metal, snow). Furthermore, there is a special value of the &#8220;real&#8221; index, 2047, or <span class="monospaced">0x7ff</span>.</span></p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_room_lighting_structure">2.4. Room Lighting structure</h3>
<div class="paragraph"><p>X/Y/Z are in world coordinates.  Intensity1/Intensity2 are almost always equal. This lighting only affects externally-lit objects.
Tomb Raider 1 has only the first of the paired Intensity and Fade values.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room_light</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 24 bytes [TR1: 18 bytes]</span></span>
    <span style="color: #008080">int32_t</span> x<span style="color: #990000">,</span> y<span style="color: #990000">,</span> z<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">// position of light, in world coordinates</span></span>
    <span style="color: #008080">uint16_t</span> Intensity1<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// Light intensity</span></span>
    <span style="color: #008080">uint16_t</span> Intensity2<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// Almost always equal to Intensity1 [absent from TR1 data files]</span></span>
    <span style="color: #008080">uint32_t</span> Fade1<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">// Falloff value 1</span></span>
    <span style="color: #008080">uint32_t</span> Fade2<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">// Falloff value 2 [absent from TR1 data files]</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_room_vertex_structure">2.5. Room Vertex structure</h3>
<div class="paragraph"><p>This defines the vertices within a room. Room lighting is internal vertex lighting, except for necessarily external sources like
flares; room ambient lights and point sources are ignored. Tomb Raider 1 has only the first of the two light values and lacks the rendering attributes.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_vertex_room</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 12 bytes [TR1: 8 bytes]</span></span>
    <span style="color: #008080">tr2_vertex</span> Vertex<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// where this vertex lies (relative to tr2_room_info::x/z)</span></span>
    <span style="color: #008080">int16_t</span> Lighting1<span style="color: #990000">;</span>
    <span style="color: #008080">uint16_t</span> Attributes<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// A set of flags for special rendering effects [absent from TR1 data files]</span></span>
                          <span style="font-style: italic"><span style="color: #9A1900">// 0x8000 something to do with water surface</span></span>
                          <span style="font-style: italic"><span style="color: #9A1900">// 0x4000 under water lighting modulation and</span></span>
                          <span style="font-style: italic"><span style="color: #9A1900">// movement if viewed from above water surface</span></span>
                          <span style="font-style: italic"><span style="color: #9A1900">// 0x2000 water/quicksand surface movement</span></span>
                          <span style="font-style: italic"><span style="color: #9A1900">// 0x0010 ``normal''</span></span>
    <span style="color: #008080">int16_t</span> Lighting2<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// Almost always equal to Lighting1 [absent from TR1 data files]</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_room_sprite_structure">2.6. Room Sprite structure</h3>
<div class="paragraph"><p>This indicates a point in space (<span class="monospaced">Room.Vertices[room_sprite.Vertex]</span>) and a sprite to display there (<span class="monospaced">.Texture</span> is an index into the
sprite texture list).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room_sprite</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 4 bytes</span></span>
    <span style="color: #008080">int16_t</span> Vertex<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">// offset into vertex list</span></span>
    <span style="color: #008080">int16_t</span> Texture<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// offset into sprite texture list</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_room_data_structure">2.7. Room Data structure</h3>
<div class="paragraph"><p>This is the geometry of the &#8220;room,&#8221; including walls, floors, rocks, water, etc. It does <em>not</em> include objects that Lara can interact
with (keyboxes, moveable blocks, moveable doors, etc.) The surfaces specified here are rendered surfaces.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">
<div class="paragraph"><p>This is not a &#8220;real&#8221; C/C++ structure, in that the arrays are sized by the <span class="monospaced">NumXXX</span> elements that precede them.</p></div>
</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room_data</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// (variable length)</span></span>
    <span style="color: #008080">int16_t</span> NumVertices<span style="color: #990000">;</span>                       <span style="font-style: italic"><span style="color: #9A1900">// number of vertices in the following list</span></span>
    <span style="color: #008080">tr2_vertex_room</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span>   <span style="font-style: italic"><span style="color: #9A1900">// list of vertices (relative coordinates)</span></span>
    <span style="color: #008080">int16_t</span> NumRectangles<span style="color: #990000">;</span>                     <span style="font-style: italic"><span style="color: #9A1900">// number of textured rectangles</span></span>
    <span style="color: #008080">tr2_face4</span> Rectangles<span style="color: #990000">[</span>NumRectangles<span style="color: #990000">];</span>     <span style="font-style: italic"><span style="color: #9A1900">// list of textured rectangles</span></span>
    <span style="color: #008080">int16_t</span> NumTriangles<span style="color: #990000">;</span>                      <span style="font-style: italic"><span style="color: #9A1900">// number of textured triangles</span></span>
    <span style="color: #008080">tr2_face3</span> Triangles<span style="color: #990000">[</span>NumTriangles<span style="color: #990000">];</span>       <span style="font-style: italic"><span style="color: #9A1900">// list of textured triangles</span></span>
    <span style="color: #008080">int16_t</span> NumSprites<span style="color: #990000">;</span>                        <span style="font-style: italic"><span style="color: #9A1900">// number of sprites</span></span>
    <span style="color: #008080">tr2_room_sprite</span> Sprites<span style="color: #990000">[</span>NumSprites<span style="color: #990000">];</span>     <span style="font-style: italic"><span style="color: #9A1900">// list of sprites</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_room_static_mesh_structure">2.8. Room Static Mesh structure</h3>
<div class="paragraph"><p>Positions and IDs of static meshes (e.g. skeletons, spiderwebs, furniture, trees). This is comparable to the
<a href="#tr2_item">[tr2_item]</a> structure, except that static meshes typically have no animations and are confined to a single room.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room_staticmesh</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 20 bytes [TR1: 18 bytes]  +</span></span>
    <span style="color: #008080">uint32_t</span> x<span style="color: #990000">,</span> y<span style="color: #990000">,</span> z<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// absolute position in world coordinates</span></span>
    <span style="color: #008080">uint16_t</span> Rotation<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// high two bits (0xC000) indicate steps of</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// 90 degrees (e.g. (Rotation &gt;&gt; 14) * 90)</span></span>
    <span style="color: #008080">uint16_t</span> Intensity1<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Constant lighting; -1 means use mesh lighting</span></span>
    <span style="color: #008080">uint16_t</span> Intensity2<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Like Intensity 1, and almost always the same value [absent from TR1 data files]</span></span>
    <span style="color: #008080">uint16_t</span> ObjectID<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// which StaticMesh item to draw</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_room_structure">2.9. Room structure</h3>
<div class="paragraph"><p>Here&#8217;s where all the room data come together.  As it&#8217;s stored in the file, the <a href="#tr2_room_info"><span class="monospaced">tr2_room_info</span></a> structure comes
first, followed by a <span class="monospaced">uint32_t</span> NumDataWords, which specifies the number of 16-bit words to follow.  Those data words must be parsed in order to
interpret and construct the variable-length arrays of vertices, meshes, doors, and sectors.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">
<div class="paragraph"><p>This is not a &#8220;real&#8221; C/C++ structure, in that the arrays are sized by the <span class="monospaced">NumXXX</span> elements that precede them.</p></div>
</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_room</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// (variable length)  +</span></span>
    <span style="color: #008080">tr2_room_info</span> info<span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">// where the room exists, in world coordinates</span></span>
    <span style="color: #008080">uint32_t</span> NumDataWords<span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">// number of data words (uint16_t's)</span></span>
    <span style="color: #008080">uint16_t</span> Data<span style="color: #990000">[</span>NumDataWords<span style="color: #990000">];</span>        <span style="font-style: italic"><span style="color: #9A1900">// the raw data from which the rest of</span></span>
                                      <span style="font-style: italic"><span style="color: #9A1900">// this is derived</span></span>
    <span style="color: #008080">tr2_room_data</span> RoomData<span style="color: #990000">;</span>           <span style="font-style: italic"><span style="color: #9A1900">// the room mesh</span></span>
    <span style="color: #008080">uint16_t</span> NumPortals<span style="color: #990000">;</span>                   <span style="font-style: italic"><span style="color: #9A1900">// number of visibility portals to other rooms</span></span>
    <span style="color: #008080">tr2_room_portal</span> Portals<span style="color: #990000">[</span>NumPortals<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of visibility portals</span></span>
    <span style="color: #008080">uint16_t</span> NumZsectors<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// ``width'' of sector list</span></span>
    <span style="color: #008080">uint16_t</span> NumXsectors<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// ``height'' of sector list</span></span>
    <span style="color: #008080">tr2_room_sector</span> SectorList<span style="color: #990000">[</span>NumXsectors <span style="color: #990000">*</span> NumZsectors<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of sectors</span></span>
                                                           <span style="font-style: italic"><span style="color: #9A1900">// in this room</span></span>
    <span style="color: #008080">int16_t</span> AmbientIntensity1<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// This and the next one only affect externally-lit objects</span></span>
    <span style="color: #008080">int16_t</span> AmbientIntensity2<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// Almost always the same value as AmbientIntensity1 [absent from TR1 data files]</span></span>
    <span style="color: #008080">int16_t</span> LightMode<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">// (present only in TR2: 0 is normal, 1 is</span></span>
                              <span style="font-style: italic"><span style="color: #9A1900">// flickering(?), 2 and 3 are uncertain)</span></span>
    <span style="color: #008080">uint16_t</span> NumLights<span style="color: #990000">;</span>                 <span style="font-style: italic"><span style="color: #9A1900">// number of point lights in this room</span></span>
    <span style="color: #008080">tr2_room_light</span> Lights<span style="color: #990000">[</span>NumLights<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of point lights</span></span>
    <span style="color: #008080">uint16_t</span> NumStaticMeshes<span style="color: #990000">;</span>                            <span style="font-style: italic"><span style="color: #9A1900">// number of static meshes</span></span>
    <span style="color: #008080">tr2_room_staticmesh</span> StaticMeshes<span style="color: #990000">[</span>NumStaticMeshes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of static meshes</span></span>
    <span style="color: #008080">int16_t</span> AlternateRoom<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// number of the room that this room can alternate</span></span>
                          <span style="font-style: italic"><span style="color: #9A1900">// with (e.g. empty/filled with water is implemented as an empty room that alternates with a full room)</span></span>
    <span style="color: #008080">int16_t</span> Flags<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// flag bits: 0x0001 - room is filled with water,</span></span>
                 <span style="font-style: italic"><span style="color: #9A1900">// 0x0020 - Lara's ponytail gets blown</span></span>
                 <span style="font-style: italic"><span style="color: #9A1900">// by the wind;</span></span>
                 <span style="font-style: italic"><span style="color: #9A1900">// TR1 has only the water flag and the extra</span></span>
                 <span style="font-style: italic"><span style="color: #9A1900">// unknown flag 0x0100.</span></span>
                 <span style="font-style: italic"><span style="color: #9A1900">// TR3 most likely has flags for ``is raining'', ``is snowing'', ``water is cold'', and ``is</span></span>
                 <span style="font-style: italic"><span style="color: #9A1900">// filled by quicksand'', among others.</span></span>
    <span style="color: #008080">tr2_colour</span> RoomLightColour<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Present in TR3 only; absent from TR1/TR2.</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
</div>
<h1 id="_span_class_monospaced_floordata_span"><span class="monospaced">FloorData</span></h1>
<div class="paragraph"><p>The <span class="monospaced">FloorData</span> defines special sector attributes such as floor and ceiling slopes, collisional portals to other rooms, climbability of walls, and all the
various types of triggering. It is referenced by the sectors as an array of 16-bit unsigned integers, e.g. the current sector is calculated as <span class="monospaced">(((CurrentX -
tr2_room_info.x) / 1024) * tr2_room.NumZsectors) + ((CurrentZ - tr2_room_info.z) / 1024)</span>, which is then used as an offset into <span class="monospaced">tr2_room::SectorList[]</span>;
<span class="monospaced">tr2_room_sector::FDindex</span> is an offset into the <span class="monospaced">FloorData[]</span> array.</p></div>
<div class="paragraph"><p>The FloorData consists of opcodes and operands.  Opcodes are 16 bits, as follows:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:20%;
">
<col style="width:33%;">
<col style="width:66%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">Function</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bits 0..7 (<span class="monospaced">0x00FF</span>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">SubFunction</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bits 8..14 (<span class="monospaced">0x7F00</span>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">EndData</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bit 15 (<span class="monospaced">0x8000</span>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If <span class="monospaced">EndData</span> is set, there are no more opcodes (after the current one) in this section of <span class="monospaced">FloorData</span>;  otherwise, the next opcode in <span class="monospaced">FloorData</span> should be
interpreted after the current one.</p></div>
<div class="paragraph"><p>Some functions reference an <span class="monospaced">FDlist</span>, which is a separate list of opcodes and operands that immediately follows the current <span class="monospaced">FloorData</span> opcode.  <span class="monospaced">FDlist</span> opcodes
and operands are different from the base <span class="monospaced">FloorData</span> opcodes and operands:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:40%;
">
<col style="width:16%;">
<col style="width:83%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">FDfunction</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bits 10-13 (<span class="monospaced">0x3C00</span>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">Operands</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bits 0-9 (<span class="monospaced">0x03FF</span>) vary, depending on <span class="monospaced">FDfunction</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"><span class="monospaced">FDcontinue</span></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">bit 15 (<span class="monospaced">0x8000</span>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Several of the functions indicate adjustments to the sector&#8217;s floor and ceiling heights; these are specified by adjusting the corner heights. The corners will
be denoted as <span class="monospaced">00</span>, <span class="monospaced">01</span>, <span class="monospaced">10</span>, and <span class="monospaced">11</span>; the first is the corner&#8217;s X coordinate and the second is the corner&#8217;s Z coordinate, with both given as multiples of 1024.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p><span class="green">When parsing functions for TR3, use only the lower 5 bits to find the function value, because some of TR3&#8217;s functions use the upper 3 bits of the lower byte as
part of the operand. However, this will also work correctly in TR1 and TR2.</span></p></div>
</td>
</tr></table>
</div>
<div class="sect1">
<h2 id="_span_class_monospaced_floordata_span_functions">1. <span class="monospaced">FloorData</span> Functions</h2>
<div class="sectionbody">
<div class="ulist"><div class="title">Function <span class="monospaced">0x01</span>&#8201;&#8212;&#8201;Portal Sector</div><ul>
<li>
<p>
SubFunction <span class="monospaced">0x00</span>&#8201;&#8212;&#8201;Room Portal<br>
  The next <span class="monospaced">FloorData</span> element (the operand) is the number of the room that this sector is a collisional portal to.
  An entity that arrives in a sector with this function present will gets its room membership changed to this function&#8217;s operand, without any change in
  position.
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Function <span class="monospaced">0x02</span>&#8201;&#8212;&#8201;Floor Slant</div><ul>
<li>
<p>
SubFunction <span class="monospaced">0x00</span>&#8201;&#8212;&#8201;Floor Slant<br>
  The next FloorData element contains the slant values for the floor of this sector.  Slant values are specified in
  increments of 256 units. The high byte (<span class="monospaced">int8_t</span>) is the Z slope, while the low byte (<span class="monospaced">int8_t</span>) is the X slope. If the X slope is greater than zero, then its value is
  added to the floor heights of corners <span class="monospaced">00</span> and <span class="monospaced">01</span>. If it is less than zero, then its value is subtracted from the floor heights of corners <span class="monospaced">10</span> and <span class="monospaced">11</span>. If the Z
  slope is greater than zero, then its value is added to the floor heights of corners <span class="monospaced">00</span> and <span class="monospaced">10</span>. If it is less than zero, then its value is subtracted from the
  floor heights of corners <span class="monospaced">01</span> and <span class="monospaced">11</span>.
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Function <span class="monospaced">0x03</span>&#8201;&#8212;&#8201;Ceiling Slant</div><ul>
<li>
<p>
SubFunction <span class="monospaced">0x00</span>&#8201;&#8212;&#8201;Ceiling Slant<br>
  The next <span class="monospaced">FloorData</span> element contains the slant values for the ceiling of this sector.  Slant values are specified in
  increments of 256 units. The high byte (<span class="monospaced">int8_t</span>) is the Z slope, while the low byte (<span class="monospaced">int8_t</span>) is the X slope. If the X slope is greater than zero, then its value is
  subtracted from the ceiling heights of corners <span class="monospaced">10</span> and <span class="monospaced">11</span>. If it is less than zero, then its value is added to the ceiling heights of corners <span class="monospaced">00</span> and <span class="monospaced">01</span>. If the Z
  slope is greater than zero, then its value is subtracted from the ceiling heights of corners <span class="monospaced">00</span> and <span class="monospaced">10</span>. If it is less than zero, then its value is added to the
  ceiling heights of corners <span class="monospaced">01</span> and <span class="monospaced">11</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">Function <span class="monospaced">0x04</span>&#8201;&#8212;&#8201;Trigger items, switch cameras, end the level and much more.<br></div><p>As used below, &#8220;run FDlist(activate or deactivate)&#8221; means go through each element in <span class="monospaced">FDlist</span> and perform its function (&#8220;run FDlist+1&#8221; just means start at
<span class="monospaced">FDlist[1]</span> rather than <span class="monospaced">FDlist[0]</span>).  Activate/deactivate is only used for the activate/deactivate item function.
There are two states for each item, active/inactive (the meaning depends on the item, e.g. a tiger must be active to be seen, if a door is active it is open, if
it is inactive it is closed, etc.) and on/off (keyholes and switches).
The <span class="monospaced">uint16_t</span> immediately following the <span class="monospaced">0x04 FloorData</span> opcode contains flags; the bits at <span class="monospaced">0x3e00</span> are the Activation Mask (which is XORed with any appropriate
item flags), the bit at <span class="monospaced">0x0100</span> indicates &#8220;state change occurs only once&#8221;. A good example of activation-mask use is the multiple-switch room of &#8220;Palace
Midas&#8221; in TR1.</p></div>
<div class="ulist"><ul>
<li>
<p>
SubFunction <span class="monospaced">0x00</span>&#8201;&#8212;&#8201;Run FDlist(activate)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x01</span>&#8201;&#8212;&#8201;If Lara is on the ground, run FDlist(activate)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x02</span>&#8201;&#8212;&#8201;If item at FDlist[0] is on, run FDlist+1(activate), else run FDlist+1(deactivate)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x03</span>&#8201;&#8212;&#8201;If item at FDlist[0] is on, run FDlist+1(activate)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x04</span>&#8201;&#8212;&#8201;If item at FDlist[0] is picked up, run FDlist+1(activate)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x05</span>&#8201;&#8212;&#8201;If item at FDlist[0] is in this sector, run FDlist+1(activate), else run FDlist+1(deactivate)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x06</span>&#8201;&#8212;&#8201;If Lara is on the ground, run FDlist(deactivate)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x07</span>&#8201;&#8212;&#8201;<em>unknown</em>
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x08</span>&#8201;&#8212;&#8201;If Lara is not on the ground, run FDlist(activate) (mainly used for activating collision detection with such objects as footbridges)
</p>
</li>
<li>
<p>
SubFunction <span class="monospaced">0x09</span>&#8201;&#8212;&#8201;Run FDlist(deactivate)
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">Function <span class="monospaced">0x05</span>&#8201;&#8212;&#8201;Kills Lara</div><p>Any SubFunction: If Lara is on the ground, it kills Lara with fire.</p></div>
<div class="paragraph"><div class="title">Function <span class="monospaced">0x06</span>&#8201;&#8212;&#8201;Climbable Walls</div><p>This subfunction indicates climbability of walls; its value is the bitwise OR of the values associated with all the climbable-wall directions (<span class="monospaced">0x01</span> ::=
+Z, <span class="monospaced">0x02</span> ::= +X, <span class="monospaced">0x04</span> ::= -Z, <span class="monospaced">0x08</span> ::= -X), e.g. SubFunction <span class="monospaced">0x09</span> indicates that the walls on both the +Z and -X sides of this sector are climbable.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content"><span class="green">The following functions are only relevant for TR3, this <strong>all these functions are virtually colored green</strong>.</span></td>
</tr></table>
</div>
<div class="paragraph"><div class="title">Functions <span class="monospaced">0x07</span> to <span class="monospaced">0x12</span> (only in TR3)</div><p>These specify the floor and ceiling slopes, which are more complicated here, since these functions specify dividing
up the floors and ceilings into triangles along either of the two diagonals. Also, one of the triangles may be a collisional portal to the room above (if in the
ceiling) or to the room below (if in the floor). The function word must be parsed as follows:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:40%;
">
<col style="width:33%;">
<col style="width:66%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bit 15</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Continuation bit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bits 10-14</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">value <span class="monospaced">t01</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bits 5-9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">value <span class="monospaced">t00</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bits 0-4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">function value</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>where t00 and t01 are signed.</p></div>
<div class="paragraph"><p>It is followed by one operand, to be parsed as follows:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:30%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bits 12-15</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">value <span class="monospaced">t13</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bits 8-11</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">value <span class="monospaced">t12</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bits 4-7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">value <span class="monospaced">t11</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bits 0-3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">value <span class="monospaced">t10</span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>where <span class="monospaced">t10</span>, <span class="monospaced">t11</span>, <span class="monospaced">t12</span>, and <span class="monospaced">t13</span> are unsigned.</p></div>
<div class="paragraph"><p>Here are the triangulations and vertex adjustments; for some of the functions, one of the triangles is a portal to another room:</p></div>
<div class="ulist"><div class="title">Functions <span class="monospaced">0x07</span>, <span class="monospaced">0x0b</span>, <span class="monospaced">0x0c</span></div><ul>
<li>
<p>
Triangle 1&#8201;&#8212;&#8201;<span class="monospaced">00</span>-<span class="monospaced">01</span>-<span class="monospaced">10</span> (function <span class="monospaced">0x0b</span>: is a portal)
</p>
</li>
<li>
<p>
Triangle 2&#8201;&#8212;&#8201;<span class="monospaced">11</span>-<span class="monospaced">10</span>-<span class="monospaced">01</span> (function <span class="monospaced">0x0c</span>: is a portal)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Overall adjustment: <span class="monospaced">adj = t00 + t01 + t10 + t12</span></p></div>
<div class="paragraph"><p>Add these quantities to these vertex floor heights:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">00</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t11)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">01</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t12)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">10</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t10)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">11</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t13)</span>
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Functions <span class="monospaced">0x08</span>, <span class="monospaced">0x0d</span>, <span class="monospaced">0x0e</span></div><ul>
<li>
<p>
Triangle 1&#8201;&#8212;&#8201;<span class="monospaced">01</span>-<span class="monospaced">11</span>-<span class="monospaced">00</span> (function <span class="monospaced">0x0d</span>: is a portal) <br>
</p>
</li>
<li>
<p>
Triangle 2&#8201;&#8212;&#8201;<span class="monospaced">10</span>-<span class="monospaced">00</span>-<span class="monospaced">11</span> (function <span class="monospaced">0x0e</span>: is a portal)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Overall adjustment: adj = t00 + t01 + t11 + t13</p></div>
<div class="paragraph"><p>Add these quantities to these vertex floor heights:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">00</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t11)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">01</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t12)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">10</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t10)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">11</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t13)</span>
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Functions <span class="monospaced">0x09</span>, <span class="monospaced">0x0f</span>, <span class="monospaced">0x10</span></div><ul>
<li>
<p>
Triangle 1&#8201;&#8212;&#8201;<span class="monospaced">00</span>-<span class="monospaced">10</span>-<span class="monospaced">01</span> (function <span class="monospaced">0x0f</span>: is a portal)
</p>
</li>
<li>
<p>
Triangle 2&#8201;&#8212;&#8201;<span class="monospaced">11</span>-<span class="monospaced">01</span>-<span class="monospaced">10</span> (function <span class="monospaced">0x10</span>: is a portal)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Overall adjustment: <span class="monospaced">adj = t10 + t12</span></p></div>
<div class="paragraph"><p>Subtract these quantities from these vertex ceiling heights:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">00</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t12)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">01</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t11)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">10</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t13)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">11</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t10)</span>
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Functions <span class="monospaced">0x0a</span>, <span class="monospaced">0x10</span>, <span class="monospaced">0x11</span></div><ul>
<li>
<p>
Triangle 1&#8201;&#8212;&#8201;<span class="monospaced">01</span>-<span class="monospaced">00</span>-<span class="monospaced">11</span> (function <span class="monospaced">0x11</span>: is a portal)
</p>
</li>
<li>
<p>
Triangle 2&#8201;&#8212;&#8201;<span class="monospaced">10</span>-<span class="monospaced">11</span>-<span class="monospaced">00</span> (function <span class="monospaced">0x12</span>: is a portal)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Overall adjustment: <span class="monospaced">adj = t11 + t13</span></p></div>
<div class="paragraph"><p>Subtract these quantities from these vertex ceiling heights:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">00</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t12)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">01</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t11)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">10</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t13)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">11</span>&#8201;&#8212;&#8201;<span class="monospaced">(adj - t10)</span>
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">Function <span class="monospaced">0x13</span></div><p>Has subfunction 0x00 and no operand. Unknown, but is possibly monkey-swingability of the ceiling.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_floordata_fdlist_functions">2. FloorData FDlist functions</h2>
<div class="sectionbody">
<div class="ulist"><div class="title">FDfunction <span class="monospaced">0x00</span>&#8201;&#8212;&#8201;Activate or deactivate item</div><ul>
<li>
<p>
Operand (bits 0..9)&#8201;&#8212;&#8201;Item index
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">FDfunction <span class="monospaced">0x01</span>&#8201;&#8212;&#8201;Switch to camera</div><p>(also uses the <span class="monospaced">uint16_t</span> immediately following)</p></div>
<div class="ulist"><ul>
<li>
<p>
Operand (bits 0..6)&#8201;&#8212;&#8201;Index in <span class="monospaced">Cameras[]</span><br>
  The <span class="monospaced">uint16_t</span> immediately following <em>specifies delay and repeatability for switched camera</em>.
</p>
</li>
<li>
<p>
Operand (bits 0..7 (<span class="monospaced">0xff</span>))&#8201;&#8212;&#8201;Camera Delay<br>
  Number of seconds to wait before automatically switching back to the normal camera.
  <span class="monospaced">0x00</span> never switches back to the normal camera.
</p>
</li>
<li>
<p>
Operand (bit 8 (<span class="monospaced">0x100</span>))&#8201;&#8212;&#8201;If set, only switch to camera once; otherwise, switch to camera every time
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">FDfunction <span class="monospaced">0x02</span>&#8201;&#8212;&#8201;Underwater Current</div><ul>
<li>
<p>
Operand (bits 0..9 (<span class="monospaced">0x3ff</span>))&#8201;&#8212;&#8201;direction and intensity of flow
</p>
<div class="ulist"><ul>
<li>
<p>
0, 1, 2&#8201;&#8212;&#8201;-Z direction in decreasing intensity (0 is strongest)
</p>
</li>
<li>
<p>
3, 4, 5&#8201;&#8212;&#8201;-X direction in decreasing intensity
</p>
</li>
<li>
<p>
6, 7, 8&#8201;&#8212;&#8201;+Z direction in decreasing intensity
</p>
</li>
<li>
<p>
9, 10, 11&#8201;&#8212;&#8201;+X direction in decreasing intensity
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="ulist"><div class="title">FDfunction <span class="monospaced">0x03</span>&#8201;&#8212;&#8201;Set AlternateRoom Variable</div><ul>
<li>
<p>
Operand (bit 0 (<span class="monospaced">0x01</span>))&#8201;&#8212;&#8201;AlternateRoom Flag value (0/1)
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">FDfunction <span class="monospaced">0x04</span>&#8201;&#8212;&#8201;Alter Room Flags</div><p>This affects (enhances/negates) roomflags (always paired with <span class="monospaced">0x05</span>)</p></div>
<div class="ulist"><ul>
<li>
<p>
Operand&#8201;&#8212;&#8201;not sure, range 0-5
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">FDfunction <span class="monospaced">0x05</span>&#8201;&#8212;&#8201;Alter Room Flags</div><p>This affects (enhances/negates) roomflags (always paired with <span class="monospaced">0x04</span>)</p></div>
<div class="ulist"><ul>
<li>
<p>
Operand&#8201;&#8212;&#8201;not sure, range 0-5
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">FDfunction <span class="monospaced">0x06</span>&#8201;&#8212;&#8201;Look at Item</div><p>(if a camera change is also desired, this should come first)</p></div>
<div class="ulist"><ul>
<li>
<p>
Operand (bits 0..9 (<span class="monospaced">0x3ff</span>))&#8201;&#8212;&#8201;Item index
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">FDfunction <span class="monospaced">0x08</span>&#8201;&#8212;&#8201;Play CD Track</div><ul>
<li>
<p>
Operand (bits 0..9 (<span class="monospaced">0x3ff</span>))&#8201;&#8212;&#8201;CD track ID (TR1: Internal Sound Index)
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">FDfunction <span class="monospaced">0x09</span>&#8201;&#8212;&#8201;Assault Course Clock Control</div><ul>
<li>
<p>
Operand (bits 0..9 (<span class="monospaced">0x3ff</span>))
</p>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">0x1c</span> ::= clear clock
</p>
</li>
<li>
<p>
<span class="monospaced">0x1d</span> ::= stop clock
</p>
</li>
<li>
<p>
<span class="monospaced">0x1e</span> ::= clock reset and displayed<br>
     This opcode is also associated with switches; other values of its operand appear to indicate switch sounds.
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="ulist"><div class="title">FDfunction <span class="monospaced">0x0a</span>&#8201;&#8212;&#8201;Play &#8220;Found Secret&#8221; Sound</div><ul>
<li>
<p>
Operand (bits 0..9 (<span class="monospaced">0x3ff</span>))  Which secret (0..NumSecrets-1)
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">FDfunction <span class="monospaced">0x0b</span>&#8201;&#8212;&#8201;Unknown</div><p>While <span class="monospaced">FloorData</span> index 0 means the sector does not use floordata, there is still a &#8220;dummy&#8221; entry for index 0.  This dummy entry doesn&#8217;t contain any useful
information.</p></div>
</div>
</div>
<h1 id="_mesh_geometry">Mesh Geometry</h1>
<div class="sect1">
<h2 id="_overview_3">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>Nearly all of the non-geographic visual elements in TR2 (as well as a few parts of the landscape) are specified as <em>meshes</em>.  A <em>mesh</em> is simply a
list of vertices and how they&#8217;re arranged.  The TR2 mesh structure includes a list of vertices as relative coordinates (which allows meshes to easily be placed
anywhere in the world geometry), a list of normals (to indicate which side of each face is visible), and lists of Rectangles and Triangles, both Textured and
Coloured.  The elements of each <a href="#tr2_face4">[tr2_face4]</a> or <a href="#tr2_face3">[tr2_face3]</a> structure (Rectangles and Triangles) contain an offset
into the <span class="monospaced">Vertices[]</span> array for the mesh. Other arrays (<span class="monospaced">Moveables[]</span>, <span class="monospaced">StaticMeshes[]</span>) do not reference the array <span class="monospaced">Meshes[]</span> directly, but instead reference the array
<span class="monospaced">MeshPointers[]</span>, which points to locations inside of <span class="monospaced">Meshes[]</span>, inside of which the meshes are stored in packed fashion.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_meshes">2. Meshes</h2>
<div class="sectionbody">
<div class="paragraph"><p>The sign of the number of normals specifies which sort of lighting to use. If the sign is positive, then external vertex lighting is used, with the
lighting calculated from the room&#8217;s ambient and point-source lighting values. The latter appears to use a simple Lambert law for directionality: intensity is
proportional to $\max(\langle (\mathrm{normal direction}), (\mathrm{direction to source}) \rangle, 0)$. If the sign is negative, then internal vertex lighting is used, using the data included with
the mesh.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">
<div class="paragraph"><p>This is not a &#8220;real&#8221; C/C++ structure, in that the arrays are sized by the <span class="monospaced">NumXXX</span> elements that precede them.</p></div>
</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_mesh</span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">tr2_vertex</span> Centre<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// This is usually close to the mesh's centroid, and appears to be the center of a sphere used for collision testing.</span></span>
    <span style="color: #008080">int32_t</span> CollisionSize<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// This appears to be the radius of that aforementioned collisional sphere.</span></span>
    <span style="color: #008080">int16_t</span> NumVertices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of vertices in this mesh</span></span>
    <span style="color: #008080">tr2_vertex</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of vertices (relative coordinates)</span></span>
    <span style="color: #008080">int16_t</span> NumNormals<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// If positive, number of normals in this mesh.</span></span>
                                    <span style="font-style: italic"><span style="color: #9A1900">// If negative, number of vertex lighting elements (* (-1))</span></span>
    <span style="color: #008080">tr2_vertex</span> Normals<span style="color: #990000">[</span>NumNormals<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of normals (if NumNormals is positive)</span></span>
    <span style="color: #008080">int16_t</span> Lights<span style="color: #990000">[-</span>NumNormals<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of light values (if NumNormals is negative)</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured rectangles in this mesh</span></span>
    <span style="color: #008080">tr2_face4</span> TexturedRectangles<span style="color: #990000">[</span>NumTexturedRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured rectangles</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured triangles in this mesh</span></span>
    <span style="color: #008080">tr2_face3</span> TexturedTriangles<span style="color: #990000">[</span>NumTexturedTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured triangles</span></span>
    <span style="color: #008080">int16_t</span> NumColouredRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured rectangles in this mesh</span></span>
    <span style="color: #008080">tr2_face4</span> ColouredRectangles<span style="color: #990000">[</span>NumColouredRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured rectangles</span></span>
    <span style="color: #008080">int16_t</span> NumColouredTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured triangles in this mesh</span></span>
    <span style="color: #008080">tr2_face3</span> ColouredTriangles<span style="color: #990000">[</span>NumColouredTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured triangles</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_static_meshes">3. Static Meshes</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * StaticMesh structure. This defines meshes that don't move (e.g. skeletons</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * lying on the floor, spiderwebs, trees, statues, etc.)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * StaticMeshes have two bounding boxes; it is not clear why they have more than</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * one. One could be the visibililty box, and one could be the collisional</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * box, for instance; the former being used for visibility testing, and the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * latter for collision testing.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_staticmesh</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 32 bytes</span></span>
    <span style="color: #008080">uint32_t</span> ObjectID<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Object Identifier (matched in Items[])</span></span>
    <span style="color: #008080">uint16_t</span> Mesh<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// mesh (offset into MeshPointers[])</span></span>
    <span style="color: #008080">tr2_vertex</span> BoundingBox<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">][</span><span style="color: #993399">2</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// First index is which one; second index is opposite corners</span></span>
    <span style="color: #008080">uint16_t</span> Flags<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Meaning uncertain; it is usually 2, and is 3 for objects Lara can travel through,</span></span>
                      <span style="font-style: italic"><span style="color: #9A1900">// like TR2's skeletons and underwater vegetation</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_moveables">4. Moveables</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Moveable structure. This defines a list of contiguous meshes that</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * comprise one object.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * This structure also points to the hierarchy and offsets of the meshes</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * (MeshTree), and also to the animations used (Animation); these will be</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * described in detail below. If the Animation index is -1, that means that</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * the entity's animations are all generated by the engine; an example is</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Lara's ponytail. Some movables are really stationary, such as locks and</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * the sky, and some are not rendered, such as ``look at me'' points to aim</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * the camera at.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_moveable</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 18 bytes</span></span>
    <span style="color: #008080">uint32_t</span> ObjectID<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Item Identifier (matched in Items[])</span></span>
    <span style="color: #008080">uint16_t</span> NumMeshes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of meshes in this object</span></span>
    <span style="color: #008080">uint16_t</span> StartingMesh<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// stating mesh (offset into MeshPointers[])</span></span>
    <span style="color: #008080">uint32_t</span> MeshTree<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// offset into MeshTree[]</span></span>
    <span style="color: #008080">uint32_t</span> FrameOffset<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// byte offset into Frames[] (divide by 2 for Frames[i])</span></span>
    <span style="color: #008080">uint16_t</span> Animation<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// offset into Animations[]</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_items">5. Items</h2>
<div class="sectionbody">
<div class="paragraph"><p>Items are instances of objects, which can be sprite sequences or movables. For an object to appear in a level, it must be referenced in the <span class="monospaced">Items[]</span>
array. Multiple instances are possible (e.g. two identical tigers in different rooms are represented using two entries in <span class="monospaced">Items[]</span>, one for each). The object ID
is used to locate the appropriate sprite sequence or movable for the item.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_item</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 24 bytes [TR1: 22 bytes]</span></span>
    <span style="color: #008080">int16_t</span> ObjectID<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Object Identifier (matched in Moveables[], or SpriteSequences[], as appropriate)</span></span>
    <span style="color: #008080">int16_t</span> Room<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// which room contains this item</span></span>
    <span style="color: #008080">int32_t</span> x<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// item position in world coordinates</span></span>
    <span style="color: #008080">int32_t</span> y<span style="color: #990000">;</span>
    <span style="color: #008080">int32_t</span> z<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> Angle<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// ((0xc000 &gt;&gt; 14) * 90) degrees</span></span>
    <span style="color: #008080">int16_t</span> Intensity1<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (constant lighting; -1 means use mesh lighting)</span></span>
    <span style="color: #008080">int16_t</span> Intensity2<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Like Intensity1, and almost always with the same value. [absent from TR1 data files]</span></span>
    <span style="color: #008080">uint16_t</span> Flags<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// 0x0100 indicates ``initially invisible'', 0x3e00 is Activation Mask</span></span>
                            <span style="font-style: italic"><span style="color: #9A1900">// 0x3e00 indicates ``open'' or ``activated'';  these can be XORed with</span></span>
                           <span style="font-style: italic"><span style="color: #9A1900">// related FloorData::FDlist fields (e.g. for switches)</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_sprites">6. Sprites</h2>
<div class="sectionbody">
<div class="paragraph"><p>These are &#8220;billboard&#8221; objects that are always rendered perpendicular to the view direction. These are used for text and explosion effects and similar things;
they are also used for some scenery objects and pickup items, though this use gets less as one goes from TR1 to TR3. The various &#8220;Sides&#8221; below are the
positions of the sprite sides relative to the sprite&#8217;s overall position, measured in TR&#8217;s world-coordinate units.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_sprite_texture</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 16 bytes</span></span>
    <span style="color: #008080">uint16_t</span> Tile<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> x<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> y<span style="color: #990000">;</span>
    <span style="color: #008080">uint16_t</span> Width<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">// actually (Width * 256) + 255</span></span>
    <span style="color: #008080">uint16_t</span> Height<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">// actually (Height * 256) + 255</span></span>
    <span style="color: #008080">int16_t</span> LeftSide<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> TopSide<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> RightSide<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> BottomSide<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_sprite_sequences">7. Sprite Sequences</h2>
<div class="sectionbody">
<div class="paragraph"><p>These are collections of sprites that are referred to as a group. The members of this group can be cycled through (animated sprites such as flames) or selected
in other ways (text). Some sequences have only one member; this is done so as to access all the sprites in the same way.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_sprite_sequence</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 8 bytes</span></span>
    <span style="color: #008080">int32_t</span> ObjectID<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Item identifier (matched in Items[])</span></span>
    <span style="color: #008080">int16_t</span> NegativeLength<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// negative of ``how many sprites are in this sequence''</span></span>
    <span style="color: #008080">int16_t</span> Offset<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// where (in sprite texture list) this sequence starts</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<h1 id="_mesh_construction_and_animation">Mesh Construction and Animation</h1>
<div class="sect1">
<h2 id="_overview_4">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>The animated mesh objects in the Tomb Raider series are sets of meshes that are moved relative to each other, as defined by <span class="monospaced">Moveables[]</span> entries. Each entry
describes which meshes to be used (a contiguous set of them referred to in <span class="monospaced">MeshPointers[]</span>), what hierarchy and relative offsets they have (contents of
<span class="monospaced">MeshTree[]</span> pointed to), and what animations are to be used (contents of <span class="monospaced">Animations[]</span> pointed to).</p></div>
<div class="paragraph"><p>The hierarchy used is a branching one, with the meshes being at the nodes, and with the first mesh being the root node. The <span class="monospaced">MeshTree[]</span> values, called &#8220;Bone2&#8221;
in some documentation, are applied to each of the child meshes in sequence; they are sets of four <span class="monospaced">int32_t</span>'s, the first being a hierarchy
operator, and the remaining three being the coordinates in the parent mesh&#8217;s system. A hierarchy example is that for the Lara meshes:</p></div>
<div class="ulist"><ul>
<li>
<p>
Hips
</p>
<div class="ulist"><ul>
<li>
<p>
Left thigh
</p>
<div class="ulist"><ul>
<li>
<p>
Left shin
</p>
<div class="ulist"><ul>
<li>
<p>
Left foot
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Right thigh
</p>
<div class="ulist"><ul>
<li>
<p>
Right shin
</p>
<div class="ulist"><ul>
<li>
<p>
Right foot
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Torso
</p>
<div class="ulist"><ul>
<li>
<p>
Left inner arm
</p>
<div class="ulist"><ul>
<li>
<p>
Left outer arm
</p>
<div class="ulist"><ul>
<li>
<p>
Left hand
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Right inner arm
</p>
<div class="ulist"><ul>
<li>
<p>
Right outer arm
</p>
<div class="ulist"><ul>
<li>
<p>
Right hand
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Head
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>(Ponytail is a separate object)</p></div>
<div class="paragraph"><p>This is implemented by using a stack of meshes and &#8220;push&#8221; and &#8220;pop&#8221; operations in <span class="monospaced">MeshTree[]</span>. Normally, each mesh&#8217;s parent is the previous mesh in series.
But such meshes can be &#8220;remembered&#8221; by adding them to a stack of meshes with a &#8220;push&#8221; operation. This remembered mesh can then be used as the parent mesh
with a &#8220;pop&#8221; operation. It is not clear what the maximum stack depth is; most TR mesh stacks do not extend beyond 2 or 3 meshes.</p></div>
<div class="paragraph"><p>The animations for each mesh object are selected with some ingenious techniques. Which animations to use are not hardcoded; instead, each entity has some states
it can be in, and these states are used to select which animation. For example, locks have only one state (they just sit there), doors have two states (open and
closed), and Lara has numerous states, such as standing, walking, running, jumping, falling, being hurt, dying, etc. Each animation has a state ID, which can be
used to select it; however, state transitions might seem to require a large number of intermediate states (opening, closing, starting to jump, landing, etc.).
The alternative used in the Tomb Raider engine is for each animation to have bridge animations to other states' animations, which are selected using the ID of
which state to change to. These bridge animations then lead to the animation with the appropriate state. Thus, a closed door will run a looped closed-door
animation as long as its state stays &#8220;closed&#8221;, but when its state becomes &#8220;open&#8221;, it will change to an opening-door bridge animation, which will end in a
looped open-door animation. Likewise, closing a door will make it use a closing-door bridge animation. Some bridge animations are chosen with a finer grain of
selectivity, however, such as using one for left foot forward and one for right foot forward.</p></div>
<div class="paragraph"><p>Thus, each animation references a set of <span class="monospaced">StateChange</span> structures (called simply a &#8220;structure&#8221; in some documentation), each one of which references an
<span class="monospaced">AnimDispatch</span> structure (called a &#8220;range&#8221; in some documentation). Each <span class="monospaced">StateChange</span> structure contains a new state and which <span class="monospaced">AnimDispatch</span> structures to use.
When an entity goes into a new state, the <span class="monospaced">StateChange</span> structures are scanned for that state&#8217;s ID, and if one matches, then that <span class="monospaced">StateChange</span>'s <span class="monospaced">AnimDispatch</span> es are
then scanned for a range of frames that contains the ID of the current frame. If such an <span class="monospaced">AnimDispatch</span> is found, the animation and the frame are changed to those
listed in it.</p></div>
<div class="paragraph"><p>The ultimate unit of animation is, of course, the frame, and each frame consists of a bounding box, the offset of the root mesh, and rotation angles for all the
meshes with respect to their parent meshes. The root mesh is also rotated, but relative to the object&#8217;s overall coordinates. All rotations are performed around
the meshes' origins, and are in order Y, X, Z (yaw, pitch, roll). The reason for the root mesh&#8217;s displacement is because entities traveling on solid surfaces
are likely tracked by having their locations be at ground level, and Lara&#8217;s hips, for example, are well above the ground. Finally, some of the angles are not
specified explicitly, when they are not, they are zero.</p></div>
<div class="paragraph"><p>Frames are referenced in two ways, either by an offset into the <span class="monospaced">Frames[]</span> array that contains them, or by frame index. The values of the latter appear to be
unique to each kind of entity, but not between entities; the first frame for each kind is numbered 0. This is likely a convenience when constructing the
animations, since the list of animation frames for each entity can be constructed separately. However, using these indices is fairly simple. Each Animation
structure has a first-frame index; this index is subtracted from the index of the desired frame in order to find out its index relative to the animation&#8217;s first
frame.</p></div>
<div class="paragraph"><p>There are also some special AnimCommands (called &#8220;Bone1&#8221; in some documentation) for doing various additional things. Some of them are for setting reference
points; these may either be 3D ones, for example for grab locations, or 2D ones, for jumps from surface. Some others define actions per frame, like playing
sounds, emitting bubbles, and so forth.</p></div>
<div class="paragraph"><p>Finally, some entities appear to have very incomplete animations; their complete animations are &#8220;borrowed&#8221; from similar entities. One example of this is the
various goons in TR2&#8217;s Venice levels&#8201;&#8212;&#8201;some of them have a full set of animations, while some others have only the standing animation. The ones with only the
standing animation borrow their other animations from the fully-animated ones.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_data_structures">2. Data Structures</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * MeshTree structure</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * MeshTree[] is actually groups of four uint32_t's. The first one is a</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * ``flags'' word;</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> *    bit 1 (0x0002) indicates ``put the parent mesh on the mesh stack'';</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> *    bit 0 (0x0001) indicates ``take the top mesh off of the mesh stack and use as the parent mesh''</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * when set, otherwise ``use the previous mesh are the parent mesh''.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * When both are present, the bit-0 operation is always done before the bit-1 operation; in effect, read the stack but do not change it.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * The next three uint32_t's are X, Y, Z offsets of the mesh's origin from the parent mesh's origin.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_meshtree</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 4 bytes</span></span>
    <span style="color: #008080">int32_t</span> Coord<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Animation structure.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * This describes each individual animation; these may be looped by specifying</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * the next animation to be itself. In TR2 and TR3, one must be careful when</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * parsing frames using the FrameSize value as the size of each frame, since</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * an animation's frame range may extend into the next animation's frame range,</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * and that may have a different FrameSize value.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_animation</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 32 bytes</span></span>
    <span style="color: #008080">uint32_t</span> FrameOffset<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// byte offset into Frames[] (divide by 2 for Frames[i])</span></span>
    <span style="color: #008080">uint8_t</span> FrameRate<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// Engine ticks per frame</span></span>
    <span style="color: #008080">uint8_t</span> FrameSize<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of int16_t's in Frames[] used by this animation</span></span>
    <span style="color: #008080">uint16_t</span> StateID<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> Unknown2<span style="color: #990000">[</span><span style="color: #993399">8</span><span style="color: #990000">];</span>
    <span style="color: #008080">uint16_t</span> FrameStart<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// first frame in this animation</span></span>
    <span style="color: #008080">uint16_t</span> FrameEnd<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// last frame in this animation (numframes = (End - Start) + 1)</span></span>
    <span style="color: #008080">uint16_t</span> NextAnimation<span style="color: #990000">;</span>
    <span style="color: #008080">uint16_t</span> NextFrame<span style="color: #990000">;</span>
    <span style="color: #008080">uint16_t</span> NumStateChanges<span style="color: #990000">;</span>
    <span style="color: #008080">uint16_t</span> StateChangeOffset<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// offset into StateChanges[]</span></span>
    <span style="color: #008080">uint16_t</span> NumAnimCommands<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// How many of them to use.</span></span>
    <span style="color: #008080">uint16_t</span> AnimCommand<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// offset into AnimCommand[]</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * State Change structure</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Each one contains the state to change to and which animation dispatches</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * to use; there may be more than one, with each separate one covering a different</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * range of frames.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_state_change</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 6 bytes</span></span>
    <span style="color: #008080">uint16_t</span> StateID<span style="color: #990000">;</span>
    <span style="color: #008080">uint16_t</span> NumAnimDispatches<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of ranges (seems to always be 1..5)</span></span>
    <span style="color: #008080">uint16_t</span> AnimDispatch<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Offset into AnimDispatches[]</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Animation Dispatch structure</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * This specifies the next animation and frame to use; these are associated</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * with some range of frames. This makes possible such specificity as one</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * animation for left foot forward and another animation for right foot forward.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_anim_dispatch</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 8 bytes</span></span>
    <span style="color: #008080">int16_t</span> Low<span style="color: #990000">;</span>                        <span style="font-style: italic"><span style="color: #9A1900">// Lowest frame that uses this range</span></span>
    <span style="color: #008080">int16_t</span> High<span style="color: #990000">;</span>                       <span style="font-style: italic"><span style="color: #9A1900">// Highest frame (+1?) that uses this range</span></span>
    <span style="color: #008080">int16_t</span> NextAnimation<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// Animation to dispatch to</span></span>
    <span style="color: #008080">int16_t</span> NextFrame<span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">// Frame offset to dispatch to</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * AnimCommand structure</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * These are various commands associated with each animation; they are</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * called ``Bone1'' in some documentation. They are varying numbers of int16_t's</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * packed into an array; the first of each set is the opcode, which determines</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * how operand int16_t's follow it. Some of them refer to the whole animation</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * (jump and grab points, etc.), while others of them are associated with</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * specific frames (sound, bubbles, etc.).</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_anim_command</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 2 bytes</span></span>
    <span style="color: #008080">int16_t</span> Value<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Here are all the <span class="monospaced">AnimCommand</span> opcodes and their operands.</p></div>
<div class="ulist"><ul>
<li>
<p>
1&#8201;&#8212;&#8201;3 operands. Position reference: (x,y,z); found in grab and block-move animations
</p>
</li>
<li>
<p>
2&#8201;&#8212;&#8201;2 operands. Position reference on surface for jumping: (x,z) for horizontal and (y,z) for vertical surfaces(?)
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;No operands. Not clear; occurs in animations that are &#8220;slaved&#8221; to other animations, such as Lara throwing switches or moving blocks.
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;No operands. Not clear; occurs in some death and settling-down animations, but not all.
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;2 operands. The first one is a frame number, and the second one is the ID of the sound to play at that frame (internal sound index).
</p>
</li>
</ul></div>
<div class="paragraph"><p>In TR2 and TR3, one of the sound indices two highest bits may be set; when they are, their meanings are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">0x4000</span>&#8201;&#8212;&#8201;play this sound when on dry land (example: footsteps)
</p>
</li>
<li>
<p>
<span class="monospaced">0x8000</span>&#8201;&#8212;&#8201;play this sound when in water (example: running through shallow water)
</p>
</li>
<li>
<p>
6&#8201;&#8212;&#8201;2 operands. The first one is a frame number, and the second one is some miscellaneous action.
</p>
<div class="ulist"><ul>
<li>
<p>
0&#8201;&#8212;&#8201;Occurs in flipping-over animations; freeze camera at current position until end of animation?
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;Make bubble
</p>
</li>
<li>
<p>
12&#8201;&#8212;&#8201;Temporarily stop responding to controls?
</p>
</li>
<li>
<p>
etc.
</p>
</li>
</ul></div>
</li>
<li>
<p>
14 and 15&#8201;&#8212;&#8201;Some kind of camera control?
</p>
</li>
<li>
<p>
18&#8201;&#8212;&#8201;? <br>
</p>
</li>
<li>
<p>
19&#8201;&#8212;&#8201;?
</p>
</li>
<li>
<p>
20&#8201;&#8212;&#8201;Lara changing clothes (using a different Lara model)
</p>
</li>
<li>
<p>
21&#8201;&#8212;&#8201;?
</p>
</li>
<li>
<p>
22&#8201;&#8212;&#8201;?
</p>
</li>
<li>
<p>
23&#8201;&#8212;&#8201;Hide object
</p>
</li>
<li>
<p>
24&#8201;&#8212;&#8201;Show object
</p>
</li>
<li>
<p>
26&#8201;&#8212;&#8201;Some kind of camera control?
</p>
</li>
</ul></div>
<div class="paragraph"><p>TR3 has additional ones, such as</p></div>
<div class="ulist"><ul>
<li>
<p>
-32736 = 0x8000 + 32
</p>
</li>
<li>
<p>
32
</p>
</li>
<li>
<p>
16416 = 0x4000 + 32
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Frame structure.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Frames indicate how composite meshes are positioned and rotated. They work</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * in conjunction with Animations[] and MeshTree[]. A given frame has the following</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * format:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * int16_t BB1x, BB1y, BB1z // bounding box (low)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * int16_t BB2x, BB2y, BB2z // bounding box (high)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * int16_t OffsetX, OffsetY, OffsetZ // starting offset for this moveable</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * (TR1 ONLY: int16_t NumValues // number of angle sets to follow; these start with the first mesh, and meshes without angles get zero angles.)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * (TR2/3: NumValues is implicitly NumMeshes (from moveable))</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * What follows next is a list of angle sets. In TR2/3, an angle set can</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * specify either one or three axes of rotation. If either of the high two</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * bits (0xc000) of the first angle uint16_t are set, it's one axis: only one</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * uint16_t, low 10 bits (0x03ff), scale is 0x100 ::= 90 degrees; the high two</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * bits are interpreted as follows: 0x4000 ::= X only, 0x8000 ::= Y only,</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * 0xC000 ::= Z only.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * If neither of the high bits are set, it's a three-axis rotation. The next</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * 10 bits (0x3ff0) are the X rotation, the next 10 (including the following</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * uint16_t) (0x000f, 0xfc00) are the Y rotation, the next 10 (0x03ff) are the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Z rotation, same scale as before (0x100 ::= 90 degrees).</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Rotations are performed in Y, X, Z order.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * TR1 ONLY: All angle sets are two words and interpreted like the two-word</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * sets in TR2/3, EXCEPT that the word order is reversed.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span></tt></pre></div></div>
</div>
</div>
<h1 id="_non_player_character_behaviour">Non-Player Character Behaviour</h1>
<div class="sect1">
<h2 id="_overview_5">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>All the Tomb Raider game physics and entity behavior appears to be hardcoded, with each type ID being associated with some specific sort of behavior (as Lara,
as a boat, as a tiger, as a door, as a boulder, as a lock, etc.). There is no sign of the sorts of schemes used by some other game engines for specifying this
behavior in data files. One scheme is to use generic characters, generic projectiles, and so forth, and to specialize them by reading in appropriate records
from data files. Another scheme is to use interpreted pseudocode; this is used by id&#8217;s Quake. This hardcoding makes it difficult to port the earlier Tomb Raider
scenarios to the engines of the later games, which could be desirable with their improved 3D-card and sound-card support. While textures, models, and animations
can be ported, behavior cannot be.</p></div>
<div class="paragraph"><p>However, there is a hint that TR3 may have some such information. Some of its characters are hostile in some levels, and not in others (the India-level monkeys,
the Antarctica-level flamethrower wielders); there may be some flag in <span class="monospaced">Items[]</span> that determines whether a character is hostile or not. But the hostile and
non-hostile versions of these characters may have separate type IDs.</p></div>
<div class="paragraph"><p>Despite that lack, the Tomb Raider series does have navigation hints for the Non-Player Characters; those entities that move freely across the maps under the
command of the game AI. One of the NPCs is the camera, since only Lara (and the vehicles she rides) is under the direct control of the player; the game AI
makes the camera follow Lara. The camera uses the navigation hints used by the flying NPC&#8217;s; these can be constructed so as to help the camera out of tight
spots.</p></div>
<div class="paragraph"><p>The navigation hints are three data structures: boxes, overlaps, and zones. Most sectors point to some box, the main exceptions being horizontal-portal sectors.
Several neighbring sectors may point to the same box. A box is a horizontal rectangle, with corners and height specified; each box also has a pointer into the
list of overlaps. Each segment in that list is the list of accessible neighboring boxes for some box; the NPCs apparently select from this list to decide where
to go next. This selection is done with the help of the zones. These structures of <span class="red">6 (TR1)</span> or 10 (TR2, TR3) <span class="monospaced">int16_t</span>'s that act as zone IDs;
their overall indexing is the same as the boxes, meaning that each box will have an associated set of zone IDs. An NPC will select one of this set to use, and
will prefer to go into the overlaps-list boxes that have the same zone value as the box it is currently in. For example, one can create guard paths by making
chains of zone-ID-sharing boxes, with their overlaps pointing to the next boxes in those chains.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_data_structures_2">2. Data Structures</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_boxes">2.1. Boxes</h3>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_box</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 8 bytes [TR1: 20 bytes] In TR1, the first four are int32_t's instead of uint8_t's, and are not scaled.</span></span>
    <span style="color: #008080">uint8_t</span> Zmin<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// sectors (* 1024 units)</span></span>
    <span style="color: #008080">uint8_t</span> Zmax<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> Xmin<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> Xmax<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> TrueFloor<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Y value (no scaling)</span></span>
    <span style="color: #008080">int16_t</span> OverlapIndex<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// index into Overlaps[]. The high bit is sometimes set; this</span></span>
                        <span style="font-style: italic"><span style="color: #9A1900">// occurs in front of swinging doors and the like.</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_overlaps">2.2. Overlaps</h3>
<div class="paragraph"><p>This is a set of lists of neighboring boxes for each box, each member being a <span class="monospaced">uint16_t</span>; the highest bit being set marks the end of each list. NPCs apparently use
this list to decide where to go next.</p></div>
</div>
<div class="sect2">
<h3 id="_zones">2.3. Zones</h3>
<div class="paragraph"><p>This is a set of <span class="monospaced">int16_t</span>'s, <span class="red">6 for TR1</span> and 10 for TR2 and TR3. NPCs prefer to travel to a box with the same zone ID as the one they are currently at. Which of
these zone IDs it uses depends on the kind of the NPC and its current state. The first half of the Zones structure is for the &#8220;normal&#8221; room state, and the
second half is for the &#8220;alternate&#8221; room state. TR1, for example, has 2 sets of ground zones and 1 set of fly zones; its zones are</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
ground zone 1 (normal)
</p>
</li>
<li>
<p>
ground zone 2 (normal)
</p>
</li>
<li>
<p>
fly zone (normal)
</p>
</li>
<li>
<p>
ground zone 1 (alternate)
</p>
</li>
<li>
<p>
ground zone 2 (alternate)
</p>
</li>
<li>
<p>
fly zone (alternate)
</p>
</li>
</ol></div>
<div class="paragraph"><p>The ground zones are for NPCs that travel on the ground, while the fly zones are for flying or swimming NPCs. TR2 and TR3 have similar breakdowns, though they
have 4 ground zones.</p></div>
</div>
</div>
</div>
<h1 id="_sound">Sound</h1>
<div class="sect1">
<h2 id="_overview_6">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Tomb Raider series makes abundant use of sound, which appears in a variety of contexts. Sounds can be either continuous or triggered. Continuous ones can be
for the whole level or produced by some sound-source object. The whole-level sound is a CD-track sound, which is played continuously, thus the blowing-wind
sounds in the underground parts of &#8220;The Great Wall&#8221;. Sound-source objects make sound in a range around some specific point. Likewise, triggered ones can be
triggered by a variety of events. The triggering can be hardcoded in the engine (gunshots, switch pulls) or by reaching some animation frame (footsteps, Lara&#8217;s
somewhat unladylike sounds). Switch pulls and/or door sounds may be specified with operand of <span class="monospaced">FDFunction 0x09</span>; operand values lower than those used for
assault-course clock control may specify which sounds to use.</p></div>
<div class="paragraph"><p>Though CD-track sounds are referred to by track index, game-data sounds are referred to by an internal sound index; this is translated into which sound sample
with the help of three layers of indexing, to allow for a suitable degree of abstraction. Internal sound indices for various sounds appear to be consistent
across all the level files in a game; a gunshot or a passport opening in one level file will have the same internal sound index as in all the others. The
highest level of these is the <span class="monospaced">SoundMap[]</span> array, which translates the internal sound index into an index into <span class="monospaced">SoundDetails[]</span>. Each <span class="monospaced">SoundDetails</span> record contains
such details as the sound intensity, how many samples to select from, and an index into <span class="monospaced">SampleIndices[]</span>. This allows for selecting among multiple samples to
produce variety; that index is the index to the <span class="monospaced">SampleIndices[]</span> value of first of these, with the rest of them being having the next indices in series of that
array. Thus, if the number of samples is 4, then the TR engine looks in <span class="monospaced">SampleIndices[]</span> locations <em>Index</em>, <em>Index+1</em>, <em>Index+2</em>, and <em>Index+3</em>. Finally, the
<span class="monospaced">SampleIndices[]</span> array references some arrays of sound samples. In TR1, these samples are embedded in the level files, and <span class="monospaced">SampleIndices[]</span> contains the
displacements of each one in bytes from the beginning of that embedded block. In TR2 and TR3, these samples are concatenated in the file <span class="monospaced">MAIN.SFX</span> with no
additional information; <span class="monospaced">SampleIndices[]</span> contains sequence numbers (0, 1, 2, 3, &#8230;) in <span class="monospaced">MAIN.SFX</span>. Finally, the samples themselves are all in Microsoft WAVE
format.</p></div>
<div class="paragraph"><p>The CD-audio tracks are stored in different fashions in the various versions of the TR series.
<span class="green">In the PC version of TR3, they are all stored in the file
<span class="monospaced">CDAUDIO.WAD</span>, which has the format (source: Sven, <a href="mailto:BachmannS@gmx.net">BachmannS@gmx.net</a>, <a href="http://wotsit.org/cgi-bin/download.cgi?tr3audio">http://wotsit.org/cgi-bin/download.cgi?tr3audio</a>): a series of header records with this
format:</span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 0x108 bytes</span></span>
    <span style="color: #008080">int32_t</span> SampleLength<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// how many bytes</span></span>
    <span style="color: #008080">int32_t</span> SampleOffset<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// offset in file</span></span>
    <span style="color: #008080">int8_t</span> Name<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span>         <span style="font-style: italic"><span style="color: #9A1900">// C string; the length is a guess, because Sven's sizes are inconsistent.</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p><span class="green">followed by embedded samples in the Microsoft WAVE format.</span></p></div>
<div class="paragraph"><p>In the Macintosh versions of TR1 and TR2, the CD audio tracks are separate files in AIFF format, while in the Macintosh version of TR3, these tracks are
separate files in Microsoft WAVE format. The Macintosh version of TR3 contains an additional file, <span class="monospaced">CDAudio.db</span>, which contains the names of all the track files
as 32-byte zero-padded C strings with no extra contents.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_data_structures_3">2. Data Structures</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * SoundSource structure</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * This structure contains the details of continuous-sound sources. Although</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * a SoundSource object has a position, it has no room membership; the sound</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * seems to propagate omnidirectionally for about 10 horizontal-grid sizes</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * without regard for the presence of walls.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_sound_source</span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">int32_t</span> x<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// absolute X position of sound source (world coordinates)</span></span>
    <span style="color: #008080">int32_t</span> y<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// absolute Y position of sound source (world coordinates)</span></span>
    <span style="color: #008080">int32_t</span> z<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// absolute Z position of sound source (world coordinates)</span></span>
    <span style="color: #008080">uint16_t</span> SoundID<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// internal sound index</span></span>
    <span style="color: #008080">uint16_t</span> Flags<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// 0x40, 0x80, or 0xc0</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p><span class="monospaced">SoundMap</span> is for mapping from internal-sound index to <span class="monospaced">SoundDetails</span> index; it is 370 <span class="monospaced">int16_t</span> in TR2 and TR3 and <span class="red">256 <span class="monospaced">int16_t</span> in TR1</span>. A value of <span class="monospaced">-1</span> indicates
&#8220;none&#8221;.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Sound-sample details (SoundDetails)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_sound_details</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 8 bytes</span></span>
    <span style="color: #008080">int16_t</span> Sample<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (index into SampleIndices)</span></span>
    <span style="color: #008080">int16_t</span> Volume<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> Unknown1<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// sound range? (distance at which this sound can be heard?)</span></span>
    <span style="color: #008080">int16_t</span> Unknown2<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Bits 8-15: priority?, Bits 2-7: number of sound</span></span>
                           <span style="font-style: italic"><span style="color: #9A1900">// samples in this group, Bits 0-1: channel number?</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_sampleindices">3. SampleIndices</h2>
<div class="sectionbody">
<div class="paragraph"><p><span class="red">In TR1, this is a list of indices into the embedded sound-samples object, which precedes this object in the level file.</span>
In TR2 and TR3, this is
a list of indices into the file &#8216;MAIN.SFX`; the indices are the index numbers of that file&#8217;s embedded sound samples, rather than the samples&#8217; starting
locations. That file itself is a set of concatenated soundfiles with no catalogue info present. In all the TR series, the sound format used is Microsoft WAVE.</p></div>
</div>
</div>
<h1 id="_miscellany">Miscellany</h1>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">These are various odds and ends that do not fit into the earlier categories.</td>
</tr></table>
</div>
<div class="sect1">
<h2 id="_version">1. Version</h2>
<div class="sectionbody">
<div class="paragraph"><p>Every level file (<span class="monospaced">.PHD</span>, <span class="monospaced">.TUB</span>, <span class="monospaced">.TR2</span>) begins with a <span class="monospaced">uint32_t</span> version number.  This seems to be used by the engine to guarantee
compatibility between various level editor versions and the game engine version.  More generally, it can be used to determine what sort of level is being read.
Here are the known (observed) values for the version header:</p></div>
<div class="ulist"><ul>
<li>
<p>
0x00000020&#8201;&#8212;&#8201;Tomb Raider 1, Gold, Unfinished Business
</p>
</li>
<li>
<p>
0x0000002d&#8201;&#8212;&#8201;Tomb Raider 2
</p>
</li>
<li>
<p>
0xFF080038&#8201;&#8212;&#8201;Tomb Raider 3
</p>
</li>
<li>
<p>
0xFF180038&#8201;&#8212;&#8201;Tomb Raider 3
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_palette">2. Palette</h2>
<div class="sectionbody">
<div class="paragraph"><p>This consists of 256 <a href="#tr2_colour">[tr2_colour]</a> structs, one for each palette entry. However, the individual colour values range from 0 to 63; they
must be multiplied by 4 to get the correct values.</p></div>
<div class="paragraph"><p>This used for all 8-bit colour, such as 8-bit textures.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_object_textures">3. Object Textures</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Object-texture vertex structure. It specifies a vertex location in textile coordinates.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * The Xpixel and Ypixel are the actual coordinates of the vertex's pixel.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * The Xcoordinate and Ycoordinate values depend on where the other vertices</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * are in the object texture. And if the object texture is used to specify</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * a triangle, then the fourth vertex's values will all be zero.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_object_texture_vert</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 4 bytes</span></span>
    <span style="color: #008080">uint8_t</span> Xcoordinate<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// 1 if Xpixel is the low value, 255 if Xpixel is the high value in the object texture</span></span>
    <span style="color: #008080">uint8_t</span> Xpixel<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span> Ycoordinate<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// 1 if Ypixel is the low value, 255 if Ypixel is the high value in the object texture</span></span>
    <span style="color: #008080">uint8_t</span> Ypixel<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Object texture structure.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * These, thee contents of ObjectTextures[], are used for specifying texture</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * mapping for the world geometry and for mesh objects.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_object_texture</span>
<span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// 20 bytes</span></span>
    <span style="color: #008080">uint16_t</span> Attribute<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// 0 means that a texture is all-opaque, and that transparency</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// information is ignored.</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// 1 means that transparency information is used. In 8-bit colour,</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// index 0 is the transparent colour, while in 16-bit colour, the</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// top bit (0x8000) is the alpha channel (1 = opaque, 0 = transparent).</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// 2 (only in TR3) means that the opacity (alpha) is equal to the intensity;</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// the brighter the colour, the more opaque it is. The intensity is probably calculated</span></span>
                       <span style="font-style: italic"><span style="color: #9A1900">// as the maximum of the individual color values.</span></span>
    <span style="color: #008080">uint16_t</span> Tile<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// index into textile list</span></span>
    <span style="color: #008080">tr2_object_texture_vert</span> Vertices<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// the four corners of the texture</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_animated_textures">4. Animated Textures</h2>
<div class="sectionbody">
<div class="paragraph"><p>Animated textures describe sets of object textures that are cycled through to produce texture animations; they are a set of int16_t&#8217;s with the following format
(not a &#8220;real&#8221; C/C++ structure):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>int16_t NumAnimatedTextures
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">int16_t</span> NumTextureIDs<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Actually, this is the number of texture ID's - 1.</span></span>
    <span style="color: #008080">int16_t</span> TextureIDs<span style="color: #990000">[</span>NumTextureIDs <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// offsets into ObjectTextures[], in animation order.</span></span>
<span style="color: #FF0000">}</span> AnimatedTextures<span style="color: #990000">[</span>NumAnimatedTextures<span style="color: #990000">];</span></tt></pre></div></div>
<div class="paragraph"><p>If a texture belongs to an animated-texture group, it will automatically be animated by the engine. The animation framerate is most likely hardcoded.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_cameras">5. Cameras</h2>
<div class="sectionbody">
<div class="paragraph"><p>These are positions to switch the camera to; the camera gets switched to one of these as specified in the floordata, which also specify what to look at, how
long to switch, and whether to do so only once.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_camera</span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">int32_t</span> x<span style="color: #990000">;</span>
    <span style="color: #008080">int32_t</span> y<span style="color: #990000">;</span>
    <span style="color: #008080">int32_t</span> z<span style="color: #990000">;</span>
    <span style="color: #008080">int16_t</span> Room<span style="color: #990000">;</span>
    <span style="color: #008080">uint16_t</span> Unknown1<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// correlates to Boxes[]? Zones[]?</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_cinematic_frames">6. Cinematic Frames</h2>
<div class="sectionbody">
<div class="paragraph"><p>These are camera positionings for cutscenes. All the entity animations are specified separately, and it is not clear where there is any syncing between these
frames and any of the animations.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">tr2_cinematic_frame</span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">int16_t</span> rotY<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// rotation about Y axis, +/- 32767 == +/- 180 degrees</span></span>
    <span style="color: #008080">int16_t</span> rotZ<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// rotation about Z axis, +/- 32767 == +/- 180 degrees</span></span>
    <span style="color: #008080">int16_t</span> rotZ2<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// seems to work a lot like rotZ;  I haven't yet been able to</span></span>
                  <span style="font-style: italic"><span style="color: #9A1900">// differentiate them</span></span>
    <span style="color: #008080">int16_t</span> posZ<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// camera position relative to something (target? Lara? room</span></span>
                  <span style="font-style: italic"><span style="color: #9A1900">// origin?).  pos* are _not_ in world coordinates.</span></span>
    <span style="color: #008080">int16_t</span> posY<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// camera position relative to something (see posZ)</span></span>
    <span style="color: #008080">int16_t</span> posX<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// camera position relative to something (see posZ)</span></span>
    <span style="color: #008080">int16_t</span> unknown<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// changing this can cause a runtime error</span></span>
    <span style="color: #008080">int16_t</span> rotX<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">// rotation about X axis, +/- 32767 == +/- 180 degrees</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_lightmap">7. LightMap</h2>
<div class="sectionbody">
<div class="paragraph"><p>A 32*256 array of <span class="monospaced">uint8_t</span> which is apparently for applying light to 8-bit colour, in some documentation called <span class="monospaced">ColourMap</span>. The current
palette index and lighting value are used to calcuate an index to this table, which is a table of palette indices.</p></div>
<div class="paragraph"><p>The Tomb Raider series' software rendering, like that of most real-time-3D games, uses 8-bit colour for speed and low bulk; however, there is the serious
problem of how to do lighting with 8-bit colour, because doing it directly is computationally expensive. The usual solution is to arrange the palettes' colours
in ramps, which the engine then follows in the appropriate directions. However, the TR series' palettes generally lack such neat ramps.</p></div>
<div class="paragraph"><p>But the TR series has a more general solution, one that does not require palettes to have colour ramps. It uses precalculated lighting tables, the <span class="monospaced">ColourMap</span>
objects. These contain translations of a colour value and a lighting value, listed by palette index. The translation goes as follows:</p></div>
<div class="paragraph"><p><span class="monospaced">n = ColourMap[256 * k + i];</span></p></div>
<div class="paragraph"><p>where <span class="monospaced">i</span> is the original palette index, <span class="monospaced">k</span> is determined from the lighting value, and <span class="monospaced">n</span> is the new palette index. The lighting index <span class="monospaced">k</span> varies from 0 to 31, and
the corresponding lighting value is, <span class="red">for TR1</span>,</p></div>
<div class="paragraph"><p><span class="monospaced">2 - k / 16</span></p></div>
<div class="paragraph"><p>and for TR2 and TR3,</p></div>
<div class="paragraph"><p><span class="monospaced">2 - (k + 1) / 16</span></p></div>
<div class="paragraph"><p>This may be associated with the curious fact of the lighting values in the data files increasing in the &#8220;wrong&#8221; direction in TR1 and TR2, with 0 being full
brightness and greater values being darker.</p></div>
</div>
</div>
<h1 id="_level_file_formats">Level File Formats</h1>
<div class="sect1">
<h2 id="_the_entire_tr2_level_format">1. The Entire TR2 Level Format</h2>
<div class="sectionbody">
<div class="paragraph"><p>What follows is the physical <span class="monospaced">.TR2</span> file layout, byte for byte.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that some arrays are variable-length, with the length being defined by another element of the structure.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">uint32_t</span> Version<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// version (4 bytes)</span></span>
<span style="color: #008080">tr2_colour</span> Palette<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 8-bit palette (768 bytes)</span></span>
<span style="color: #008080">tr2_colour4</span> Palette16<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">//  (1024 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumTextiles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of texture tiles (4 bytes)</span></span>
<span style="color: #008080">tr2_textile8</span> Textile8<span style="color: #990000">[</span>NumTextiles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 8-bit (palettized) textiles (NumTextiles * 65536 bytes)</span></span>
<span style="color: #008080">tr2_textile16</span> Textile16<span style="color: #990000">[</span>NumTextiles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 16-bit (ARGB) textiles (NumTextiles * 131072 bytes)</span></span>
<span style="color: #008080">uint32_t</span> Unused<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// 32-bit unused value (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumRooms<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of rooms (2 bytes)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">tr2_room_info</span> RoomInfo<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// room header (16 bytes)</span></span>
    <span style="color: #008080">uint32_t</span> NumData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of data uint16_t's to follow (=RoomData) (4 bytes)</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
    <span style="color: #FF0000">{</span>
        <span style="color: #008080">uint16_t</span> NumVertices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of vertices to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_vertex_room</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// vertex list (NumVertices * 12 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of rectangles to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_face4</span> Rectangles<span style="color: #990000">[</span>NumRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// rectangle list (NumRectangles * 10 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of triangles to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_face3</span> Triangles<span style="color: #990000">[</span>NumTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// triangle list (NumTriangles * 8 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumSprites<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprites to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_sprite</span> Sprites<span style="color: #990000">[</span>NumSprites<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// room sprite list (NumSprites * 4 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumDoors<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of doors to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_door</span> Doors<span style="color: #990000">[</span>NumDoors<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// door list (NumDoors * 32 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumZsector<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table width (2 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumXsector<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table height (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_sector</span> SectorData<span style="color: #990000">[</span>NumZsector <span style="color: #990000">*</span> NumXsector<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table (NumZsector * NumXsector * 8 bytes)</span></span>
        <span style="color: #008080">int16_t</span> Intensity1<span style="color: #990000">;</span>
        <span style="color: #008080">int16_t</span> Intensity2<span style="color: #990000">;</span>
        <span style="color: #008080">int16_t</span> LightMode<span style="color: #990000">;</span>
        <span style="color: #008080">uint16_t</span> NumLights<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of lights to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_light</span> Lights<span style="color: #990000">[</span>NumLights<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// light list (NumLights * 24 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumStaticMeshes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of static mesh records to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_staticmesh</span> StaticMeshes<span style="color: #990000">[</span>NumStaticMeshes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// static mesh data (NumStaticMeshes * 20 bytes)</span></span>
        <span style="color: #008080">int16_t</span> AlternateRoom<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (2 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> Flags<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (2 bytes)</span></span>
    <span style="color: #FF0000">}</span> RoomData<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span> Rooms<span style="color: #990000">[</span>NumRooms<span style="color: #990000">];</span>
<span style="color: #008080">uint32_t</span> NumFloorData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of floor data uint16_t's to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> FloorData<span style="color: #990000">[</span>NumFloorData<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// floor data (NumFloorData * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMeshData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of uint16_t's of mesh data to follow (=Meshes[]) (4 bytes)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">tr2_vertex</span> Centre<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// relative coordinates of mesh centre (6 bytes)</span></span>
    <span style="color: #008080">uint8_t</span> Unknown1<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// unknown (4 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumVertices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of vertices to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_vertex</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of vertices (NumVertices * 6 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumNormals<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of normals to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_vertex</span> Normals<span style="color: #990000">[</span>NumNormals<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of normals (NumNormals * 6 bytes) (becomes Lights if NumNormals &lt; 0; 2 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured rectangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face4</span> TexturedRectangles<span style="color: #990000">[</span>NumTexturedRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured rectangles (NumTexturedRectangles * 10 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured triangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face3</span> TexturedTriangles<span style="color: #990000">[</span>NumTexturedTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured triangles (NumTexturedTriangles * 8 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumColouredRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured rectangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face4</span> ColouredRectangles<span style="color: #990000">[</span>NumColouredRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured rectangles (NumColouredRectangles * 10 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumColouredTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured triangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face3</span> ColouredTriangles<span style="color: #990000">[</span>NumColouredTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured triangles (NumColouredTriangles * 8 bytes)</span></span>
<span style="color: #FF0000">}</span> Meshes<span style="color: #990000">[</span>NumMeshPointers<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// note that NumMeshPointers comes AFTER Meshes[]</span></span>
<span style="color: #008080">uint32_t</span> NumMeshPointers<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of mesh pointers to follow (4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> MeshPointers<span style="color: #990000">[</span>NumMeshPointers<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// mesh pointer list (NumMeshPointers * 4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimations<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animations to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_animation</span> Animations<span style="color: #990000">[</span>NumAnimations<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation list (NumAnimations * 32 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumStateChanges<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of state changes to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_state_change</span> StateChanges<span style="color: #990000">[</span>NumStateChanges<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// state-change list (NumStructures * 6 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimDispatches<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animation dispatches to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_anim_dispatch</span> AnimDispatches<span style="color: #990000">[</span>NumAnimDispatches<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation-dispatch list list (NumAnimDispatches * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimCommands<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animation commands to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_anim_command</span> AnimCommands<span style="color: #990000">[</span>NumAnimCommands<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation-command list (NumAnimCommands * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMeshTrees<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of MeshTrees to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_meshtree</span> MeshTrees<span style="color: #990000">[</span>NumMeshTrees<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// MeshTree list (NumMeshTrees * 4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumFrames<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of words of frame data to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> Frames<span style="color: #990000">[</span>NumFrames<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// frame data (NumFrames * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMoveables<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of moveables to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_moveable</span> Moveables<span style="color: #990000">[</span>NumMoveables<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// moveable list (NumMoveables * 18 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumStaticMeshes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of StaticMesh data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_staticmesh</span> StaticMeshes<span style="color: #990000">[</span>NumStaticMeshes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// StaticMesh data (NumStaticMesh * 32 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumObjectTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of object textures to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_object_texture</span> ObjectTextures<span style="color: #990000">[</span>NumObjectTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// object texture list (NumObjectTextures * 20 bytes) (after</span></span>
AnimatedTextures <span style="color: #008080">in</span> TR3<span style="color: #990000">)</span>
<span style="color: #008080">uint32_t</span> NumSpriteTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprite textures to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sprite_texture</span> SpriteTextures<span style="color: #990000">[</span>NumSpriteTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sprite texture list (NumSpriteTextures * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSpriteSequences<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprite sequences records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sprite_sequence</span> SpriteSequences<span style="color: #990000">[</span>NumSpriteSequences<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sprite sequence data (NumSpriteSequences * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumCameras<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of camera data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_camera</span> Cameras<span style="color: #990000">[</span>NumCameras<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// camera data (NumCameras * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSoundSources<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sound source data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sound_source</span> SoundSources<span style="color: #990000">[</span>NumSoundSources<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound source data (NumSoundSources * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumBoxes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of box data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_box</span> Boxes<span style="color: #990000">[</span>NumBoxes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// box data (NumBoxes * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumOverlaps<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of overlap records to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> Overlaps<span style="color: #990000">[</span>NumOverlaps<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// overlap data (NumOverlaps * 2 bytes)</span></span>
<span style="color: #008080">int16_t</span> Zones<span style="color: #990000">[</span><span style="color: #993399">10</span><span style="color: #990000">*</span>NumBoxes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// zone data (NumBoxes * 20 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimatedTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animated texture records to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> AnimatedTextures<span style="color: #990000">[</span>NumAnimatedTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animated texture data (NumAnimatedTextures * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumItems<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of items to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_item</span> Items<span style="color: #990000">[</span>NumItems<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// item list (NumItems * 24 bytes)</span></span>
<span style="color: #008080">uint8_t</span> LightMap<span style="color: #990000">[</span><span style="color: #993399">32</span> <span style="color: #990000">*</span> <span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// light map (8192 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumCinematicFrames<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of cinematic frame records to follow (2 bytes)</span></span>
<span style="color: #008080">tr2_cinematic_frame</span> CinematicFrames<span style="color: #990000">[</span>NumCinematicFrames<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// (NumCinematicFrames * 16 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumDemoData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of demo data records to follow (2 bytes)</span></span>
<span style="color: #008080">uint8_t</span> DemoData<span style="color: #990000">[</span>NumDemoData<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// demo data (NumDemoData bytes)</span></span>
<span style="color: #008080">int16_t</span> SoundMap<span style="color: #990000">[</span><span style="color: #993399">370</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound map (740 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSoundDetails<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sound-detail records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sample_info</span> SoundDetails<span style="color: #990000">[</span>NumSoundDetails<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound-detail list (NumSoundDetails * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSampleIndices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sample indices to follow (4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> SampleIndices<span style="color: #990000">[</span>NumSampleIndices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sample indices (NumSampleIndices * 4 bytes)</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_entire_tr1_level_format">2. The Entire TR1 Level Format</h2>
<div class="sectionbody">
<div class="paragraph"><p>What follows is the physical <span class="monospaced">.PHD</span> file layout, byte for byte.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that some arrays are variable-length, with the length being defined by another element of the structure.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">uint32_t</span> Version<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// version (4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumTextiles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of texture tiles (4 bytes)</span></span>
<span style="color: #008080">tr2_textile8</span> Textile8<span style="color: #990000">[</span>NumTextiles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 8-bit (palettized) textiles (NumTextiles * 65536 bytes)</span></span>
<span style="color: #008080">uint32_t</span> Unused<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// 32-bit unused value (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumRooms<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of rooms (2 bytes)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">tr2_room_info</span> RoomInfo<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// room header (16 bytes)</span></span>
    <span style="color: #008080">uint32_t</span> NumData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of data uint16_t's to follow (=RoomData) (4 bytes)</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
    <span style="color: #FF0000">{</span>
        <span style="color: #008080">uint16_t</span> NumVertices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of vertices to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_vertex_room</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// vertex list (NumVertices * 8 bytes [TR1 version])</span></span>
        <span style="color: #008080">uint16_t</span> NumRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of rectangles to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_face4</span> Rectangles<span style="color: #990000">[</span>NumRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// rectangle list (NumRectangles * 10 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of triangles to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_face3</span> Triangles<span style="color: #990000">[</span>NumTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// triangle list (NumTriangles * 8 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumSprites<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprites to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_sprite</span> Sprites<span style="color: #990000">[</span>NumSprites<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// room sprite list (NumSprites * 4 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumDoors<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of doors to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_door</span> Doors<span style="color: #990000">[</span>NumDoors<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// door list (NumDoors * 32 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumZsector<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table width (2 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumXsector<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table height (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_sector</span> SectorData<span style="color: #990000">[</span>NumZsector <span style="color: #990000">*</span> NumXsector<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table (NumZsector * NumXsector * 8 bytes)</span></span>
        <span style="color: #008080">int16_t</span> Intensity1<span style="color: #990000">;</span>
        <span style="color: #008080">uint16_t</span> NumLights<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of lights to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_light</span> Lights<span style="color: #990000">[</span>NumLights<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// light list (NumLights * 18 bytes [TR1 version])</span></span>
        <span style="color: #008080">uint16_t</span> NumStaticMeshes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of static mesh records to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_staticmesh</span> StaticMeshes<span style="color: #990000">[</span>NumStaticMeshes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// static mesh data (NumStaticMeshes * 18 bytes [TR1 version])</span></span>
        <span style="color: #008080">int16_t</span> AlternateRoom<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (2 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> Flags<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (2 bytes)</span></span>
    <span style="color: #FF0000">}</span> RoomData<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span> Rooms<span style="color: #990000">[</span>NumRooms<span style="color: #990000">];</span>
<span style="color: #008080">uint32_t</span> NumFloorData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of floor data uint16_t's to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> FloorData<span style="color: #990000">[</span>NumFloorData<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// floor data (NumFloorData * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMeshData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of uint16_t's of mesh data to follow (=Meshes[]) (4 bytes)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">tr2_vertex</span> Centre<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// relative coordinates of mesh centre (6 bytes)</span></span>
    <span style="color: #008080">uint8_t</span> Unknown1<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// unknown (4 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumVertices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of vertices to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_vertex</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of vertices (NumVertices * 6 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumNormals<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of normals to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_vertex</span> Normals<span style="color: #990000">[</span>NumNormals<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of normals (NumNormals * 6 bytes) (becomes Lights if NumNormals &lt; 0; 2 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured rectangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face4</span> TexturedRectangles<span style="color: #990000">[</span>NumTexturedRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured rectangles (NumTexturedRectangles * 10 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured triangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face3</span> TexturedTriangles<span style="color: #990000">[</span>NumTexturedTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured triangles (NumTexturedTriangles * 8 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumColouredRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured rectangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face4</span> ColouredRectangles<span style="color: #990000">[</span>NumColouredRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured rectangles (NumColouredRectangles * 10 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumColouredTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured triangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face3</span> ColouredTriangles<span style="color: #990000">[</span>NumColouredTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured triangles (NumColouredTriangles * 8 bytes)</span></span>
<span style="color: #FF0000">}</span> Meshes<span style="color: #990000">[</span>NumMeshPointers<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// note that NumMeshPointers comes AFTER Meshes[]</span></span>
<span style="color: #008080">uint32_t</span> NumMeshPointers<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of mesh pointers to follow (4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> MeshPointers<span style="color: #990000">[</span>NumMeshPointers<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// mesh pointer list (NumMeshPointers * 4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimations<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animations to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_animation</span> Animations<span style="color: #990000">[</span>NumAnimations<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation list (NumAnimations * 32 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumStateChanges<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of state changes to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_state_change</span> StateChanges<span style="color: #990000">[</span>NumStateChanges<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// state-change list (NumStructures * 6 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimDispatches<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animation dispatches to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_anim_dispatch</span> AnimDispatches<span style="color: #990000">[</span>NumAnimDispatches<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation-dispatch list list (NumAnimDispatches * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimCommands<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animation commands to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_anim_command</span> AnimCommands<span style="color: #990000">[</span>NumAnimCommands<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation-command list (NumAnimCommands * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMeshTrees<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of MeshTrees to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_meshtree</span> MeshTrees<span style="color: #990000">[</span>NumMeshTrees<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// MeshTree list (NumMeshTrees * 4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumFrames<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of words of frame data to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> Frames<span style="color: #990000">[</span>NumFrames<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// frame data (NumFrames * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMoveables<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of moveables to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_moveable</span> Moveables<span style="color: #990000">[</span>NumMoveables<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// moveable list (NumMoveables * 18 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumStaticMeshes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of StaticMesh data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_staticmesh</span> StaticMeshes<span style="color: #990000">[</span>NumStaticMeshes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// StaticMesh data (NumStaticMesh * 32 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumObjectTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of object textures to follow (4 bytes) (after AnimatedTextures in TR3)</span></span>
<span style="color: #008080">tr2_object_texture</span> ObjectTextures<span style="color: #990000">[</span>NumObjectTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// object texture list (NumObjectTextures * 20 bytes) (after AnimatedTextures in TR3)</span></span>
<span style="color: #008080">uint32_t</span> NumSpriteTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprite textures to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sprite_texture</span> SpriteTextures<span style="color: #990000">[</span>NumSpriteTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sprite texture list (NumSpriteTextures * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSpriteSequences<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprite sequences records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sprite_sequence</span> SpriteSequences<span style="color: #990000">[</span>NumSpriteSequences<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sprite sequence data (NumSpriteSequences * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumCameras<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of camera data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_camera</span> Cameras<span style="color: #990000">[</span>NumCameras<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// camera data (NumCameras * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSoundSources<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sound source data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sound_source</span> SoundSources<span style="color: #990000">[</span>NumSoundSources<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound source data (NumSoundSources * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumBoxes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of box data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_box</span> Boxes<span style="color: #990000">[</span>NumBoxes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// box data (NumBoxes * 20 bytes [TR1 version])</span></span>
<span style="color: #008080">uint32_t</span> NumOverlaps<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of overlap records to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> Overlaps<span style="color: #990000">[</span>NumOverlaps<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// overlap data (NumOverlaps * 2 bytes)</span></span>
<span style="color: #008080">int16_t</span> Zones<span style="color: #990000">[</span><span style="color: #993399">6</span><span style="color: #990000">*</span>NumBoxes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// zone data (NumBoxes * 12 bytes [TR1 version])</span></span>
<span style="color: #008080">uint32_t</span> NumAnimatedTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animated texture records to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> AnimatedTextures<span style="color: #990000">[</span>NumAnimatedTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animated texture data (NumAnimatedTextures * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumItems<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of items to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_item</span> Items<span style="color: #990000">[</span>NumItems<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// item list (NumItems * 22 bytes [TR1 version])</span></span>
<span style="color: #008080">uint8_t</span> LightMap<span style="color: #990000">[</span><span style="color: #993399">32</span> <span style="color: #990000">*</span> <span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// light map (8192 bytes)</span></span>
<span style="color: #008080">tr2_colour</span> Palette<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 8-bit palette (768 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumCinematicFrames<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of cinematic frame records to follow (2 bytes)</span></span>
<span style="color: #008080">tr2_cinematic_frame</span> CinematicFrames<span style="color: #990000">[</span>NumCinematicFrames<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// (NumCinematicFrames * 16 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumDemoData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of demo data records to follow (2 bytes)</span></span>
<span style="color: #008080">uint8_t</span> DemoData<span style="color: #990000">[</span>NumDemoData<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// demo data (NumDemoData bytes)</span></span>
<span style="color: #008080">int16_t</span> SoundMap<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound map (512 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSoundDetails<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sound-detail records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sample_info</span> SoundDetails<span style="color: #990000">[</span>NumSoundDetails<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound-detail list (NumSoundDetails * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> <span style="font-weight: bold"><span style="color: #000000">NumSamples</span></span> <span style="color: #990000">(</span>number <span style="color: #008080">of</span> uint8_t<span style="color: #FF0000">'s in Samples)</span>
<span style="color: #FF0000">uint8_t Samples (array of uint8_t'</span>s <span style="color: #990000">--</span> embedded sound samples in Microsoft <span style="color: #008080">WAVE</span> format<span style="color: #990000">)</span>
<span style="color: #008080">uint32_t</span> NumSampleIndices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sample indices to follow (4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> SampleIndices<span style="color: #990000">[</span>NumSampleIndices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sample indices (NumSampleIndices * 4 bytes)</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_entire_tr3_level_format">3. The Entire TR3 Level Format</h2>
<div class="sectionbody">
<div class="paragraph"><p>What follows is the physical Tomb Raider III <span class="monospaced">.TR2</span> file layout, byte for byte.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution">
</td>
<td class="content">This is not a &#8220;real&#8221; C/C++ structure, in that some arrays are variable-length, with the length being defined by another element of the structure.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">uint32_t</span> Version<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// version (4 bytes)</span></span>
<span style="color: #008080">tr2_colour</span> Palette<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 8-bit palette (768 bytes)</span></span>
<span style="color: #008080">tr2_colour4</span> Palette16<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">//  (1024 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumTextiles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of texture tiles (4 bytes)</span></span>
<span style="color: #008080">tr2_textile8</span> Textile8<span style="color: #990000">[</span>NumTextiles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 8-bit (palettized) textiles (NumTextiles * 65536 bytes)</span></span>
<span style="color: #008080">tr2_textile16</span> Textile16<span style="color: #990000">[</span>NumTextiles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// 16-bit (ARGB) textiles (NumTextiles * 131072 bytes) (absent from TR1)</span></span>
<span style="color: #008080">uint32_t</span> Unused<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// 32-bit unused value (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumRooms<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of rooms (2 bytes)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">tr2_room_info</span> RoomInfo<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// room header (16 bytes)</span></span>
    <span style="color: #008080">uint32_t</span> NumData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of data uint16_t's to follow (=RoomData) (4 bytes)</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
    <span style="color: #FF0000">{</span>
        <span style="color: #008080">uint16_t</span> NumVertices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of vertices to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_vertex_room</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// vertex list (NumVertices * 12 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of rectangles to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_face4</span> Rectangles<span style="color: #990000">[</span>NumRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// rectangle list (NumRectangles * 10 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of triangles to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_face3</span> Triangles<span style="color: #990000">[</span>NumTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// triangle list (NumTriangles * 8 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumSprites<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprites to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_sprite</span> Sprites<span style="color: #990000">[</span>NumSprites<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// room sprite list (NumSprites * 4 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumDoors<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of doors to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_door</span> Doors<span style="color: #990000">[</span>NumDoors<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// door list (NumDoors * 32 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumZsector<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table width (2 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumXsector<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table height (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_sector</span> SectorData<span style="color: #990000">[</span>NumZsector <span style="color: #990000">*</span> NumXsector<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sector table (NumZsector * NumXsector * 8 bytes)</span></span>
        <span style="color: #008080">int16_t</span> Intensity1<span style="color: #990000">;</span>
        <span style="color: #008080">int16_t</span> Intensity2<span style="color: #990000">;</span>
        <span style="color: #008080">uint16_t</span> NumLights<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of lights to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_light</span> Lights<span style="color: #990000">[</span>NumLights<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// light list (NumLights * 24 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> NumStaticMeshes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of static mesh records to follow (2 bytes)</span></span>
        <span style="color: #008080">tr2_room_staticmesh</span> StaticMeshes<span style="color: #990000">[</span>NumStaticMeshes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// static mesh data (NumStaticMeshes * 20 bytes)</span></span>
        <span style="color: #008080">int16_t</span> AlternateRoom<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (2 bytes)</span></span>
        <span style="color: #008080">uint16_t</span> Flags<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// (2 bytes)</span></span>
        <span style="color: #008080">tr2_colour</span> RoomLightColour <span style="font-style: italic"><span style="color: #9A1900">// 3 bytes</span></span>
    <span style="color: #FF0000">}</span> RoomData<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span> Rooms<span style="color: #990000">[</span>NumRooms<span style="color: #990000">];</span>
<span style="color: #008080">uint32_t</span> NumFloorData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of floor data uint16_t's to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> FloorData<span style="color: #990000">[</span>NumFloorData<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// floor data (NumFloorData * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMeshData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of uint16_t's of mesh data to follow (=Meshes[]) (4 bytes)</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">tr2_vertex</span> Centre<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// relative coordinates of mesh centre (6 bytes)</span></span>
    <span style="color: #008080">uint8_t</span> Unknown1<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// unknown (4 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumVertices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of vertices to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_vertex</span> Vertices<span style="color: #990000">[</span>NumVertices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of vertices (NumVertices * 6 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumNormals<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of normals to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_vertex</span> Normals<span style="color: #990000">[</span>NumNormals<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of normals (NumNormals * 6 bytes) (becomes Lights if NumNormals &lt; 0; 2 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured rectangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face4</span> TexturedRectangles<span style="color: #990000">[</span>NumTexturedRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured rectangles (NumTexturedRectangles * 10 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumTexturedTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of textured triangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face3</span> TexturedTriangles<span style="color: #990000">[</span>NumTexturedTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of textured triangles (NumTexturedTriangles * 8 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumColouredRectangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured rectangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face4</span> ColouredRectangles<span style="color: #990000">[</span>NumColouredRectangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured rectangles (NumColouredRectangles * 10 bytes)</span></span>
    <span style="color: #008080">int16_t</span> NumColouredTriangles<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of coloured triangles to follow (2 bytes)</span></span>
    <span style="color: #008080">tr2_face3</span> ColouredTriangles<span style="color: #990000">[</span>NumColouredTriangles<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// list of coloured triangles (NumColouredTriangles * 8 bytes)</span></span>
<span style="color: #FF0000">}</span> Meshes<span style="color: #990000">[</span>NumMeshPointers<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// note that NumMeshPointers comes AFTER Meshes[]</span></span>
<span style="color: #008080">uint32_t</span> NumMeshPointers<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of mesh pointers to follow (4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> MeshPointers<span style="color: #990000">[</span>NumMeshPointers<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// mesh pointer list (NumMeshPointers * 4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimations<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animations to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_animation</span> Animations<span style="color: #990000">[</span>NumAnimations<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation list (NumAnimations * 32 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumStateChanges<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of state changes to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_state_change</span> StateChanges<span style="color: #990000">[</span>NumStateChanges<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// state-change list (NumStructures * 6 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimDispatches<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animation dispatches to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_anim_dispatch</span> AnimDispatches<span style="color: #990000">[</span>NumAnimDispatches<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation-dispatch list list (NumAnimDispatches * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimCommands<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animation commands to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_anim_command</span> AnimCommands<span style="color: #990000">[</span>NumAnimCommands<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animation-command list (NumAnimCommands * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMeshTrees<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of MeshTrees to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_meshtree</span> MeshTrees<span style="color: #990000">[</span>NumMeshTrees<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// MeshTree list (NumMeshTrees * 4 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumFrames<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of words of frame data to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> Frames<span style="color: #990000">[</span>NumFrames<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// frame data (NumFrames * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumMoveables<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of moveables to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_moveable</span> Moveables<span style="color: #990000">[</span>NumMoveables<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// moveable list (NumMoveables * 18 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumStaticMeshes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of StaticMesh data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_staticmesh</span> StaticMeshes<span style="color: #990000">[</span>NumStaticMeshes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// StaticMesh data (NumStaticMesh * 32 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSpriteTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprite textures to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sprite_texture</span> SpriteTextures<span style="color: #990000">[</span>NumSpriteTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sprite texture list (NumSpriteTextures * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSpriteSequences<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sprite sequences records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sprite_sequence</span> SpriteSequences<span style="color: #990000">[</span>NumSpriteSequences<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sprite sequence data (NumSpriteSequences * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumCameras<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of camera data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_camera</span> Cameras<span style="color: #990000">[</span>NumCameras<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// camera data (NumCameras * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSoundSources<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sound source data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sound_source</span> SoundSources<span style="color: #990000">[</span>NumSoundSources<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound source data (NumSoundSources * 16 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumBoxes<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of box data records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_box</span> Boxes<span style="color: #990000">[</span>NumBoxes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// box data (NumBoxes * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumOverlaps<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of overlap records to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> Overlaps<span style="color: #990000">[</span>NumOverlaps<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// overlap data (NumOverlaps * 2 bytes)</span></span>
<span style="color: #008080">int16_t</span> Zones<span style="color: #990000">[</span><span style="color: #993399">10</span><span style="color: #990000">*</span>NumBoxes<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// zone data (NumBoxes * 20 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumAnimatedTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of animated texture records to follow (4 bytes)</span></span>
<span style="color: #008080">uint16_t</span> AnimatedTextures<span style="color: #990000">[</span>NumAnimatedTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// animated texture data (NumAnimatedTextures * 2 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumObjectTextures<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of object textures to follow (4 bytes) (after AnimatedTextures in TR3)</span></span>
<span style="color: #008080">tr2_object_texture</span> ObjectTextures<span style="color: #990000">[</span>NumObjectTextures<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// object texture list (NumObjectTextures * 20 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumItems<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of items to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_item</span> Items<span style="color: #990000">[</span>NumItems<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// item list (NumItems * 24 bytes)</span></span>
<span style="color: #008080">uint8_t</span> LightMap<span style="color: #990000">[</span><span style="color: #993399">32</span> <span style="color: #990000">*</span> <span style="color: #993399">256</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// light map (8192 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumCinematicFrames<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of cinematic frame records to follow (2 bytes)</span></span>
<span style="color: #008080">tr2_cinematic_frame</span> CinematicFrames<span style="color: #990000">[</span>NumCinematicFrames<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// (NumCinematicFrames * 16 bytes)</span></span>
<span style="color: #008080">uint16_t</span> NumDemoData<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of demo data records to follow (2 bytes)</span></span>
<span style="color: #008080">uint8_t</span> DemoData<span style="color: #990000">[</span>NumDemoData<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// demo data (NumDemoData bytes)</span></span>
<span style="color: #008080">int16_t</span> SoundMap<span style="color: #990000">[</span><span style="color: #993399">370</span><span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound map (740 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSoundDetails<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sound-detail records to follow (4 bytes)</span></span>
<span style="color: #008080">tr2_sample_info</span> SoundDetails<span style="color: #990000">[</span>NumSoundDetails<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sound-detail list (NumSoundDetails * 8 bytes)</span></span>
<span style="color: #008080">uint32_t</span> NumSampleIndices<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// number of sample indices to follow (4 bytes)  +</span></span>
<span style="color: #008080">uint32_t</span> SampleIndices<span style="color: #990000">[</span>NumSampleIndices<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// sample indices (NumSampleIndices * 4 bytes)</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_itemized_differences_between_tri_and_trii">4. Itemized Differences between TRI and TRII</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
TR1 has no colour table or 16-bit palette before the start of the textures; it also lacks 16-bit textures.
</p>
</li>
<li>
<p>
In TR1, tr2_vertex_room_struct has after its tr2_vertex struct only the first light intensity, and not the attributes or the second intensity.
</p>
</li>
<li>
<p>
In TR1, after SectorData, there is only the first light intensity, and not the second one or the lighting mode.
</p>
</li>
<li>
<p>
In TR1, tr2_room_light_struct has only one of:
</p>
<div class="ulist"><ul>
<li>
<p>
uint16_t Diffuse1/2
</p>
</li>
<li>
<p>
uint32_t Unknown1/2
</p>
</li>
</ul></div>
</li>
<li>
<p>
In TR1, tr2_room_static does not have two light intensities, but only one.
</p>
</li>
<li>
<p>
&#8220;Boxes&#8221; objects are rectangles whose four horizontal-coordinate values are <span class="monospaced">uint8_t</span>'s in TR2 and <span class="monospaced">int32_t</span>'s in TR1.
</p>
</li>
<li>
<p>
&#8220;Zones&#8221; objects have 10 int16_t&#8217;s in TR2, but 6 int16_t&#8217;s in TR1
</p>
</li>
<li>
<p>
In TR1, <span class="monospaced">tr2_item_struct</span> is like the TR2 version, but with only one light intensity.
</p>
</li>
<li>
<p>
The TR1 colour table has the same format as the TR2 colour table, but it is located between the LightMap and the cinematic frames.
</p>
</li>
<li>
<p>
SoundMap is 370 <span class="monospaced">int16_t</span>'s in TR2, but 256 <span class="monospaced">int16_t</span>'s in TR1.
</p>
</li>
<li>
<p>
Between SoundDetails and SampleIndices, TR1 has all the level&#8217;s sound samples, in the form of embedded Microsoft WAVE files. Just before these samples is the
  total number of bytes in those sound samples, which is a int32_t.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_itemized_differences_between_trii_and_triii">5. Itemized Differences between TRII and TRIII</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
After the two room-light intensities, TR2 has a lighting-mode value, which TR3 lacks.
</p>
</li>
<li>
<p>
Also in <span class="monospaced">tr2_room_struct</span>, TR3 has 3 extra bytes at the end, which appears to be the room-light color.
</p>
</li>
<li>
<p>
Finally, in TR2, the <span class="monospaced">tr2_object_texture</span> data is before the <span class="monospaced">tr2_sprite_texture</span> data. In TR3, it is before the <span class="monospaced">tr2_item</span> data.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_itemized_differences_between_8220_normal_8221_trs_and_demos">6. Itemized Differences between &#8220;normal&#8221; TRs and Demos</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Presumably as a form of copy protection, the demo versions of some of the TR games use levels that are slightly different from those in the retail versions.
  However, those that have been found are all data rearrangements, as explained below.
</p>
</li>
<li>
<p>
The TR1 and Unfinished Business (<span class="monospaced">.TUB</span>) demos have their palettes moved to between the SpriteSequences and the Cameras.
</p>
</li>
<li>
<p>
The TR2 &#8220;Wall&#8221; demo, and maybe also its &#8220;Venice&#8221; demo, has its LightMap (8K) moved to between the SpriteSequences and the Cameras. It also has its
  SampleIndices content replaced by the soundfiles, though the associated number of them remains unchanged (the number of indices becomes the number of samples).
</p>
</li>
<li>
<p>
That demo also has its own version of <span class="monospaced">TOMBPC.DAT</span>, called <span class="monospaced">DEMOPC.DAT</span>, which appears to have the exact same format as <span class="monospaced">TOMBPC.DAT</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>No rearrangements are known for the TR3 demos.</p></div>
</div>
</div>
<h1 id="_scripting_with_span_class_monospaced_tombpc_dat_span">Scripting with <span class="monospaced">TOMBPC.DAT</span></h1>
<div class="sect1">
<h2 id="_overview_7">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>The flow of the game, which levels come in what order, what item(s) Lara has at the beginning of each level, the filenames of the level and cut-scene
files, all the visible text (e.g. &#8220;Save Game,&#8221; &#8220;Rusty Key,&#8221; etc.), and various other options are controlled using a file called <span class="monospaced">TOMBPC.DAT</span>. This file is
normally compiled using a utility called <span class="monospaced">GAMEFLOW.EXE</span>, which was (apparently) accidentally distributed by Eidos in the German distribution of Tomb Raider II
Gold. TR2 and TR3 use this file, and use essentially the same format of it, but TR1 has this file&#8217;s contents embedded in the app, which explains why there are
separate TR1 and Unfinished Business apps. What follows is a description of the contents of the binary TOMBPC.DAT file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">uint32_t</span> Version<span style="color: #990000">;</span>                      <span style="font-style: italic"><span style="color: #9A1900">// seems to be 3 for TR2</span></span>
<span style="color: #008080">uint8_t</span> Info<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">];</span>                     <span style="font-style: italic"><span style="color: #9A1900">// null-terminated string describing this game, copyright info, etc.  NOT ENCRYPTED</span></span>
<span style="color: #008080">int32_t</span> FirstOption<span style="color: #990000">;</span>                 <span style="font-style: italic"><span style="color: #9A1900">// Level to go to when that happens (0x500 is exit-to-title) ??? when WHAT happens?</span></span>
<span style="color: #008080">int32_t</span> TitleReplace<span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">//  Level to go to when that happens (-1 is NONE) ??? when WHAT happens?</span></span>
<span style="color: #008080">int32_t</span> OnDeathDemoMode<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// Level to go to when Lara dies during demo mode (0x500 is exit-to-title)</span></span>
<span style="color: #008080">int32_t</span> OnDeathInGame<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">// Level to go to when Lara dies during the game (0 is exit-to-title)</span></span>
<span style="color: #008080">int32_t</span> DemoTime<span style="color: #990000">;</span>                 <span style="font-style: italic"><span style="color: #9A1900">// time in game ticks (1/30th of a second?) to wait before starting a demo</span></span>
<span style="color: #008080">int32_t</span> OnDemoInterrupt<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">// Level to go to when demo mode is interrupted (0x500 is exit-to-title)</span></span>
<span style="color: #008080">int32_t</span> OnDemoEnd<span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">// Level to go to when the demo ends (0x500 is exit-to-title)</span></span>
<span style="color: #008080">uint8_t</span> Unused1<span style="color: #990000">[</span><span style="color: #993399">36</span><span style="color: #990000">];</span>               <span style="font-style: italic"><span style="color: #9A1900">// filler</span></span>
<span style="color: #008080">int16_t</span> NumLevels<span style="color: #990000">;</span>                 <span style="font-style: italic"><span style="color: #9A1900">// number of levels in the game (some level files are used more than once for some reason)</span></span>
<span style="color: #008080">int16_t</span> NumChapterScreens<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// chapter screens (Present in TR2, first used in TR3)</span></span>
<span style="color: #008080">int16_t</span> NumTitles<span style="color: #990000">;</span>                   <span style="font-style: italic"><span style="color: #9A1900">// only one, TITLE.TR2</span></span>
<span style="color: #008080">int16_t</span> NumRPLs<span style="color: #990000">;</span>                  <span style="font-style: italic"><span style="color: #9A1900">// number of FMV cutscenes (*.RPL)</span></span>
<span style="color: #008080">int16_t</span> NumCutScenes<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">// number of in-game (engine-rendered) cutscenes (CUT*.TR2)</span></span>
<span style="color: #008080">int16_t</span> NumDemoLevels<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// Number of demo levels</span></span>
<span style="color: #008080">int16_t</span> TitleSoundID<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">// ID of title soundtrack</span></span>
<span style="color: #008080">int16_t</span> SingleLevel<span style="color: #990000">;</span>                <span style="font-style: italic"><span style="color: #9A1900">// If doing only a single level</span></span>
<span style="color: #008080">uint8_t</span> Unused2<span style="color: #990000">[</span><span style="color: #993399">32</span><span style="color: #990000">];</span>              <span style="font-style: italic"><span style="color: #9A1900">// filler</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// The Flags word below uses the following bit assignments:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0001:    DemoVersion                         (1 ::= demo, 0 ::= normal game)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0002:    Title_Disabled                       (1 ::= no title screen, 0 ::= normal title screen)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0004:    CheatModeCheck_Disabled  (1 ::= no cheat mode, 0 ::= cheat mode enabled)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0008:    NoInputTimeout                     (1 ::= wait forever if no input, 0 ::= enter demo</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// mode if no input timeout)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0010:    LoadSave_Disabled              (1 ::= load/save game disabled, 0 ::= load/save</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// game enabled)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0020:    ScreenSizing_Disabled         (1 ::= no screen re-sizing allowed, 0 ::= screen</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// re-sizing allowed)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0040:    LockOutOptionRing              (1 ::= ???, 0 ::= normal option ring)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0080:    DozyCheat_Enabled             (???)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0100:    Use_Encryption                     (1 ::= XOR all StringData with XORbyte, 0 ::= leave</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// StringData as-is)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//    0x0400:    SelectAnyLevel                      (1 ::= allow player to select any level, 0 ::= no</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// level selection)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="color: #008080">uint16_t</span> Flags<span style="color: #990000">;</span>                         <span style="font-style: italic"><span style="color: #9A1900">// Various flags (see above)</span></span>
<span style="color: #008080">uint8_t</span> Unused3<span style="color: #990000">[</span><span style="color: #993399">6</span><span style="color: #990000">];</span>                 <span style="font-style: italic"><span style="color: #9A1900">// filler</span></span>
<span style="color: #008080">uint8_t</span> XORbyte<span style="color: #990000">;</span>                    <span style="font-style: italic"><span style="color: #9A1900">// For encryption (``cipher code'')</span></span>
<span style="color: #008080">uint8_t</span> Unused4<span style="color: #990000">;</span>                     <span style="font-style: italic"><span style="color: #9A1900">// High byte of a short?</span></span>
<span style="color: #008080">int16_t</span> SecretSoundID<span style="color: #990000">;</span>           <span style="font-style: italic"><span style="color: #9A1900">// ID of ``found a secret'' soundtrack</span></span>
<span style="color: #008080">uint8_t</span> Unused5<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span>                 <span style="font-style: italic"><span style="color: #9A1900">// filler</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// The sections that follow contain String Arrays.  These are of the following pseudo-structure:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// virtual struct</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// {</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//     uint16_t StringOffsets[NumStrings];      // offsets (into StringData[]) of each string</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//     uint16_t StringDataSize;                 // number of bytes of raw string data to follow</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//     uint8_t   StringData[StringDataSize];    // if Flags &amp; 0x0100, this entire array is XORed with</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//                                            // XORbyte</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// } StringArray;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// While it is not correct C/C++, the following are specified as StringArray[NumStrings],</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// where _NumStrings_ indicates the number of StringOffsets in the structure.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="color: #008080">StringArray</span> LevelDisplayNames<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span>
<span style="color: #008080">StringArray</span> ChapterScreens<span style="color: #990000">[</span>NumChapterScreens<span style="color: #990000">];</span>
<span style="color: #008080">StringArray</span> TitleFileNames<span style="color: #990000">[</span>NumTitles<span style="color: #990000">];</span>
<span style="color: #008080">StringArray</span> RPLFileNames<span style="color: #990000">[</span>NumRPLs<span style="color: #990000">];</span>
<span style="color: #008080">StringArray</span> LevelFileNames<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span>
<span style="color: #008080">StringArray</span> CutSceneFileNames<span style="color: #990000">[</span>NumCutScenes<span style="color: #990000">];</span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// The LevelScript contains interpreted data (opcodes and operands) that specify</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// actions to take for each level (e.g. play cut scene, take away weapons, etc).  The</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// details of this data are discussed below, after the structure descriptions.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">virtual</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span>
<span style="color: #FF0000">{</span>
    <span style="color: #008080">uint16_t</span> LevelScriptOffsets<span style="color: #990000">[</span>NumLevels <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">];</span>    <span style="font-style: italic"><span style="color: #9A1900">// offsets (into LevelScriptData[])</span></span>
                                                 <span style="font-style: italic"><span style="color: #9A1900">// of each level's script data</span></span>
    <span style="color: #008080">uint16_t</span> NumLevelScriptData<span style="color: #990000">;</span>
    <span style="color: #008080">uint8_t</span>   LevelScriptData<span style="color: #990000">[</span>NumLevelScriptData<span style="color: #990000">];</span>
<span style="color: #FF0000">}</span> LevelScript<span style="color: #990000">;</span>
<span style="color: #008080">uint16_t</span> DemoLevelList<span style="color: #990000">[</span>NumDemoLevels<span style="color: #990000">];</span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// GameStrings 1 and 2 are the level-independent strings that are displayed when interacting</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// with the game menus (e.g. ``Inventory,'' ``Load Game,'' ``Jump'' (control setup), ``Shotgun''</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// (weapon in inventory), etc.)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="color: #008080">int16_t</span> NumGameStrings1<span style="color: #990000">;</span>
<span style="color: #008080">StringArray</span> GameStrings1<span style="color: #990000">[</span>NumGameStrings1<span style="color: #990000">];</span>
<span style="color: #008080">StringArray</span> GameStrings2<span style="color: #990000">[</span><span style="color: #993399">41</span><span style="color: #990000">];</span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// KeyStrings1..10 are the level-specific printable strings for the various pickups in each level,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// not including level-independent pickups (e.g. Shotgun Shells, Medi Packs).  These pickups</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// are all ``active'' at some point, e.g. they are used as keys or are prerequisites for advancing</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// through the game.  Examples include ``Rusty Key,'' ``Green Pass Card,'' ``Circuit Breaker,'' "The</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Seraph," ``Talion,'' etc. Each level of TR2 can contain up to 10 pickups.  The following arrays</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// are arranged longitudinally, meaning that each array contains all of the Nth-pickup strings for</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// each level.  For example, KeyStrings1 contains the printable names for the ``first'' pickup in</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// each level, KeyStrings2 contains the names for the ``second'' pickup, etc.  Note that ``first''</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// and ``second'' have nothing to do with the order these objects are encountered in the game;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// they are simply indices used by the game engine (Key 1, Key 2, etc.)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="color: #008080">StringArray</span> KeyStrings1<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Puzzle 1</span></span>
<span style="color: #008080">StringArray</span> KeyStrings2<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Puzzle 2</span></span>
<span style="color: #008080">StringArray</span> KeyStrings3<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Puzzle 3</span></span>
<span style="color: #008080">StringArray</span> KeyStrings4<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Puzzle 4</span></span>
<span style="color: #008080">StringArray</span> KeyStrings5<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Pickup 1</span></span>
<span style="color: #008080">StringArray</span> KeyStrings6<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Pickup 2</span></span>
<span style="color: #008080">StringArray</span> KeyStrings7<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Key 1</span></span>
<span style="color: #008080">StringArray</span> KeyStrings8<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Key 2</span></span>
<span style="color: #008080">StringArray</span> KeyStrings9<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Key 3</span></span>
<span style="color: #008080">StringArray</span> KeyStrings10<span style="color: #990000">[</span>NumLevels<span style="color: #990000">];</span> <span style="font-style: italic"><span style="color: #9A1900">// Key 4</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_levelscript_description">2. LevelScript Description</h2>
<div class="sectionbody">
<div class="paragraph"><p>In LevelScript, Opcodes and Operands are all <span class="monospaced">uint16_t</span>.  Note that if a level is a demo level, its level ID will be 1024 higher than a &#8220;normal&#8221;
level ID.</p></div>
<div class="ulist"><div class="title">Opcodes</div><ul>
<li>
<p>
3&#8201;&#8212;&#8201;Play FMV (prerendered cutscene): operand is RPL ID
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;Play (interactive) game level: operand is level&#8217;s ID
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;Play engine-rendered cutscene: operand is cutscene ID
</p>
</li>
<li>
<p>
6&#8201;&#8212;&#8201;Do level-completion display (no operands)
</p>
</li>
<li>
<p>
7&#8201;&#8212;&#8201;Play demo level: operand is level ID
</p>
</li>
<li>
<p>
9&#8201;&#8212;&#8201;End of set (no operands)
</p>
</li>
<li>
<p>
10&#8201;&#8212;&#8201;Play soundtrack: operand is soundtrack ID (it precedes opcodes of associated levels)
</p>
</li>
<li>
<p>
11&#8201;&#8212;&#8201;(Lara starts out in motorboat?&#8201;&#8212;&#8201;TR2, &#8220;Bartoli&#8217;s Hideout&#8221;) (no operands?)
</p>
</li>
<li>
<p>
12&#8201;&#8212;&#8201;Chapter screen: operand is chapter ID
</p>
</li>
<li>
<p>
14&#8201;&#8212;&#8201;Lose your weapons (no operands)
</p>
</li>
<li>
<p>
15&#8201;&#8212;&#8201;End of game (no operands)
</p>
</li>
<li>
<p>
16&#8201;&#8212;&#8201;Associated with cutscenes; a viewpoint control? (one operand?)
</p>
</li>
<li>
<p>
17&#8201;&#8212;&#8201;(one operand?)
</p>
</li>
<li>
<p>
18&#8201;&#8212;&#8201;Give item; operand is item type (see below)
</p>
</li>
<li>
<p>
19&#8201;&#8212;&#8201;Item-type 12 state to start level in: operand is state number
</p>
</li>
<li>
<p>
20&#8201;&#8212;&#8201;Number of secrets (overrides engine&#8217;s hardcoded count of them?): operand is that number
</p>
</li>
<li>
<p>
21&#8201;&#8212;&#8201;(no operands?)
</p>
</li>
<li>
<p>
22&#8201;&#8212;&#8201;Lose your ammo and medipacks? (no operands?)
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_opcode_18_stuff_to_give">2.1. Opcode-18 stuff to give</h3>
<div class="paragraph"><p>(repeat means give another)</p></div>
<div class="ulist"><div class="title">After finding all the secrets in a level (Tomb Raider 2)</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;Pistols
</p>
</li>
<li>
<p>
1&#8201;&#8212;&#8201;Shotgun
</p>
</li>
<li>
<p>
2&#8201;&#8212;&#8201;Automatic pistols
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;Uzis
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;Harpoon gun
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;M-16
</p>
</li>
<li>
<p>
6&#8201;&#8212;&#8201;Grenade launcher
</p>
</li>
<li>
<p>
7&#8201;&#8212;&#8201;Pistol clip
</p>
</li>
<li>
<p>
8&#8201;&#8212;&#8201;Shotgun-shell box
</p>
</li>
<li>
<p>
9&#8201;&#8212;&#8201;Automatic-pistol clip
</p>
</li>
<li>
<p>
10&#8201;&#8212;&#8201;Uzi clip
</p>
</li>
<li>
<p>
11&#8201;&#8212;&#8201;Harpoon bundle
</p>
</li>
<li>
<p>
12&#8201;&#8212;&#8201;M-16 clip
</p>
</li>
<li>
<p>
13&#8201;&#8212;&#8201;Grenade pack
</p>
</li>
<li>
<p>
14&#8201;&#8212;&#8201;Flare box
</p>
</li>
<li>
<p>
15&#8201;&#8212;&#8201;Small medipack
</p>
</li>
<li>
<p>
16&#8201;&#8212;&#8201;Big medipack
</p>
</li>
<li>
<p>
17&#8201;&#8212;&#8201;Pickup 1
</p>
</li>
<li>
<p>
18&#8201;&#8212;&#8201;Pickup 2
</p>
</li>
<li>
<p>
19&#8201;&#8212;&#8201;Puzzle 1
</p>
</li>
<li>
<p>
20&#8201;&#8212;&#8201;Puzzle 2
</p>
</li>
<li>
<p>
21&#8201;&#8212;&#8201;Puzzle 3
</p>
</li>
<li>
<p>
22&#8201;&#8212;&#8201;Puzzle 4
</p>
</li>
<li>
<p>
23&#8201;&#8212;&#8201;Key 1
</p>
</li>
<li>
<p>
24&#8201;&#8212;&#8201;Key 2
</p>
</li>
<li>
<p>
25&#8201;&#8212;&#8201;Key 3
</p>
</li>
<li>
<p>
26&#8201;&#8212;&#8201;Key 4
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">When a level starts (Tomb Raider 2)</div><ul>
<li>
<p>
1000&#8201;&#8212;&#8201;Pistols
</p>
</li>
<li>
<p>
1001&#8201;&#8212;&#8201;Shotgun
</p>
</li>
<li>
<p>
1002&#8201;&#8212;&#8201;Automatic pistols
</p>
</li>
<li>
<p>
1003&#8201;&#8212;&#8201;Uzis
</p>
</li>
<li>
<p>
1004&#8201;&#8212;&#8201;Harpoon gun
</p>
</li>
<li>
<p>
1005&#8201;&#8212;&#8201;M16
</p>
</li>
<li>
<p>
1006&#8201;&#8212;&#8201;Grenade launcher
</p>
</li>
<li>
<p>
1007&#8201;&#8212;&#8201;Pistol clip
</p>
</li>
<li>
<p>
1008&#8201;&#8212;&#8201;Shotgun-shell box
</p>
</li>
<li>
<p>
1009&#8201;&#8212;&#8201;Automatic-pistol clip
</p>
</li>
<li>
<p>
1010&#8201;&#8212;&#8201;Uzi clip
</p>
</li>
<li>
<p>
1011&#8201;&#8212;&#8201;Harpoon bundle
</p>
</li>
<li>
<p>
1012&#8201;&#8212;&#8201;M16 clip
</p>
</li>
<li>
<p>
1013&#8201;&#8212;&#8201;Grenade pack
</p>
</li>
<li>
<p>
1014&#8201;&#8212;&#8201;Flare box
</p>
</li>
<li>
<p>
1015&#8201;&#8212;&#8201;Small medipack
</p>
</li>
<li>
<p>
1016&#8201;&#8212;&#8201;Big medipack
</p>
</li>
<li>
<p>
1017&#8201;&#8212;&#8201;Pickup 1
</p>
</li>
<li>
<p>
1018&#8201;&#8212;&#8201;Pickup 2
</p>
</li>
<li>
<p>
1019&#8201;&#8212;&#8201;Puzzle 1
</p>
</li>
<li>
<p>
1020&#8201;&#8212;&#8201;Puzzle 2
</p>
</li>
<li>
<p>
1021&#8201;&#8212;&#8201;Puzzle 3
</p>
</li>
<li>
<p>
1022&#8201;&#8212;&#8201;Puzzle 4
</p>
</li>
<li>
<p>
1023&#8201;&#8212;&#8201;Key 1
</p>
</li>
<li>
<p>
1024&#8201;&#8212;&#8201;Key 2
</p>
</li>
<li>
<p>
1025&#8201;&#8212;&#8201;Key 3
</p>
</li>
<li>
<p>
1026&#8201;&#8212;&#8201;Key 4
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_tomb_raider_2_identifications">2.2. Tomb Raider 2 identifications</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">
<div class="paragraph"><p><span class="blue">TR2 only information here. These lists are virtually colored blue.</span></p></div>
</td>
</tr></table>
</div>
<div class="ulist"><div class="title">FMV IDs</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;LOGO (everybody&#8217;s corporate logos)
</p>
</li>
<li>
<p>
1&#8201;&#8212;&#8201;ANCIENT (monks vs. dragon)
</p>
</li>
<li>
<p>
2&#8201;&#8212;&#8201;MODERN (Lara drops in from helicopter)
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;LANDING (Seaplane lands at rig)
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;MS (Lara hitchhikes on a minisub)
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;CRASH (Lara goes to Tibet and has a rough landing there)
</p>
</li>
<li>
<p>
6&#8201;&#8212;&#8201;JEEP (Lara steals it and outruns Bartoli&#8217;s goons)
</p>
</li>
<li>
<p>
7&#8201;&#8212;&#8201;END (Lara escaping the collapsing lair)
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Cutscene IDs</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;CUT1 (At the end of the Great Wall)
</p>
</li>
<li>
<p>
1&#8201;&#8212;&#8201;CUT2 (Lara the stowaway)
</p>
</li>
<li>
<p>
2&#8201;&#8212;&#8201;CUT3 (Bartoli vs. goon)
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;CUT4 (Bartoli stabs himself)
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Soundtrack IDs</div><ul>
<li>
<p>
0&#8201;&#8212;&#8201;BLANK (no sound)
</p>
</li>
<li>
<p>
3&#8201;&#8212;&#8201;CUT1 (&#8220;at the fancy door&#8221; soundtrack)
</p>
</li>
<li>
<p>
4&#8201;&#8212;&#8201;CUT2 (&#8220;Lara the stowaway&#8221; soundtrack)
</p>
</li>
<li>
<p>
5&#8201;&#8212;&#8201;CUT3 (&#8220;Bartoli vs. goon&#8221; soundtrack)
</p>
</li>
<li>
<p>
30&#8201;&#8212;&#8201;CUT4 (&#8220;Bartoli stabs himself&#8221; soundtrack)
</p>
</li>
<li>
<p>
31&#8201;&#8212;&#8201;DERELICT (eerie choppy/echo-y synths)
</p>
</li>
<li>
<p>
32&#8201;&#8212;&#8201;WATER (dripping/pouring water sounds)
</p>
</li>
<li>
<p>
33&#8201;&#8212;&#8201;WIND (Blowing wind)
</p>
</li>
<li>
<p>
34&#8201;&#8212;&#8201;HEARTBT (musical embellishment of one)
</p>
</li>
<li>
<p>
52&#8201;&#8212;&#8201;SHOWER (that infamous shower scene)
</p>
</li>
<li>
<p>
58&#8201;&#8212;&#8201;MACHINES (in the offshore rig)
</p>
</li>
<li>
<p>
59&#8201;&#8212;&#8201;FLOATING (wispy synths)
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated 2015-07-16 20:24:34 CEST
</div>
</div>
</body>
</html>
